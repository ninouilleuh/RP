<!DOCTYPE html>
<html lang="fr">
<head>
<script src="/socket.io/socket.io.js"></script>
<meta charset="UTF-8">
<title>BLEACH‚ÄØRP‚ÄØ‚Äì‚ÄØFiches‚ÄØJoueurs</title>
<style>
body{
  font-family:"Segoe UI",Roboto,Arial,sans-serif;
  background:#0b0b0b;
  color:#eee;
  margin:0;
}
header{
  background:#181818;
  padding:10px 15px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  box-shadow:0 2px 5px rgba(0,0,0,0.6);
}
h1{margin:0;font-size:19px;letter-spacing:1px;}
select,button,input,textarea{
  background:#222;
  color:#fff;
  border:none;
  padding:6px 8px;
  border-radius:5px;
  font-size:0.95rem;
}
button{
  cursor:pointer;
  transition:background 0.3s,transform 0.1s;
}
button:hover{background:#333;}
button:active{transform:scale(0.97);}
#container{
  padding:20px;
  display:flex;
  flex-wrap:wrap;
  gap:20px;
  justify-content:center;
}
.card{
  background:#151515;
  border:1px solid #333;
  border-radius:10px;
  padding:15px;
  width:260px;
  transition:transform 0.2s;
}
.card:hover{transform:translateY(-2px);}
.name{font-weight:600;font-size:1.2em;color:#58a6ff;}
.species{font-style:italic;color:#999;margin-bottom:5px;}
.stats ul{padding-left:20px;margin:0;}
.btn{
  margin-top:6px;
  background:#2f2f2f;
  padding:4px 6px;
  border-radius:5px;
  font-size:0.85rem;
}
.btn:hover{background:#3d3d3d;}
.modal{
  position:fixed;
  top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0.8);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:10;
}
.modal-content{
  background:#131313;
  border:1px solid #333;
  border-radius:12px;
  padding:25px 30px;
  width:95%;
  max-width:700px;
  max-height:90%;
  overflow-y:auto;
  box-shadow:0 0 25px rgba(0,0,0,0.8);
}
.close{
  position:absolute;
  right:25px;
  top:10px;
  cursor:pointer;
  color:#f33;
  font-size:22px;
}
.form-title{
  text-align:center;
  font-size:1.5em;
  color:#fff;
  border-bottom:1px solid #333;
  padding-bottom:10px;
  margin:0 0 20px 0;
}
.form-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
  gap:20px;
}
.block{
  display:flex;
  flex-direction:column;
}
.block label{
  font-weight:600;
  font-size:0.9rem;
  margin-bottom:6px;
  color:#ccc;
}
.block input,
.block select,
.block textarea{
  background:#1f1f1f;
  border:1px solid #333;
  border-radius:6px;
  padding:8px;
  color:#eee;
  transition:border 0.3s;
}
.block input:focus,
.block textarea:focus,
.block select:focus{
  outline:none;
  border-color:#58a6ff;
}
.block textarea{min-height:70px;resize:vertical;}
.block select[multiple]{height:110px;}
button.confirm{
  margin-top:25px;
  width:100%;
  background:#0078ff;
  border:none;
  color:#fff;
  padding:10px;
  border-radius:8px;
  font-weight:600;
  font-size:1rem;
  letter-spacing:0.5px;
  cursor:pointer;
  transition:background .3s;
}
button.confirm:hover{background:#0099ff;}
/* Barre lat√©rale gauche */
#sidebar {
  position: fixed;
  top: 60px;
  left: 0;
  width: 90px;
  height: calc(100% - 60px);
  background: #111;
  border-right: 1px solid #222;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding-top: 20px;
}
#sidebar button {
  background: #222;
  color: #fff;
  border: 1px solid #333;
  padding: 10px 5px;
  width: 80%;
  border-radius: 6px;
  font-size: 0.9rem;
  margin-bottom: 10px;
}
#sidebar button:hover { background: #2d2d2d; }

/* Adaptation du conteneur principal pour ne pas √™tre cach√© */
#container { margin-left: 100px; }

#bestiaireList h3 {
  border-left:4px solid #ffcc66;
  padding-left:8px;
  margin-bottom:6px;
  text-transform:uppercase;
  letter-spacing:.5px;
}
#detailContent p{
  margin:8px 0;
  line-height:1.4em;
}
#detailContent ul{
  margin:5px 0 5px 15px;
}
#detailContent details{
  margin-top:10px;
  background:#1a1a1a;
  border:1px solid #333;
  border-radius:6px;
  padding:6px 10px;
}

/* --- TCHAT VISUEL --- */
#chatSection{
  margin:20px auto 40px;
  width:90%;
  max-width:800px;
  background:#151515;
  border:1px solid #333;
  border-radius:10px;
  padding:15px 20px;
  box-shadow:0 0 10px rgba(0,0,0,0.6);
}
#chatWindow{
  background:#101010;
  border:1px solid #333;
  border-radius:6px;
  height:300px;
  overflow-y:auto;
  padding:10px;
}
.msg{
  margin:6px 0;
  padding:6px 10px;
  border-radius:6px;
  max-width:85%;
  line-height:1.3em;
}
.msg.joueur{
  background:#222;
  border-left:3px solid #58a6ff;
  margin-left:auto;
}
.msg.narrateur{
  background:#1a1a1a;
  border-left:3px solid #ffcc66;
  margin-right:auto;
}
#chatControls{
  display:flex;
  gap:5px;
  margin-top:10px;
}
#chatControls input{
  flex:1;
  background:#222;
  border:1px solid #333;
  border-radius:6px;
  padding:8px;
  color:#fff;
}
#chatControls button{
  background:#333;
  border:none;
  color:#fff;
  padding:8px 10px;
  border-radius:6px;
  cursor:pointer;
}
#chatControls button:hover{background:#444;}

/* --- NIVEAU ET STATS --- */
.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 5px;
}

.level-badge {
  background: linear-gradient(135deg, #ffcc66, #ff9900);
  color: #000;
  padding: 3px 10px;
  border-radius: 12px;
  font-weight: bold;
  font-size: 0.85em;
}

.xp-bar {
  background: #222;
  border-radius: 8px;
  height: 18px;
  margin: 8px 0;
  position: relative;
  overflow: hidden;
}

.xp-fill {
  background: linear-gradient(90deg, #58a6ff, #00ccff);
  height: 100%;
  border-radius: 8px;
  transition: width 0.3s ease;
}

.xp-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 0.75em;
  color: #fff;
  text-shadow: 1px 1px 2px #000;
}

.stats-grid {
  margin-top: 10px;
  padding: 10px;
  background: #1a1a1a;
  border-radius: 8px;
  border: 1px solid #333;
}

.stat-item {
  display: flex;
  align-items: center;
  margin: 4px 0;
  gap: 8px;
}

.stat-name {
  width: 70px;
  font-size: 0.8em;
  color: #aaa;
}

.stat-bar {
  flex: 1;
  background: #333;
  height: 8px;
  border-radius: 4px;
  overflow: hidden;
}

.stat-fill {
  height: 100%;
  background: linear-gradient(90deg, #4caf50, #8bc34a);
  border-radius: 4px;
  transition: width 0.3s;
}

.stat-value {
  width: 25px;
  text-align: right;
  font-size: 0.85em;
  color: #58a6ff;
  font-weight: bold;
}

.card-buttons {
  display: flex;
  flex-wrap: wrap;
  gap: 5px;
  margin-top: 10px;
}

.card-buttons .btn {
  flex: 1;
  min-width: 80px;
  text-align: center;
}

/* --- STATS RELATIVES --- */
.stats-header {
  display: flex;
  justify-content: space-between;
  margin-bottom: 8px;
  padding-bottom: 5px;
  border-bottom: 1px solid #333;
}

.stats-header span:first-child {
  font-weight: bold;
  color: #58a6ff;
}

.max-indicator {
  font-size: 0.75em;
  color: #ffd700;
  background: #2a2a00;
  padding: 2px 8px;
  border-radius: 10px;
}

.stat-fill {
  height: 100%;
  border-radius: 4px;
  transition: width 0.5s ease, background 0.3s;
  box-shadow: 0 0 5px rgba(255,255,255,0.2);
}

/* Animation au survol */
.stat-item:hover .stat-fill {
  filter: brightness(1.2);
}

.stat-item:hover .stat-value {
  transform: scale(1.1);
  color: #ffd700;
}

.stat-value {
  transition: transform 0.2s, color 0.2s;
}

/* --- INVENTAIRE --- */
.inv-list {
  background: #1a1a1a;
  border: 1px solid #333;
  border-radius: 8px;
  padding: 10px;
  max-height: 300px;
  overflow-y: auto;
  margin-bottom: 15px;
}

.inv-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 10px;
  background: #222;
  border-radius: 6px;
  margin-bottom: 6px;
  transition: background 0.2s;
}

.inv-item:hover {
  background: #2a2a2a;
}

.inv-item-name {
  flex: 1;
  color: #eee;
}

.inv-item-qty {
  background: #58a6ff;
  color: #000;
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 0.85em;
  font-weight: bold;
  margin: 0 10px;
}

.inv-item-actions button {
  background: #333;
  border: none;
  color: #fff;
  padding: 4px 8px;
  border-radius: 4px;
  cursor: pointer;
  margin-left: 4px;
  font-size: 0.85em;
}

.inv-item-actions button:hover {
  background: #444;
}

.inv-item-actions .delete-btn:hover {
  background: #f44336;
}

.inv-add {
  display: flex;
  gap: 8px;
  margin-bottom: 15px;
}

.inv-add input {
  flex: 1;
  background: #222;
  border: 1px solid #333;
  border-radius: 6px;
  padding: 10px;
  color: #fff;
}

.inv-add input:focus {
  border-color: #58a6ff;
  outline: none;
}

.inv-add button {
  background: #4caf50;
  border: none;
  color: #fff;
  padding: 10px 15px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: bold;
}

.inv-add button:hover {
  background: #66bb6a;
}

.inv-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding-top: 10px;
  border-top: 1px solid #333;
}

#invCount {
  color: #888;
  font-size: 0.9em;
}

.inv-empty {
  text-align: center;
  color: #666;
  padding: 30px;
  font-style: italic;
}

/* Cat√©gories d'objets (couleurs) */
.inv-item.weapon { border-left: 3px solid #f44336; }
.inv-item.armor { border-left: 3px solid #2196f3; }
.inv-item.consumable { border-left: 3px solid #4caf50; }
.inv-item.key { border-left: 3px solid #ffd700; }
.inv-item.misc { border-left: 3px solid #9e9e9e; }

/* --- EMPLACEMENT SUR LA CARTE --- */
.location-info {
  display: flex;
  align-items: center;
  gap: 6px;
  background: linear-gradient(135deg, #1a1a2e, #16213e);
  padding: 8px 12px;
  border-radius: 8px;
  margin: 8px 0;
  border-left: 3px solid #58a6ff;
}

.location-icon {
  font-size: 1.1em;
}

.location-name {
  color: #58a6ff;
  font-weight: 600;
}

/* --- MODALE D√âPLACEMENT --- */
.current-location {
  background: #1a1a1a;
  padding: 15px;
  border-radius: 8px;
  text-align: center;
  margin-bottom: 20px;
  border: 1px solid #333;
}

.current-location span {
  color: #888;
  display: block;
  font-size: 0.9em;
  margin-bottom: 5px;
}

.current-location strong {
  color: #58a6ff;
  font-size: 1.3em;
}

.travel-tabs {
  display: flex;
  gap: 5px;
  margin-bottom: 15px;
  flex-wrap: wrap;
}

.tab-btn {
  flex: 1;
  min-width: 120px;
  background: #222;
  border: 1px solid #333;
  color: #aaa;
  padding: 10px;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s;
}

.tab-btn:hover {
  background: #2a2a2a;
  color: #fff;
}

.tab-btn.active {
  background: #58a6ff;
  color: #000;
  border-color: #58a6ff;
  font-weight: bold;
}

.locations-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
  gap: 10px;
  max-height: 350px;
  overflow-y: auto;
  padding: 5px;
}

.location-card {
  background: #1f1f1f;
  border: 1px solid #333;
  border-radius: 8px;
  padding: 12px;
  cursor: pointer;
  transition: all 0.2s;
  text-align: center;
}

.location-card:hover {
  background: #2a2a2a;
  border-color: #58a6ff;
  transform: translateY(-2px);
}

.location-card.current {
  background: #1a3a1a;
  border-color: #4caf50;
}

.location-card.locked {
  opacity: 0.5;
  cursor: not-allowed;
}

.location-card .loc-icon {
  font-size: 1.8em;
  display: block;
  margin-bottom: 5px;
}

.location-card .loc-name {
  font-size: 0.9em;
  color: #eee;
  font-weight: 500;
}

.location-card .loc-desc {
  font-size: 0.75em;
  color: #777;
  margin-top: 4px;
}

.location-card.current .loc-name {
  color: #4caf50;
}

.travel-footer {
  margin-top: 15px;
  padding-top: 10px;
  border-top: 1px solid #333;
  text-align: center;
  color: #666;
}

/* Animation de voyage */
@keyframes traveling {
  0% { opacity: 1; }
  50% { opacity: 0.3; }
  100% { opacity: 1; }
}

.traveling {
  animation: traveling 0.5s ease;
}
/* --- SYST√àME DE TOUR PAR TOUR --- */
.turn-indicator {
  background: linear-gradient(135deg, #1a1a2e, #16213e);
  border: 1px solid #333;
  border-radius: 10px;
  padding: 15px;
  margin-bottom: 15px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.turn-info {
  display: flex;
  align-items: center;
  gap: 10px;
}

.turn-number {
  background: #58a6ff;
  color: #000;
  padding: 5px 12px;
  border-radius: 20px;
  font-weight: bold;
  font-size: 0.9em;
}

.current-player {
  font-size: 1.1em;
  color: #fff;
}

.current-player .player-name {
  color: #ffd700;
  font-weight: bold;
}

.turn-controls {
  display: flex;
  gap: 8px;
}

.turn-controls button {
  background: #333;
  border: 1px solid #444;
  color: #fff;
  padding: 8px 12px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.85em;
}

.turn-controls button:hover {
  background: #444;
}

.turn-controls button.skip-btn {
  background: #ff9800;
  color: #000;
}

.turn-controls button.skip-btn:hover {
  background: #ffb74d;
}

/* Liste des joueurs dans l'ordre */
.turn-order {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin-top: 10px;
  padding: 10px;
  background: #111;
  border-radius: 8px;
}

.turn-player {
  background: #222;
  padding: 5px 10px;
  border-radius: 15px;
  font-size: 0.85em;
  color: #888;
  border: 1px solid #333;
  transition: all 0.3s;
}

.turn-player.active {
  background: #1a3a1a;
  color: #4caf50;
  border-color: #4caf50;
  box-shadow: 0 0 10px rgba(76, 175, 80, 0.3);
}

.turn-player.played {
  background: #2a2a2a;
  color: #666;
  text-decoration: line-through;
}

.turn-player .player-index {
  background: #444;
  color: #fff;
  padding: 2px 6px;
  border-radius: 10px;
  font-size: 0.75em;
  margin-right: 5px;
}

.turn-player.active .player-index {
  background: #4caf50;
  color: #000;
}

/* Message avec indication du joueur */
.msg .msg-author {
  font-size: 0.75em;
  color: #888;
  margin-bottom: 3px;
  display: block;
}

.msg .msg-turn {
  font-size: 0.7em;
  color: #666;
  float: right;
}

/* Indicateur visuel dans le chat */
#chatControls.disabled input {
  opacity: 0.5;
  pointer-events: none;
}

#chatControls .waiting-msg {
  color: #ff9800;
  font-size: 0.85em;
  padding: 5px 10px;
}

/* Animation du tour actif */
@keyframes pulse-turn {
  0% { box-shadow: 0 0 5px rgba(76, 175, 80, 0.3); }
  50% { box-shadow: 0 0 15px rgba(76, 175, 80, 0.6); }
  100% { box-shadow: 0 0 5px rgba(76, 175, 80, 0.3); }
}

.turn-player.active {
  animation: pulse-turn 2s infinite;
}

/* --- MAP INTERACTIVE --- */
.map-regions {
  display: flex;
  gap: 8px;
  margin-bottom: 20px;
  flex-wrap: wrap;
  justify-content: center;
}

.region-btn {
  background: #222;
  border: 1px solid #333;
  color: #aaa;
  padding: 12px 20px;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s;
  font-size: 1em;
}

.region-btn:hover {
  background: #2a2a2a;
  color: #fff;
}

.region-btn.active {
  background: linear-gradient(135deg, #58a6ff, #0078ff);
  color: #fff;
  border-color: #58a6ff;
  font-weight: bold;
}

.map-container {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  min-height: 400px;
}

@media (max-width: 700px) {
  .map-container {
    grid-template-columns: 1fr;
  }
}

.map-locations {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
  gap: 10px;
  max-height: 450px;
  overflow-y: auto;
  padding: 10px;
  background: #111;
  border-radius: 10px;
  border: 1px solid #333;
}

.map-location {
  background: #1a1a1a;
  border: 2px solid #333;
  border-radius: 10px;
  padding: 15px 10px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s;
}

.map-location:hover {
  background: #252525;
  border-color: #58a6ff;
  transform: scale(1.05);
}

.map-location.selected {
  background: #1a2a3a;
  border-color: #58a6ff;
  box-shadow: 0 0 15px rgba(88, 166, 255, 0.3);
}

.map-location .loc-icon {
  font-size: 2em;
  display: block;
  margin-bottom: 8px;
}

.map-location .loc-name {
  font-size: 0.85em;
  color: #eee;
  font-weight: 500;
}

.map-location .loc-players {
  font-size: 0.7em;
  color: #4caf50;
  margin-top: 5px;
}

/* Panneau de d√©tails */
.location-details {
  background: #151515;
  border: 1px solid #333;
  border-radius: 10px;
  padding: 20px;
  overflow-y: auto;
  max-height: 450px;
}

.location-placeholder {
  text-align: center;
  color: #666;
  padding: 50px 20px;
}

.location-placeholder span {
  font-size: 3em;
  display: block;
  margin-bottom: 15px;
}

.location-header {
  display: flex;
  align-items: center;
  gap: 15px;
  margin-bottom: 20px;
  padding-bottom: 15px;
  border-bottom: 1px solid #333;
}

.location-header .header-icon {
  font-size: 2.5em;
}

.location-header .header-info h3 {
  margin: 0;
  color: #58a6ff;
  font-size: 1.3em;
}

.location-header .header-info p {
  margin: 5px 0 0;
  color: #888;
  font-size: 0.9em;
}

/* M√©t√©o */
.weather-box {
  background: linear-gradient(135deg, #1a2a3a, #0d1a2a);
  border: 1px solid #2a4a6a;
  border-radius: 10px;
  padding: 15px;
  margin-bottom: 15px;
  display: flex;
  align-items: center;
  gap: 15px;
}

.weather-icon {
  font-size: 2.5em;
}

.weather-info .weather-name {
  font-size: 1.1em;
  color: #fff;
  font-weight: bold;
}

.weather-info .weather-desc {
  font-size: 0.85em;
  color: #888;
  margin-top: 3px;
}

.weather-info .weather-temp {
  font-size: 0.9em;
  color: #58a6ff;
  margin-top: 5px;
}

/* Sections */
.detail-section {
  margin-bottom: 20px;
}

.detail-section h4 {
  color: #ffcc66;
  margin: 0 0 10px 0;
  font-size: 1em;
  display: flex;
  align-items: center;
  gap: 8px;
}

.detail-section h4::before {
  content: '';
  display: inline-block;
  width: 4px;
  height: 16px;
  background: #ffcc66;
  border-radius: 2px;
}

/* Joueurs pr√©sents */
.players-list {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
}

.player-tag {
  background: #1a3a1a;
  border: 1px solid #4caf50;
  color: #4caf50;
  padding: 5px 12px;
  border-radius: 15px;
  font-size: 0.85em;
  display: flex;
  align-items: center;
  gap: 5px;
}

.player-tag .player-level {
  background: #4caf50;
  color: #000;
  padding: 2px 6px;
  border-radius: 10px;
  font-size: 0.75em;
  font-weight: bold;
}

/* NPCs */
.npc-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.npc-card {
  background: #1f1f1f;
  border: 1px solid #333;
  border-radius: 8px;
  padding: 10px 12px;
  display: flex;
  align-items: center;
  gap: 10px;
  cursor: pointer;
  transition: all 0.2s;
}

.npc-card:hover {
  background: #2a2a2a;
  border-color: #58a6ff;
}

.npc-card .npc-icon {
  font-size: 1.5em;
}

.npc-card .npc-info {
  flex: 1;
}

.npc-card .npc-name {
  color: #eee;
  font-weight: 500;
}

.npc-card .npc-role {
  color: #888;
  font-size: 0.8em;
}

.npc-card .npc-attitude {
  font-size: 0.75em;
  padding: 3px 8px;
  border-radius: 10px;
}

.npc-card .npc-attitude.friendly { background: #1a3a1a; color: #4caf50; }
.npc-card .npc-attitude.neutral { background: #3a3a1a; color: #ffcc66; }
.npc-card .npc-attitude.hostile { background: #3a1a1a; color: #f44336; }
.npc-card .npc-attitude.unknown { background: #2a2a2a; color: #888; }

/* Boutiques */
.shop-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.shop-card {
  background: #1f1f1f;
  border: 1px solid #333;
  border-radius: 8px;
  padding: 12px;
  cursor: pointer;
  transition: all 0.2s;
}

.shop-card:hover {
  background: #2a2a2a;
  border-color: #ffcc66;
}

.shop-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 8px;
}

.shop-header .shop-icon {
  font-size: 1.5em;
}

.shop-header .shop-name {
  color: #ffcc66;
  font-weight: bold;
  flex: 1;
}

.shop-header .shop-status {
  font-size: 0.75em;
  padding: 3px 8px;
  border-radius: 10px;
}

.shop-header .shop-status.open { background: #1a3a1a; color: #4caf50; }
.shop-header .shop-status.closed { background: #3a1a1a; color: #f44336; }

.shop-items {
  display: flex;
  flex-wrap: wrap;
  gap: 5px;
}

.shop-item {
  background: #2a2a2a;
  padding: 3px 8px;
  border-radius: 5px;
  font-size: 0.75em;
  color: #aaa;
}

/* √âv√©nements */
.events-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.event-card {
  background: linear-gradient(135deg, #2a1a1a, #1a1a2a);
  border: 1px solid #4a3a3a;
  border-radius: 8px;
  padding: 10px 12px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.event-card .event-icon {
  font-size: 1.3em;
}

.event-card .event-info {
  flex: 1;
}

.event-card .event-name {
  color: #ff9800;
  font-weight: 500;
}

.event-card .event-desc {
  color: #888;
  font-size: 0.8em;
}

/* Aucun √©l√©ment */
.empty-section {
  color: #666;
  font-style: italic;
  font-size: 0.9em;
  padding: 10px;
  text-align: center;
}

/* --- HEADER DATETIME --- */
.header-left {
  display: flex;
  align-items: center;
  gap: 20px;
}

.rp-datetime {
  display: flex;
  align-items: center;
  gap: 10px;
  background: linear-gradient(135deg, #1a1a2e, #16213e);
  padding: 8px 15px;
  border-radius: 20px;
  border: 1px solid #333;
}

.rp-date {
  color: #58a6ff;
  font-weight: 500;
  font-size: 0.9em;
}

.rp-time {
  color: #ffd700;
  font-weight: bold;
  font-size: 0.9em;
  padding-left: 10px;
  border-left: 1px solid #444;
}

.time-btn {
  background: #333;
  border: 1px solid #444;
  color: #fff;
  padding: 4px 8px;
  border-radius: 5px;
  cursor: pointer;
  font-size: 0.85em;
}

.time-btn:hover {
  background: #444;
}

/* --- MODALE TEMPS --- */
.time-display {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 15px;
  margin-bottom: 20px;
}

.time-current, .time-tour {
  background: #1a1a1a;
  border: 1px solid #333;
  border-radius: 10px;
  padding: 15px;
  text-align: center;
}

.time-label {
  display: block;
  color: #888;
  font-size: 0.85em;
  margin-bottom: 8px;
}

.time-value {
  color: #58a6ff;
  font-size: 1.2em;
  font-weight: bold;
}

.time-tour .time-value {
  color: #ffd700;
}

.time-info {
  background: #1a2a1a;
  border: 1px solid #2a4a2a;
  border-radius: 10px;
  padding: 15px;
  margin-bottom: 20px;
}

.time-info p {
  margin: 0 0 10px 0;
  color: #aaa;
}

.time-info ul {
  margin: 10px 0;
  padding-left: 20px;
}

.time-info li {
  color: #ccc;
  margin: 5px 0;
}

#daysUntilEvent {
  color: #ff9800;
  font-weight: bold;
  margin-top: 10px;
}

.time-controls {
  background: #151515;
  border: 1px solid #333;
  border-radius: 10px;
  padding: 15px;
  margin-bottom: 15px;
}

.time-controls h4 {
  margin: 0 0 12px 0;
  color: #58a6ff;
  font-size: 0.95em;
}

.time-buttons {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 10px;
}

.time-buttons button {
  background: #2a2a2a;
  border: 1px solid #444;
  color: #fff;
  padding: 8px 15px;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s;
}

.time-buttons button:hover {
  background: #3a3a3a;
  border-color: #58a6ff;
}

.time-set-manual {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

.time-set-manual input {
  background: #222;
  border: 1px solid #444;
  color: #fff;
  padding: 8px 12px;
  border-radius: 6px;
  flex: 1;
  min-width: 120px;
}

.time-set-manual button {
  background: #58a6ff;
  border: none;
  color: #000;
  padding: 8px 20px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: bold;
}

.time-set-manual button:hover {
  background: #7ab8ff;
}

.btn-danger {
  background: #f44336 !important;
  border: none !important;
  color: #fff !important;
  width: 100%;
  padding: 10px !important;
}

.btn-danger:hover {
  background: #ff5252 !important;
}

/* Indicateur jour/nuit dans le header */
.rp-datetime.night {
  background: linear-gradient(135deg, #0d0d1a, #1a1a2e);
  border-color: #2a2a4a;
}

.rp-datetime.night .rp-time {
  color: #b0b0ff;
}

.rp-datetime.day {
  background: linear-gradient(135deg, #1a2a1a, #1a3a2a);
  border-color: #2a4a2a;
}

.rp-datetime.day .rp-time {
  color: #ffd700;
}

/* --- BARRE DE VIE --- */
.hp-container {
  margin: 10px 0;
  background: #1a1a1a;
  border-radius: 8px;
  padding: 8px 10px;
  border: 1px solid #333;
}

.hp-bar {
  height: 12px;
  background: #333;
  border-radius: 6px;
  overflow: hidden;
  margin-bottom: 5px;
}

.hp-fill {
  height: 100%;
  border-radius: 6px;
  transition: width 0.5s ease, background 0.3s;
  box-shadow: 0 0 8px rgba(255,255,255,0.2);
}

.hp-text {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 0.85em;
}

.hp-icon {
  font-size: 1.1em;
}

.hp-value {
  color: #eee;
  flex: 1;
}

.hp-controls {
  display: flex;
  gap: 4px;
}

.hp-btn {
  width: 24px;
  height: 24px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-weight: bold;
  font-size: 1em;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
}

.hp-minus {
  background: #f44336;
  color: #fff;
}

.hp-minus:hover {
  background: #ff5252;
}

.hp-plus {
  background: #4caf50;
  color: #fff;
}

.hp-plus:hover {
  background: #66bb6a;
}

/* Animation d√©g√¢ts */
@keyframes damage-shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-5px); }
  75% { transform: translateX(5px); }
}

.card-ko {
  opacity: 0.7;
  border-color: #9c27b0;
  background: linear-gradient(135deg, #1a1a1a, #2a1a2a);
}

.card-ko .name {
  color: #9c27b0;
  text-decoration: line-through;
}

/* --- STATUTS --- */
.status-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 5px;
  margin: 8px 0;
}

.status-tag {
  padding: 3px 8px;
  border-radius: 12px;
  font-size: 0.75em;
  font-weight: 500;
}

.status-bad {
  background: #3a1a1a;
  color: #f44336;
  border: 1px solid #f44336;
}

.status-good {
  background: #1a3a1a;
  color: #4caf50;
  border: 1px solid #4caf50;
}

.status-critical {
  background: #2a1a3a;
  color: #9c27b0;
  border: 1px solid #9c27b0;
}

.status-neutral {
  background: #2a2a2a;
  color: #888;
  border: 1px solid #444;
}

/* --- BOUTONS CARTE --- */
.btn-details {
  background: #58a6ff !important;
  color: #000 !important;
  font-weight: bold;
}

.btn-details:hover {
  background: #7ab8ff !important;
}

.btn-danger-small {
  background: #f44336 !important;
  color: #fff !important;
  min-width: 40px !important;
  flex: 0 !important;
}

.btn-danger-small:hover {
  background: #ff5252 !important;
}

/* --- MODAL D√âTAILS JOUEUR --- */
.player-detail-header {
  display: flex;
  gap: 20px;
  margin-bottom: 20px;
  padding-bottom: 15px;
  border-bottom: 1px solid #333;
}

.player-avatar {
  width: 80px;
  height: 80px;
  background: linear-gradient(135deg, #58a6ff, #0078ff);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 2.5em;
}

.player-main-info {
  flex: 1;
}

.player-main-info h3 {
  margin: 0;
  color: #58a6ff;
  font-size: 1.5em;
}

.player-main-info .player-subtitle {
  color: #888;
  margin: 5px 0;
}

.player-level-xp {
  display: flex;
  gap: 15px;
  margin-top: 10px;
}

.player-level-xp .badge {
  padding: 5px 12px;
  border-radius: 15px;
  font-size: 0.85em;
  font-weight: bold;
}

.badge-level {
  background: linear-gradient(135deg, #ffd700, #ff9800);
  color: #000;
}

.badge-xp {
  background: #1a3a5a;
  color: #58a6ff;
  border: 1px solid #58a6ff;
}

/* Sections d√©tail */
.detail-section-player {
  background: #1a1a1a;
  border: 1px solid #333;
  border-radius: 10px;
  padding: 15px;
  margin-bottom: 15px;
}

.detail-section-player h4 {
  margin: 0 0 12px 0;
  color: #ffcc66;
  font-size: 1em;
  display: flex;
  align-items: center;
  gap: 8px;
  padding-bottom: 8px;
  border-bottom: 1px solid #333;
}

.detail-row {
  display: flex;
  justify-content: space-between;
  padding: 8px 0;
  border-bottom: 1px solid #222;
}

.detail-row:last-child {
  border-bottom: none;
}

.detail-label {
  color: #888;
}

.detail-value {
  color: #eee;
  font-weight: 500;
}

/* HP d√©taill√© */
.hp-detail-bar {
  height: 25px;
  background: #333;
  border-radius: 12px;
  overflow: hidden;
  position: relative;
  margin: 10px 0;
}

.hp-detail-fill {
  height: 100%;
  border-radius: 12px;
  transition: width 0.5s;
}

.hp-detail-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  color: #fff;
  font-weight: bold;
  text-shadow: 1px 1px 3px #000;
}

/* Actions dans les d√©tails */
.detail-actions {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  gap: 10px;
  margin-top: 20px;
}

.detail-actions button {
  padding: 12px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  font-weight: bold;
  transition: all 0.2s;
}

.action-heal {
  background: #4caf50;
  color: #fff;
}

.action-heal:hover {
  background: #66bb6a;
}

.action-damage {
  background: #f44336;
  color: #fff;
}

.action-damage:hover {
  background: #ff5252;
}

.action-status {
  background: #ff9800;
  color: #000;
}

.action-status:hover {
  background: #ffb74d;
}

.action-edit {
  background: #2196f3;
  color: #fff;
}

.action-edit:hover {
  background: #42a5f5;
}

/* --- HP Quick Actions --- */
.hp-quick-actions {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-top: 10px;
}

.hp-quick-actions button {
  background: #2a2a2a;
  border: 1px solid #444;
  color: #4caf50;
  padding: 6px 12px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.85em;
  transition: all 0.2s;
}

.hp-quick-actions button:hover {
  background: #3a3a3a;
  border-color: #4caf50;
}

.hp-quick-actions button.btn-dmg {
  color: #f44336;
}

.hp-quick-actions button.btn-dmg:hover {
  border-color: #f44336;
}

.hp-quick-actions button.btn-custom {
  color: #58a6ff;
}

.hp-quick-actions button.btn-custom:hover {
  border-color: #58a6ff;
}

/* --- Status Actions --- */
.status-tags-detail {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 10px;
  min-height: 30px;
}

.status-actions {
  display: flex;
  gap: 8px;
  margin-top: 10px;
}

.status-actions button {
  background: #2a2a2a;
  border: 1px solid #444;
  color: #fff;
  padding: 6px 12px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.85em;
}

.status-actions button:hover {
  background: #3a3a3a;
}

/* --- BARRES DE RESSOURCES --- */
.resource-bars {
  background: #1a1a1a;
  border-radius: 8px;
  padding: 10px;
  margin: 8px 0;
  border: 1px solid #333;
}

.resource-bar-container {
  margin-bottom: 8px;
}

.resource-bar-container:last-child {
  margin-bottom: 0;
}

.resource-label {
  display: flex;
  justify-content: space-between;
  font-size: 0.75em;
  margin-bottom: 3px;
  color: #aaa;
}

.resource-bar {
  height: 10px;
  border-radius: 5px;
  overflow: hidden;
}

.resource-fill {
  height: 100%;
  border-radius: 5px;
  transition: width 0.5s ease;
}

/* HP - Rouge */
.hp-bar-bg {
  background: #3a1a1a;
}

.hp-fill-color {
  background: linear-gradient(90deg, #f44336, #ff5722);
  box-shadow: 0 0 8px rgba(244, 67, 54, 0.4);
}

/* Reiatsu - Bleu */
.reiatsu-bar-bg {
  background: #1a1a3a;
}

.reiatsu-fill-color {
  background: linear-gradient(90deg, #2196f3, #00bcd4);
  box-shadow: 0 0 8px rgba(33, 150, 243, 0.4);
}

/* Stamina - Jaune/Orange */
.stamina-bar-bg {
  background: #3a3a1a;
}

.stamina-fill-color {
  background: linear-gradient(90deg, #ff9800, #ffc107);
  box-shadow: 0 0 8px rgba(255, 152, 0, 0.4);
}

/* Animation basse ressource */
@keyframes pulse-low {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

.resource-fill.low {
  animation: pulse-low 1s infinite;
}

/* --- STATS D√âTAILL√âES --- */
.stats-detail-grid {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.stat-detail-item {
  background: #222;
  border-radius: 8px;
  padding: 10px;
  cursor: help;
}

.stat-detail-header {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 6px;
}

.stat-detail-icon {
  font-size: 1.2em;
}

.stat-detail-name {
  flex: 1;
  font-weight: 500;
  color: #eee;
}

.stat-detail-value {
  background: #58a6ff;
  color: #000;
  padding: 2px 10px;
  border-radius: 10px;
  font-weight: bold;
}

.stat-detail-desc {
  font-size: 0.75em;
  color: #888;
  margin-top: 5px;
}

/* --- COMBAT STATS --- */
.combat-stats-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
}

.combat-stat {
  background: #222;
  border-radius: 8px;
  padding: 10px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.combat-stat-icon {
  font-size: 1.3em;
}

.combat-stat-name {
  flex: 1;
  font-size: 0.85em;
  color: #aaa;
}

.combat-stat-value {
  color: #ffd700;
  font-weight: bold;
}

/* --- RESSOURCES D√âTAILL√âES --- */
.resource-detail {
  margin-bottom: 15px;
  padding-bottom: 15px;
  border-bottom: 1px solid #333;
}

.resource-detail:last-child {
  border-bottom: none;
  margin-bottom: 0;
  padding-bottom: 0;
}

.resource-detail-header {
  display: flex;
  justify-content: space-between;
  margin-bottom: 8px;
  font-size: 0.9em;
}

.resource-bar-large {
  height: 20px;
  border-radius: 10px;
  overflow: hidden;
  margin-bottom: 8px;
}

.resource-fill-large {
  height: 100%;
  border-radius: 10px;
  transition: width 0.5s ease;
}

.resource-actions {
  display: flex;
  flex-wrap: wrap;
  gap: 5px;
}

.resource-actions button {
  background: #2a3a2a;
  border: 1px solid #4caf50;
  color: #4caf50;
  padding: 4px 10px;
  border-radius: 5px;
  cursor: pointer;
  font-size: 0.8em;
  transition: all 0.2s;
}

.resource-actions button:hover {
  background: #3a4a3a;
}

.resource-actions button.btn-dmg {
  background: #3a2a2a;
  border-color: #f44336;
  color: #f44336;
}

.resource-actions button.btn-dmg:hover {
  background: #4a3a3a;
}

.resource-info {
  font-size: 0.75em;
  color: #666;
  font-style: italic;
  margin-top: 5px;
}

/* --- BONUS DE RACE --- */
.race-bonuses {
  margin-bottom: 15px;
}

.race-bonus {
  background: linear-gradient(135deg, #1a2a1a, #2a3a2a);
  border: 1px solid #4a5a4a;
  border-radius: 8px;
  padding: 8px 12px;
  margin-bottom: 5px;
  font-size: 0.85em;
  color: #8bc34a;
}

/* --- ACTIONS D√âTAILS --- */
.detail-actions {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
  margin-top: 20px;
}

.detail-actions button {
  padding: 12px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  font-weight: bold;
  font-size: 0.9em;
  transition: all 0.2s;
}

.action-heal {
  background: linear-gradient(135deg, #4caf50, #8bc34a);
  color: #000;
}

.action-heal:hover {
  background: linear-gradient(135deg, #66bb6a, #9ccc65);
}

.action-damage {
  background: linear-gradient(135deg, #f44336, #ff5722);
  color: #fff;
}

.action-damage:hover {
  background: linear-gradient(135deg, #ef5350, #ff7043);
}

.action-status {
  background: linear-gradient(135deg, #ff9800, #ffc107);
  color: #000;
}

.action-status:hover {
  background: linear-gradient(135deg, #ffa726, #ffca28);
}

.action-edit {
  background: linear-gradient(135deg, #2196f3, #03a9f4);
  color: #fff;
}

.action-edit:hover {
  background: linear-gradient(135deg, #42a5f5, #29b6f6);
}

@media (max-width: 500px) {
  .detail-actions {
    grid-template-columns: 1fr;
  }
  
  .combat-stats-grid {
    grid-template-columns: 1fr;
  }
}
/* --- CONNEXION STATUS --- */
#connectionStatus {
  padding: 5px 12px;
  border-radius: 15px;
  font-size: 0.8em;
  margin-left: 15px;
}

.status-connected {
  background: #1a3a1a;
  color: #4caf50;
  border: 1px solid #4caf50;
}

.status-disconnected {
  background: #3a1a1a;
  color: #f44336;
  border: 1px solid #f44336;
}

/* --- JOUEURS CONNECT√âS --- */
.connected-players-bar {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px;
  background: #1a1a1a;
  border-radius: 8px;
  margin-bottom: 10px;
  flex-wrap: wrap;
}

.connected-players-bar > span {
  color: #888;
  font-size: 0.85em;
}

#connectedPlayersList {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.connected-player {
  background: #2a2a2a;
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 0.85em;
  color: #aaa;
  border: 1px solid #444;
}

.connected-player.me {
  background: #1a3a1a;
  color: #4caf50;
  border-color: #4caf50;
}

/* --- INDICATEUR IA --- */
#aiTypingIndicator {
  padding: 10px;
  text-align: center;
  color: #ffcc66;
  font-style: italic;
}

.typing-dots span {
  animation: blink 1.4s infinite both;
}

.typing-dots span:nth-child(2) {
  animation-delay: 0.2s;
}

.typing-dots span:nth-child(3) {
  animation-delay: 0.4s;
}

@keyframes blink {
  0%, 100% { opacity: 0; }
  50% { opacity: 1; }
}

/* --- TOUR SYST√àME --- */
.turn-indicator {
  background: linear-gradient(135deg, #1a1a2e, #16213e);
  border: 1px solid #333;
  border-radius: 10px;
  padding: 15px;
  margin-bottom: 10px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 10px;
}

.turn-info {
  display: flex;
  align-items: center;
  gap: 15px;
}

.turn-number {
  background: #58a6ff;
  color: #000;
  padding: 5px 12px;
  border-radius: 20px;
  font-weight: bold;
}

.current-player .player-name {
  color: #ffd700;
  font-weight: bold;
}

.turn-controls {
  display: flex;
  gap: 8px;
}

.turn-controls button {
  background: #333;
  border: 1px solid #444;
  color: #fff;
  padding: 8px 12px;
  border-radius: 6px;
  cursor: pointer;
}

.turn-controls button:hover {
  background: #444;
}

.skip-btn {
  background: #ff9800 !important;
  color: #000 !important;
}

.turn-order {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin-bottom: 10px;
  padding: 10px;
  background: #111;
  border-radius: 8px;
}

.turn-player {
  background: #222;
  padding: 5px 12px;
  border-radius: 15px;
  font-size: 0.85em;
  color: #888;
  border: 1px solid #333;
  cursor: pointer;
  transition: all 0.3s;
}

.turn-player:hover {
  background: #2a2a2a;
}

.turn-player.active {
  background: #1a3a1a;
  color: #4caf50;
  border-color: #4caf50;
  animation: pulse-turn 2s infinite;
}

.turn-player.played {
  opacity: 0.5;
  text-decoration: line-through;
}

.turn-player .player-index {
  background: #444;
  color: #fff;
  padding: 2px 6px;
  border-radius: 10px;
  font-size: 0.75em;
  margin-right: 5px;
}

.turn-player.active .player-index {
  background: #4caf50;
  color: #000;
}

@keyframes pulse-turn {
  0%, 100% { box-shadow: 0 0 5px rgba(76, 175, 80, 0.3); }
  50% { box-shadow: 0 0 15px rgba(76, 175, 80, 0.6); }
}

/* --- S√âLECTION PERSONNAGE --- */
.character-select-bar {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 12px 15px;
  background: linear-gradient(135deg, #1a2a1a, #2a3a2a);
  border: 1px solid #4caf50;
  border-radius: 8px;
  margin-bottom: 10px;
  flex-wrap: wrap;
}

.character-select-bar label {
  color: #4caf50;
  font-weight: bold;
  font-size: 0.95em;
}

.character-select-bar select {
  flex: 1;
  min-width: 200px;
  max-width: 300px;
  background: #222;
  border: 1px solid #4caf50;
  color: #fff;
  padding: 8px 12px;
  border-radius: 6px;
  cursor: pointer;
}

.character-select-bar select:focus {
  outline: none;
  border-color: #8bc34a;
  box-shadow: 0 0 5px rgba(76, 175, 80, 0.5);
}

#myCharacterInfo {
  color: #888;
  font-size: 0.85em;
  padding: 5px 10px;
  background: #1a1a1a;
  border-radius: 5px;
}

#myCharacterInfo.my-turn {
  color: #ffd700;
  font-weight: bold;
  background: linear-gradient(135deg, #2a2a00, #3a3a00);
  border: 1px solid #ffd700;
  animation: pulse-glow 2s infinite;
}

@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 5px rgba(255, 215, 0, 0.3); }
  50% { box-shadow: 0 0 15px rgba(255, 215, 0, 0.6); }
}

.no-character-warning {
  background: linear-gradient(135deg, #3a2a1a, #4a3a2a);
  border: 1px solid #ff9800;
  color: #ff9800;
  padding: 10px 15px;
  border-radius: 6px;
  text-align: center;
  margin-bottom: 10px;
  font-size: 0.9em;
}

/* --- ONGLETS CHAT --- */
.chat-tabs {
  display: flex;
  gap: 5px;
  margin-bottom: 0;
}

.chat-tab {
  flex: 1;
  background: #1a1a1a;
  border: 1px solid #333;
  border-bottom: none;
  color: #666;
  padding: 12px 15px;
  border-radius: 8px 8px 0 0;
  cursor: pointer;
  transition: all 0.3s;
  font-size: 0.9em;
  font-weight: 500;
}

.chat-tab:hover {
  background: #222;
  color: #aaa;
}

.chat-tab.active {
  background: #101010;
  color: #fff;
  border-bottom-color: #101010;
}

#tabRP.active {
  border-top-color: #58a6ff;
  color: #58a6ff;
}

#tabOOC.active {
  border-top-color: #ff9800;
  color: #ff9800;
}

.badge-notif {
  background: #f44336;
  color: #fff;
  padding: 2px 6px;
  border-radius: 10px;
  font-size: 0.7em;
  margin-left: 5px;
  animation: badge-pulse 1s infinite;
}

@keyframes badge-pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.2); }
}

/* --- FEN√äTRES CHAT --- */
.chat-window {
  background: #101010;
  border: 1px solid #333;
  border-top: none;
  border-radius: 0 0 6px 6px;
  height: 300px;
  overflow-y: auto;
  padding: 10px;
}

#oocWindow {
  border-color: #ff9800;
  background: #0f0f0a;
}

/* --- MESSAGES --- */
.msg {
  margin: 8px 0;
  padding: 8px 12px;
  border-radius: 8px;
  max-width: 90%;
  line-height: 1.4em;
  position: relative;
}

.msg .msg-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 4px;
  font-size: 0.8em;
}

.msg .msg-author {
  font-weight: bold;
  color: #58a6ff;
}

.msg .msg-meta {
  color: #666;
  font-size: 0.75em;
}

.msg .msg-content {
  color: #ddd;
}

.msg.joueur {
  background: linear-gradient(135deg, #1a1a2a, #1a2030);
  border-left: 3px solid #58a6ff;
  margin-left: auto;
}

.msg.narrateur {
  background: linear-gradient(135deg, #1a1a10, #202015);
  border-left: 3px solid #ffcc66;
  margin-right: auto;
}

.msg.system {
  background: #1a1a00;
  border-left: 3px solid #ffd700;
  text-align: center;
  color: #ffd700;
  font-size: 0.9em;
  max-width: 100%;
}

.msg.ooc {
  background: linear-gradient(135deg, #2a2010, #302515);
  border-left: 3px solid #ff9800;
  font-style: italic;
}

.msg.ooc .msg-author {
  color: #ff9800;
}

.msg.ooc::before {
  content: '[OOC] ';
  color: #ff9800;
  font-weight: bold;
}

/* Message du personnage que TU joues */
.msg.joueur.mine {
  background: linear-gradient(135deg, #1a2a1a, #1a3020);
  border-left-color: #4caf50;
}

.msg.joueur.mine .msg-author {
  color: #4caf50;
}

/* --- CONTR√îLES CHAT --- */
#chatControls, #oocControls {
  display: flex;
  gap: 5px;
  margin-top: 10px;
  flex-wrap: wrap;
}

#chatControls input, #oocControls input {
  flex: 1;
  min-width: 200px;
  background: #1a1a1a;
  border: 1px solid #333;
  border-radius: 6px;
  padding: 10px 12px;
  color: #fff;
  font-size: 0.95em;
}

#chatControls input:focus, #oocControls input:focus {
  outline: none;
  border-color: #58a6ff;
}

#chatControls button, #oocControls button {
  background: #2a2a2a;
  border: 1px solid #444;
  color: #fff;
  padding: 10px 15px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.9em;
  transition: all 0.2s;
}

#chatControls button:hover, #oocControls button:hover {
  background: #3a3a3a;
}

#btnSendRP {
  background: linear-gradient(135deg, #58a6ff, #3080df) !important;
  color: #fff !important;
  border: none !important;
  font-weight: bold;
}

#btnSendRP:hover {
  background: linear-gradient(135deg, #70b8ff, #4090ef) !important;
}

#btnSendRP:disabled {
  background: #333 !important;
  color: #666 !important;
  cursor: not-allowed;
}

#oocControls input {
  border-color: #ff9800;
}

#oocControls button {
  background: #ff9800;
  color: #000;
  border: none;
  font-weight: bold;
}

#oocControls button:hover {
  background: #ffb74d;
}

/* --- INDICATEUR TOUR --- */
.your-turn-banner {
  background: linear-gradient(135deg, #1a3a1a, #2a4a2a);
  border: 2px solid #4caf50;
  padding: 12px;
  border-radius: 8px;
  text-align: center;
  margin-bottom: 10px;
  animation: pulse-glow 2s infinite;
}

.your-turn-banner span {
  color: #4caf50;
  font-weight: bold;
  font-size: 1.1em;
}

/* Quand ce n'est PAS ton tour */
#chatControls.not-your-turn #chatMsg {
  border-color: #ff9800;
}

#chatControls.not-your-turn #btnSendRP::after {
  content: ' (pas ton tour)';
  font-size: 0.8em;
  opacity: 0.7;
}

/* Animation notification */
@keyframes fadeInOut {
  0% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
  15% { opacity: 1; transform: translateX(-50%) translateY(0); }
  85% { opacity: 1; transform: translateX(-50%) translateY(0); }
  100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
}

/* Style pour "mon" personnage dans l'ordre des tours */
.turn-player.mine {
  background: linear-gradient(135deg, #1a3a1a, #2a4a2a) !important;
  border-color: #4caf50 !important;
  color: #4caf50 !important;
}

.turn-player.mine.active {
  background: linear-gradient(135deg, #2a5a2a, #3a6a3a) !important;
  box-shadow: 0 0 15px rgba(76, 175, 80, 0.6);
}

/* Animation notification */
@keyframes fadeInOut {
  0% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
  15% { opacity: 1; transform: translateX(-50%) translateY(0); }
  85% { opacity: 1; transform: translateX(-50%) translateY(0); }
  100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
}

/* Status connexion am√©lior√© */
.status-connected {
  background: linear-gradient(135deg, #1a3a1a, #2a4a2a);
  color: #4caf50;
  border: 1px solid #4caf50;
  padding: 5px 12px;
  border-radius: 15px;
  font-size: 0.85em;
}

.status-disconnected {
  background: linear-gradient(135deg, #3a1a1a, #4a2a2a);
  color: #f44336;
  border: 1px solid #f44336;
  padding: 5px 12px;
  border-radius: 15px;
  font-size: 0.85em;
}

/* Joueurs connect√©s am√©lior√©s */
.connected-player {
  background: #2a2a2a;
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 0.85em;
  color: #aaa;
  border: 1px solid #444;
  display: inline-flex;
  align-items: center;
  gap: 5px;
}

.connected-player.me {
  background: linear-gradient(135deg, #1a3a1a, #2a4a2a);
  color: #4caf50;
  border-color: #4caf50;
  font-weight: bold;
}

/* Responsive pour mobile */
@media (max-width: 600px) {
  .character-select-bar {
    flex-direction: column;
    align-items: stretch;
  }
  
  .character-select-bar select {
    max-width: 100%;
  }
  
  .chat-tabs {
    flex-direction: row;
  }
  
  .chat-tab {
    padding: 10px 8px;
    font-size: 0.8em;
  }
  
  #chatControls, #oocControls {
    flex-direction: column;
  }
  
  #chatControls input, #oocControls input {
    min-width: 100%;
  }
  
  #chatControls button, #oocControls button {
    width: 100%;
  }
  
  .turn-indicator {
    flex-direction: column;
    gap: 10px;
  }
  
  .turn-controls {
    width: 100%;
    justify-content: center;
  }
}
</style>
</head>
<body>

<header>
  <div class="header-left">
    <h1>BLEACH RP ‚Äì Fiches Joueurs</h1>
    
    <div class="rp-datetime">
      <span class="rp-date" id="rpDate">üìÖ Vendredi 01 Avril</span>
      <span class="rp-time" id="rpTime">üïê 12:00</span>
      <button class="time-btn" onclick="openTimeControl()" title="G√©rer le temps">‚è±Ô∏è</button>
    </div>
    <div id="connectionStatus" class="status-disconnected">üî¥ D√©connect√©</div>
  </div>
  <div>
    <button onclick="openNew()">+ Nouvelle fiche</button>
    <button onclick="saveData()" title="Sauvegarder sur le serveur">üíæ Sauvegarder</button>
    <select id="rpSelect"></select>
    <button onclick="openNPC()">NPC connus</button>
  </div>
</header>
<!-- Barre lat√©rale gauche -->
<div id="sidebar">
  <button id="bestiaireBtn" onclick="openBestiaire()">üìú‚ÄØBestiaire</button>
  <button id="mapBtn" onclick="openMap()">üó∫Ô∏è Map</button>
</div>

<main id="container"></main>
<!-- Section Tchat RP -->
<!-- Section Tchat RP avec Tour par Tour -->
<!-- Section Tchat RP -->
<section id="chatSection">
  <h2 class="form-title">Salon RP</h2>
  
  <!-- Joueurs connect√©s -->
  <div class="connected-players-bar">
    <span>üë• En ligne :</span>
    <div id="connectedPlayersList"></div>
  </div>
  
  <!-- S√âLECTION DU PERSONNAGE -->
  <div class="character-select-bar">
    <label>üé≠ Tu joues :</label>
    <select id="myCharacterSelect" onchange="selectMyCharacter()">
      <option value="-1">-- Choisir un personnage --</option>
    </select>
    <span id="myCharacterInfo"></span>
  </div>
  
  <!-- Indicateur de tour -->
  <div class="turn-indicator">
    <div class="turn-info">
      <span class="turn-number">Tour <span id="turnNumber">1</span></span>
      <span class="current-player">
        C'est au tour de : <span class="player-name" id="currentPlayerName">‚Äî</span>
      </span>
    </div>
    <div class="turn-controls">
      <button onclick="skipTurn()" class="skip-btn">‚è≠Ô∏è Passer</button>
      <button onclick="resetTurns()">üîÑ Reset</button>
      <button onclick="toggleTurnSystem()">‚öôÔ∏è <span id="turnToggleText">D√©sactiver</span></button>
    </div>
  </div>
  
  <!-- Ordre des joueurs -->
  <div class="turn-order" id="turnOrder"></div>
  
  <!-- ONGLETS RP / OOC -->
  <div class="chat-tabs">
    <button class="chat-tab active" onclick="switchChatTab('rp')" id="tabRP">üé≠ RP (In Character)</button>
    <button class="chat-tab" onclick="switchChatTab('ooc')" id="tabOOC">üí¨ OOC (Hors RP) <span id="oocBadge" class="badge-notif" style="display:none;">!</span></button>
  </div>
  
  <!-- Fen√™tre de chat RP -->
  <div id="chatWindow" class="chat-window active"></div>
  
  <!-- Fen√™tre de chat OOC -->
  <div id="oocWindow" class="chat-window" style="display:none;"></div>
  
  <!-- Indicateur IA en train d'√©crire -->
  <div id="aiTypingIndicator" style="display:none;">
    <span class="typing-dots">üé≠ Le MJ r√©fl√©chit<span>.</span><span>.</span><span>.</span></span>
  </div>

  <!-- Contr√¥les RP -->
  <div id="chatControls">
    <input id="chatMsg" placeholder="√âcris ton action RP..." onkeypress="if(event.key==='Enter')sendChat('joueur')" />
    <button onclick="sendChat('joueur')" id="btnSendRP">üé≠ Envoyer (RP)</button>
    <button onclick="sendChat('narrateur')" title="Message de narration (MJ)">üìú Narration</button>
    <button onclick="clearChat()">üóëÔ∏è</button>
  </div>
  
  <!-- Contr√¥les OOC (cach√©s par d√©faut) -->
  <div id="oocControls" style="display:none;">
    <input id="oocMsg" placeholder="Message hors RP..." onkeypress="if(event.key==='Enter')sendOOC()" />
    <button onclick="sendOOC()">üí¨ Envoyer</button>
    <button onclick="clearOOC()">üóëÔ∏è</button>
  </div>
</section>
<!-- Modal Nouvelle Fiche -->
<div class="modal" id="newModal">
  <div class="modal-content">
    <span class="close" onclick="closeNew()">&times;</span>
    <h2 class="form-title">Cr√©er‚ÄØune‚ÄØnouvelle‚ÄØfiche</h2>

    <div class="form-grid">
      <div class="block">
        <label>Nom</label>
        <input id="newName" placeholder="Nom du personnage">
      </div>

      <div class="block">
        <label>√Çge</label>
        <select id="newAge"></select>
      </div>

      <div class="block" style="grid-column:1/-1;">
        <label>Pass√©‚ÄØ/‚ÄØBackground</label>
        <textarea id="newPast" placeholder="Ancienne vie, origines‚Ä¶"></textarea>
      </div>

      <div class="block">
        <label>Esp√®ce(s)</label>
        <select id="newSpecies" multiple>
          <option>Humain</option>
          <option>Quincy</option>
          <option>Fullbringer</option>
          <option>Shinigami</option>
          <option>Hollow</option>
          <option>√Çme</option>
          <option>Hybrid</option>
        </select>
      </div>

      <div class="block">
        <label>Langues‚ÄØconnues</label>
        <select id="newLang" multiple>
          <option>fran√ßais</option>
          <option>anglais</option>
          <option>japonais</option>
          <option>espagnol</option>
          <option>allemand</option>
          <option>portugais</option>
        </select>
      </div>

      <div class="block" style="grid-column:1/-1;">
        <label>Comp√©tences‚ÄØ(Skills)</label>
        <textarea id="newSkills" placeholder="Zanjutsu, Kid≈ç, Cero, Hoh≈ç‚Ä¶"></textarea>
      </div>

      <div class="block">
        <label>Personnalit√©</label>
        <textarea id="newTraits" placeholder="Traits de caract√®re"></textarea>
      </div>

      <div class="block">
        <label>Objectif‚ÄØ/‚ÄØGoal</label>
        <textarea id="newGoals" placeholder="Motivation principale"></textarea>
      </div>
    </div>

    <button class="confirm" onclick="saveNew()">‚úÖ‚ÄØEnregistrer‚ÄØla‚ÄØfiche</button>
  </div>
</div>
<!-- ===== MODALE : NPC CONNUS ===== -->
<div class="modal" id="npcModal">
  <div class="modal-content">
    <span class="close" onclick="closeNPC()">&times;</span>
    <h2 class="form-title">NPC connus</h2>
    <div id="npcList" style="padding-top:10px;"></div>
  </div>
</div>
<!-- ===== MODALE : BESTIAIRE ===== -->
<div class="modal" id="bestiaireModal">
  <div class="modal-content" style="max-width:800px;">
    <span class="close" onclick="closeBestiaire()">&times;</span>
    <h2 class="form-title">Bestiaire du monde</h2>
    <p style="color:#ccc;font-size:0.9em;margin-bottom:10px;">Liste de tous les personnages canons connus et leur position actuelle.</p>
    <div id="bestiaireList"></div>
  </div>
</div>
<!-- ===== MODALE : D√âTAILS PERSONNAGE ===== -->
<div class="modal" id="detailModal">
  <div class="modal-content" style="max-width:650px;">
    <span class="close" onclick="closeDetail()">&times;</span>
    <h2 class="form-title">D√©tails du personnage</h2>
    <div id="detailContent"></div>
  </div>
</div>
<!-- ===== MODALE : INVENTAIRE ===== -->
<div class="modal" id="invModal">
  <div class="modal-content" style="max-width:500px;">
    <span class="close" onclick="closeInv()">&times;</span>
    <h2 class="form-title" id="invTitle">Inventaire</h2>
    
    <div id="invList" class="inv-list"></div>
    
    <div class="inv-add">
      <input id="newItem" placeholder="Nouvel objet..." />
      <input id="newItemQty" type="number" value="1" min="1" max="99" style="width:60px;" />
      <button onclick="addItem()">‚ûï Ajouter</button>
    </div>
    
    <div class="inv-footer">
      <span id="invCount">0 objets</span>
      <button class="btn" onclick="clearInventory()">üóëÔ∏è Vider tout</button>
    </div>
  </div>
</div>
<!-- ===== MODALE : D√âPLACEMENT ===== -->
<div class="modal" id="travelModal">
  <div class="modal-content" style="max-width:600px;">
    <span class="close" onclick="closeTravel()">&times;</span>
    <h2 class="form-title" id="travelTitle">üö∂ D√©placement</h2>
    
    <div class="current-location">
      <span>Position actuelle :</span>
      <strong id="currentLocationDisplay">‚Äî</strong>
    </div>
    
    <div class="travel-tabs">
      <button class="tab-btn active" onclick="showRegion('monde_humain')">üåÜ Monde Humain</button>
      <button class="tab-btn" onclick="showRegion('soul_society')">‚õ©Ô∏è Soul Society</button>
      <button class="tab-btn" onclick="showRegion('hueco_mundo')">üèúÔ∏è Hueco Mundo</button>
      <button class="tab-btn" onclick="showRegion('autres')">üåÄ Autres</button>
    </div>
    
    <div id="locationsList" class="locations-grid"></div>
    
    <div class="travel-footer">
      <small>üí° Certains lieux peuvent n√©cessiter des conditions sp√©ciales pour y acc√©der.</small>
    </div>
  </div>
</div>

<!-- ===== MODALE : MAP ===== -->
<div class="modal" id="mapModal">
  <div class="modal-content" style="max-width:900px;">
    <span class="close" onclick="closeMap()">&times;</span>
    <h2 class="form-title">üó∫Ô∏è Carte du Monde</h2>
    
    <!-- S√©lection de r√©gion -->
    <div class="map-regions">
      <button class="region-btn active" onclick="selectMapRegion('monde_humain')">üåÜ Monde Humain</button>
      <button class="region-btn" onclick="selectMapRegion('soul_society')">‚õ©Ô∏è Soul Society</button>
      <button class="region-btn" onclick="selectMapRegion('hueco_mundo')">üèúÔ∏è Hueco Mundo</button>
      <button class="region-btn" onclick="selectMapRegion('autres')">üåÄ Autres</button>
    </div>
    
    <!-- Grille des lieux -->
    <div class="map-container">
      <div class="map-locations" id="mapLocations"></div>
      
      <!-- Panneau de d√©tails du lieu -->
      <div class="location-details" id="locationDetails">
        <div class="location-placeholder">
          <span>üëÜ</span>
          <p>S√©lectionnez un lieu pour voir les d√©tails</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ===== MODALE : CONTR√îLE DU TEMPS ===== -->
<div class="modal" id="timeModal">
  <div class="modal-content" style="max-width:500px;">
    <span class="close" onclick="closeTimeControl()">&times;</span>
    <h2 class="form-title">‚è±Ô∏è Contr√¥le du Temps RP</h2>
    
    <div class="time-display">
      <div class="time-current">
        <span class="time-label">Date & Heure actuelles</span>
        <div class="time-value" id="timeDisplayFull">Vendredi 01 Avril - 12:00</div>
      </div>
      <div class="time-tour">
        <span class="time-label">Tour actuel</span>
        <div class="time-value" id="timeDisplayTour">Tour 1</div>
      </div>
    </div>
    
    <div class="time-info">
      <p>üìñ <strong>Timeline du RP :</strong></p>
      <ul>
        <li>üü¢ <strong>Tour 1 (01/04)</strong> - D√©but du RP</li>
        <li>üî¥ <strong>Vendredi 12/05 √† 19:13</strong> - Rencontre Rukia/Ichigo</li>
      </ul>
      <p id="daysUntilEvent"></p>
    </div>
    
    <div class="time-controls">
      <h4>‚è© Avancer le temps</h4>
      <div class="time-buttons">
        <button onclick="advanceTime(0, 15)">+15 min</button>
        <button onclick="advanceTime(0, 30)">+30 min</button>
        <button onclick="advanceTime(1, 0)">+1 heure</button>
        <button onclick="advanceTime(3, 0)">+3 heures</button>
        <button onclick="advanceTime(6, 0)">+6 heures</button>
        <button onclick="advanceTime(12, 0)">+12 heures</button>
      </div>
      <div class="time-buttons">
        <button onclick="advanceDay(1)">+1 jour</button>
        <button onclick="advanceDay(3)">+3 jours</button>
        <button onclick="advanceDay(7)">+1 semaine</button>
      </div>
    </div>
    
    <div class="time-controls">
      <h4>üåÖ Aller √† un moment</h4>
      <div class="time-buttons">
        <button onclick="setTimeOfDay(6, 0)">üåÖ Aube (6h)</button>
        <button onclick="setTimeOfDay(12, 0)">‚òÄÔ∏è Midi (12h)</button>
        <button onclick="setTimeOfDay(18, 0)">üåÜ Soir (18h)</button>
        <button onclick="setTimeOfDay(22, 0)">üåô Nuit (22h)</button>
      </div>
    </div>
    
    <div class="time-controls">
      <h4>üìÖ D√©finir une date pr√©cise</h4>
      <div class="time-set-manual">
        <input type="date" id="manualDate" />
        <input type="time" id="manualTime" />
        <button onclick="setManualDateTime()">Appliquer</button>
      </div>
    </div>
    
    <div class="time-controls">
      <h4>üîÑ R√©initialiser</h4>
      <button onclick="resetRPTime()" class="btn-danger">Revenir au 01 Avril (Tour 1)</button>
    </div>
  </div>
</div>
<!-- ===== MODALE : D√âTAILS JOUEUR ===== -->
<div class="modal" id="playerDetailModal">
  <div class="modal-content" style="max-width:650px;">
    <span class="close" onclick="closePlayerDetails()">&times;</span>
    <h2 class="form-title" id="playerDetailTitle">üìã D√©tails du personnage</h2>
    <div id="playerDetailContent"></div>
  </div>
</div>
<script>

// ===== SOCKET.IO CLIENT =====
let socket;
let myPlayerName = '';

// ===== VARIABLES GLOBALES =====
let myCharacterIndex = -1;  // Index du personnage que je joue
let currentChatTab = 'rp';  // 'rp' ou 'ooc'

// ===== SOCKET.IO CLIENT =====

function initSocket() {
  socket = io();
  
  // Demander le nom du visiteur
  myPlayerName = localStorage.getItem('visitorName');
  if (!myPlayerName) {
    myPlayerName = prompt("Entrez votre nom (vous, pas votre personnage):") || "Visiteur" + Math.floor(Math.random() * 1000);
    localStorage.setItem('visitorName', myPlayerName);
  }
  
  // R√©cup√©rer le personnage sauvegard√©
  const savedChar = localStorage.getItem('myCharacterIndex');
  if (savedChar !== null) {
    myCharacterIndex = parseInt(savedChar);
  }
  
  // === CONNEXION ===
  socket.on("connect", () => {
    console.log("‚úÖ Connect√© au serveur");
    socket.emit("joinGame", {
      visitorName: myPlayerName,
      characterIndex: myCharacterIndex
    });
    updateConnectionStatus(true);
  });
  
  socket.on("disconnect", () => {
    console.log("‚ùå D√©connect√©");
    updateConnectionStatus(false);
  });
  
  // === √âTAT INITIAL ===
  socket.on("gameState", (state) => {
    allData = state.rpData;
    turnSystem = state.turnSystem;
    
    // Charger le RP
    const sel = document.getElementById("rpSelect");
    sel.innerHTML = "";
    Object.keys(allData).forEach(id => {
      const opt = document.createElement("option");
      opt.value = id;
      opt.textContent = allData[id].title;
      sel.appendChild(opt);
    });
    
    currentRP = allData[state.currentRP];
    showPlayers(currentRP);
    updateCharacterSelect();
    updateTurnDisplay();
    
    // Charger le chat RP
    document.getElementById("chatWindow").innerHTML = "";
    state.chat.forEach(msg => addChatMessage(msg));
    
    // Charger le chat OOC
    document.getElementById("oocWindow").innerHTML = "";
    if (state.oocChat) {
      state.oocChat.forEach(msg => addOOCMessage(msg));
    }
    
    // Mettre √† jour les joueurs connect√©s
    updateConnectedPlayers(state.connectedPlayers);
    
    // Mettre √† jour le temps RP
    if (state.rpTime) {
      rpTime = { 
        date: new Date(state.rpTime.date), 
        tour: state.rpTime.tour 
      };
      updateTimeDisplay();
    }
  });
  
  // === MESSAGES RP ===
  socket.on("chatMessage", (msg) => {
    addChatMessage(msg);
  });
  
  // === MESSAGES OOC ===
  socket.on("oocMessage", (msg) => {
    addOOCMessage(msg);
    
    // Notification si on n'est pas sur l'onglet OOC
    if (currentChatTab !== 'ooc') {
      document.getElementById('oocBadge').style.display = 'inline';
    }
  });
  
  // === IA EN TRAIN D'√âCRIRE ===
  socket.on("aiTyping", (isTyping) => {
    const indicator = document.getElementById("aiTypingIndicator");
    if (indicator) {
      indicator.style.display = isTyping ? "block" : "none";
    }
  });
  
  // === TOUR CHANG√â ===
  socket.on("turnChanged", (data) => {
    turnSystem = data.turnSystem;
    updateTurnDisplay();
    updateMyCharacterInfo();
    
        // Notification si c'est mon tour
    if (myCharacterIndex >= 0 && turnSystem.currentTurn === myCharacterIndex) {
      showNotification("üéÆ C'est ton tour !");
      
      // Faire vibrer/flasher visuellement
      document.getElementById('myCharacterInfo')?.classList.add('my-turn');
    }
  });
  
  // === JOUEUR MIS √Ä JOUR ===
  socket.on("playerUpdated", (data) => {
    if (currentRP?.players?.[data.playerIndex]) {
      currentRP.players[data.playerIndex] = data.player;
      showPlayers(currentRP);
      updateCharacterSelect();
    }
  });
  
  // === DONN√âES MISES √Ä JOUR ===
  socket.on("dataUpdated", (newData) => {
    allData = newData;
    currentRP = allData[Object.keys(allData)[0]];
    showPlayers(currentRP);
    updateCharacterSelect();
  });
  
  // === JOUEURS CONNECT√âS ===
  socket.on("playersUpdated", (players) => {
    updateConnectedPlayers(players);
  });
  
  // === CHAT VID√â ===
  socket.on("chatCleared", () => {
    document.getElementById("chatWindow").innerHTML = "";
  });
  
  // === OOC VID√â ===
  socket.on("oocCleared", () => {
    document.getElementById("oocWindow").innerHTML = "";
  });
  
  // === TEMPS RP MIS √Ä JOUR ===
  socket.on("rpTimeUpdated", (newTime) => {
    rpTime = { date: new Date(newTime.date), tour: newTime.tour };
    updateTimeDisplay();
  });
}

// ===== S√âLECTION DE PERSONNAGE =====

function updateCharacterSelect() {
  const select = document.getElementById('myCharacterSelect');
  if (!select || !currentRP?.players) return;
  
  const previousValue = select.value;
  
  select.innerHTML = '<option value="-1">-- Choisir un personnage --</option>';
  
  currentRP.players.forEach((p, i) => {
    const opt = document.createElement('option');
    opt.value = i;
    opt.textContent = `${p.name} (${p.species || 'Inconnu'}) - Niv.${p.level || 1}`;
    
    // Marquer si c'est le tour de ce personnage
    if (turnSystem.enabled && turnSystem.currentTurn === i) {
      opt.textContent += ' ‚≠ê (son tour)';
    }
    
    select.appendChild(opt);
  });
  
  // Restaurer la s√©lection
  if (myCharacterIndex >= 0 && myCharacterIndex < currentRP.players.length) {
    select.value = myCharacterIndex;
  } else if (previousValue !== '-1' && parseInt(previousValue) < currentRP.players.length) {
    select.value = previousValue;
    myCharacterIndex = parseInt(previousValue);
  }
  
  updateMyCharacterInfo();
}

function selectMyCharacter() {
  const select = document.getElementById('myCharacterSelect');
  myCharacterIndex = parseInt(select.value);
  
  // Sauvegarder localement
  localStorage.setItem('myCharacterIndex', myCharacterIndex);
  
  // Informer le serveur
  socket.emit("selectCharacter", myCharacterIndex);
  
  updateMyCharacterInfo();
  updateTurnDisplay();
  
  if (myCharacterIndex >= 0 && currentRP?.players?.[myCharacterIndex]) {
    const pj = currentRP.players[myCharacterIndex];
    appendSystemMsg(`üé≠ Tu incarnes maintenant ${pj.name}`);
  }
}

function updateMyCharacterInfo() {
  const info = document.getElementById('myCharacterInfo');
  const sendBtn = document.getElementById('btnSendRP');
  const chatInput = document.getElementById('chatMsg');
  const controls = document.getElementById('chatControls');
  
  if (!info) return;
  
  // Pas de personnage s√©lectionn√©
  if (myCharacterIndex < 0 || !currentRP?.players?.[myCharacterIndex]) {
    info.innerHTML = '<span style="color:#f44336;">‚ö†Ô∏è S√©lectionne un personnage</span>';
    info.classList.remove('my-turn');
    
    if (chatInput) chatInput.placeholder = "S√©lectionne d'abord un personnage...";
    if (sendBtn) sendBtn.disabled = true;
    if (controls) controls.classList.remove('not-your-turn');
    return;
  }
  
  const pj = currentRP.players[myCharacterIndex];
  const isMyTurn = turnSystem.enabled && turnSystem.currentTurn === myCharacterIndex;
  
  if (sendBtn) sendBtn.disabled = false;
  
  if (isMyTurn) {
    info.innerHTML = `‚ú® <strong style="color:#4caf50;">C'EST TON TOUR !</strong> | ‚ù§Ô∏è ${pj.hp}/${pj.maxHp} | üìç ${pj.location || 'Inconnu'}`;
    info.classList.add('my-turn');
    
    if (chatInput) chatInput.placeholder = `C'est ton tour ! Que fait ${pj.name} ?`;
    if (controls) controls.classList.remove('not-your-turn');
  } else if (turnSystem.enabled) {
    const currentPlayer = currentRP.players[turnSystem.currentTurn];
    info.innerHTML = `‚è≥ Tour de ${currentPlayer?.name || '?'} | ‚ù§Ô∏è ${pj.hp}/${pj.maxHp} | üìç ${pj.location || 'Inconnu'}`;
    info.classList.remove('my-turn');
    
    if (chatInput) chatInput.placeholder = `En attente... (tour de ${currentPlayer?.name || '?'})`;
    if (controls) controls.classList.add('not-your-turn');
  } else {
    // Mode libre (tours d√©sactiv√©s)
    info.innerHTML = `üÜì Mode libre | ‚ù§Ô∏è ${pj.hp}/${pj.maxHp} | üìç ${pj.location || 'Inconnu'}`;
    info.classList.remove('my-turn');
    
    if (chatInput) chatInput.placeholder = `Que fait ${pj.name} ?`;
    if (controls) controls.classList.remove('not-your-turn');
  }
}

// ===== SYST√àME DE CHAT =====

// Changer d'onglet
function switchChatTab(tab) {
  currentChatTab = tab;
  
  // Update tabs
  document.getElementById('tabRP').classList.toggle('active', tab === 'rp');
  document.getElementById('tabOOC').classList.toggle('active', tab === 'ooc');
  
  // Update windows
  document.getElementById('chatWindow').style.display = tab === 'rp' ? 'block' : 'none';
  document.getElementById('oocWindow').style.display = tab === 'ooc' ? 'block' : 'none';
  
  // Update controls
  document.getElementById('chatControls').style.display = tab === 'rp' ? 'flex' : 'none';
  document.getElementById('oocControls').style.display = tab === 'ooc' ? 'flex' : 'none';
  
  // Clear OOC badge
  if (tab === 'ooc') {
    document.getElementById('oocBadge').style.display = 'none';
  }
  
  // Scroll to bottom
  const activeWindow = tab === 'rp' ? 'chatWindow' : 'oocWindow';
  const win = document.getElementById(activeWindow);
  if (win) win.scrollTop = win.scrollHeight;
}

// Envoyer un message RP
function sendChat(type) {
  const msgField = document.getElementById("chatMsg");
  const txt = msgField.value.trim();
  if (!txt) return;
  
  // Pour les messages "joueur", v√©rifier qu'un personnage est s√©lectionn√©
  if (type === 'joueur') {
    if (myCharacterIndex < 0 || !currentRP?.players?.[myCharacterIndex]) {
      alert("‚ö†Ô∏è S√©lectionne d'abord un personnage pour envoyer un message RP !");
      return;
    }
    
    // Avertir si ce n'est pas son tour (mais permettre quand m√™me)
    if (turnSystem.enabled && turnSystem.currentTurn !== myCharacterIndex) {
      const currentPlayer = currentRP.players[turnSystem.currentTurn];
      if (!confirm(`‚ö†Ô∏è Ce n'est pas ton tour ! C'est au tour de ${currentPlayer?.name}.\n\nEnvoyer quand m√™me ?`)) {
        return;
      }
    }
  }
  
  msgField.value = "";
  
  // Obtenir le nom du personnage
  const character = myCharacterIndex >= 0 ? currentRP.players[myCharacterIndex] : null;
  const characterName = character ? character.name : myPlayerName;
  
  // Envoyer au serveur
  socket.emit("sendMessage", {
    type: type,
    text: txt,
    characterName: characterName,
    characterIndex: myCharacterIndex
  });
  
  // Si c'est un message joueur et que c'est son tour, passer au suivant
  if (type === 'joueur' && turnSystem.enabled && turnSystem.currentTurn === myCharacterIndex) {
    socket.emit("nextTurn");
  }
}

// Envoyer un message OOC
function sendOOC() {
  const msgField = document.getElementById("oocMsg");
  const txt = msgField.value.trim();
  if (!txt) return;
  
  msgField.value = "";
  
  socket.emit("sendOOC", {
    text: txt,
    author: myPlayerName
  });
}

// Ajouter un message RP au chat
function addChatMessage(msg) {
  const win = document.getElementById("chatWindow");
  if (!win) return;
  
  const div = document.createElement("div");
  
  // D√©terminer si c'est MON message
  const isMyMessage = msg.characterIndex === myCharacterIndex && myCharacterIndex >= 0;
  
  if (msg.type === 'system') {
    div.className = "msg system";
    div.innerHTML = msg.text;
  } else if (msg.type === 'joueur') {
    div.className = `msg joueur${isMyMessage ? ' mine' : ''}`;
    div.innerHTML = `
      <div class="msg-header">
        <span class="msg-author">üé≠ ${msg.author || 'Inconnu'}</span>
        <span class="msg-meta">Tour ${msg.turn || '?'} ‚Ä¢ ${formatTime(msg.timestamp)}</span>
      </div>
      <div class="msg-content">${escapeHtml(msg.text)}</div>
    `;
  } else if (msg.type === 'narrateur') {
    div.className = "msg narrateur";
    div.innerHTML = `
      <div class="msg-header">
        <span class="msg-author">üìú ${msg.author || 'Narrateur'}</span>
        <span class="msg-meta">Tour ${msg.turn || '?'}</span>
      </div>
      <div class="msg-content">${escapeHtml(msg.text)}</div>
    `;
  } else {
    div.className = "msg";
    div.innerHTML = msg.text;
  }
  
  win.appendChild(div);
  win.scrollTop = win.scrollHeight;
}

// Ajouter un message OOC
function addOOCMessage(msg) {
  const win = document.getElementById("oocWindow");
  if (!win) return;
  
  const div = document.createElement("div");
  div.className = "msg ooc";
  
  const isMyMessage = msg.author === myPlayerName;
  
  div.innerHTML = `
    <div class="msg-header">
      <span class="msg-author">${isMyMessage ? 'üë§ Toi' : msg.author || 'Anonyme'}</span>
      <span class="msg-meta">${formatTime(msg.timestamp)}</span>
    </div>
    <div class="msg-content">${escapeHtml(msg.text)}</div>
  `;
  
  if (isMyMessage) {
    div.style.marginLeft = 'auto';
    div.style.background = 'linear-gradient(135deg, #2a3020, #303525)';
  }
  
  win.appendChild(div);
  win.scrollTop = win.scrollHeight;
}

// Message syst√®me local
function appendSystemMsg(text) {
  const win = document.getElementById("chatWindow");
  if (!win) return;
  
  const div = document.createElement("div");
  div.className = "msg system";
  div.innerHTML = text;
  win.appendChild(div);
  win.scrollTop = win.scrollHeight;
}

// Garder l'ancienne fonction appendMsg pour compatibilit√©
function appendMsg(role, text) {
  if (role === 'system') {
    appendSystemMsg(text);
  } else {
    addChatMessage({
      type: role,
      text: text,
      author: role === 'narrateur' ? 'üìú MJ' : 'Syst√®me',
      turn: turnSystem?.roundNumber || 1,
      timestamp: new Date().toISOString()
    });
  }
}

// Vider le chat RP
function clearChat() {
  if (confirm("Vider le salon RP ?")) {
    socket.emit("clearChat");
  }
}

// Vider le chat OOC
function clearOOC() {
  if (confirm("Vider le chat OOC ?")) {
    socket.emit("clearOOC");
  }
}

// ===== MISE √Ä JOUR DE L'AFFICHAGE DES TOURS =====

function updateTurnDisplay() {
  if (!currentRP?.players || currentRP.players.length === 0) {
    document.querySelector('.turn-indicator').style.display = 'none';
    document.querySelector('.turn-order').style.display = 'none';
    return;
  }
  
  document.querySelector('.turn-indicator').style.display = 'flex';
  document.querySelector('.turn-order').style.display = 'flex';
  
  const players = currentRP.players;
  const currentPlayer = players[turnSystem.currentTurn];
  
  // Num√©ro de tour
  document.getElementById('turnNumber').innerText = turnSystem.roundNumber;
  
  // Joueur actuel
  document.getElementById('currentPlayerName').innerText = currentPlayer?.name || '‚Äî';
  
  // Texte du bouton toggle
  document.getElementById('turnToggleText').innerText = turnSystem.enabled ? 'D√©sactiver' : 'Activer';
  
  // Liste des joueurs dans l'ordre
  const orderDiv = document.getElementById('turnOrder');
  orderDiv.innerHTML = players.map((p, i) => {
    let classes = 'turn-player';
    if (i === turnSystem.currentTurn && turnSystem.enabled) classes += ' active';
    if (turnSystem.playedThisRound.includes(i)) classes += ' played';
    if (i === myCharacterIndex) classes += ' mine';
    
    return `
      <div class="${classes}" onclick="jumpToPlayer(${i})" title="Cliquer pour passer √† ce joueur (MJ)">
        <span class="player-index">${i + 1}</span>
        ${p.name}
        ${i === myCharacterIndex ? ' (toi)' : ''}
      </div>
    `;
  }).join('');
  
  // Mettre √† jour les infos du personnage
  updateMyCharacterInfo();
  
  // Mettre √† jour le select (pour marquer le tour actuel)
  updateCharacterSelect();
}

// Sauter au tour d'un joueur (MJ)
function jumpToPlayer(index) {
  if (!turnSystem.enabled) return;
  
  const player = currentRP.players[index];
  if (confirm(`Passer directement au tour de ${player.name} ?`)) {
    // Modifier localement et envoyer au serveur
    turnSystem.currentTurn = index;
    socket.emit("setTurn", index);
    appendSystemMsg(`üéØ C'est maintenant au tour de ${player.name}.`);
    updateTurnDisplay();
  }
}

// Fonctions de contr√¥le des tours
function skipTurn() {
  socket.emit("skipTurn");
}

function resetTurns() {
  if (confirm("R√©initialiser les tours ?")) {
    socket.emit("resetTurns");
  }
}

function toggleTurnSystem() {
  socket.emit("toggleTurnSystem");
}

// ===== UTILITAIRES =====

function updateConnectionStatus(connected) {
  const status = document.getElementById("connectionStatus");
  if (status) {
    status.innerHTML = connected 
      ? `üü¢ ${myPlayerName}`
      : 'üî¥ D√©connect√©';
    status.className = connected ? 'status-connected' : 'status-disconnected';
  }
}

function updateConnectedPlayers(players) {
  const list = document.getElementById("connectedPlayersList");
  if (!list) return;
  
  list.innerHTML = players.map(p => {
    const isMe = p.visitorName === myPlayerName;
    const character = p.characterIndex >= 0 && currentRP?.players?.[p.characterIndex];
    const charName = character ? character.name : null;
    
    let display = p.visitorName;
    if (charName) {
      display += ` ‚Üí ${charName}`;
    }
    
    return `
      <span class="connected-player ${isMe ? 'me' : ''}" title="${charName ? `Joue: ${charName}` : 'Pas de personnage'}">
        ${display}
      </span>
    `;
  }).join('');
}

function showNotification(text) {
  // Notification navigateur
  if (Notification.permission === "granted") {
    new Notification("Bleach RP", { body: text, icon: 'üé≠' });
  }
  
  // Notification visuelle dans la page
  const banner = document.createElement('div');
  banner.className = 'your-turn-banner';
  banner.innerHTML = `<span>${text}</span>`;
  banner.style.cssText = `
    position: fixed;
    top: 80px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 1000;
    animation: fadeInOut 3s forwards;
  `;
  document.body.appendChild(banner);
  
  setTimeout(() => banner.remove(), 3000);
}

// Format timestamp to HH:MM
// ===== UTILITAIRES =====

// Format timestamp to HH:MM
function formatTime(timestamp) {
  if (!timestamp) return '';
  
  try {
    const d = new Date(timestamp);
    
    // Check if date is valid
    if (isNaN(d.getTime())) {
      console.warn('Invalid timestamp:', timestamp);
      return '';
    }
    
    const hours = d.getHours().toString().padStart(2, '0');
    const minutes = d.getMinutes().toString().padStart(2, '0');
    return `${hours}:${minutes}`;
  } catch (e) {
    console.error('Error formatting time:', e);
    return '';
  }
}

// Escape HTML to prevent XSS
function escapeHtml(text) {
  if (!text) return '';
  if (typeof text !== 'string') return String(text);
  
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Show notification (browser + visual)
function showNotification(text) {
  // Browser notification
  if ("Notification" in window && Notification.permission === "granted") {
    try {
      new Notification("Bleach RP", { body: text, icon: 'üé≠' });
    } catch (e) {
      console.log('Notification error:', e);
    }
  }
  
  // Visual notification in page
  const banner = document.createElement('div');
  banner.className = 'notification-banner';
  banner.innerHTML = `<span>${escapeHtml(text)}</span>`;
  banner.style.cssText = `
    position: fixed;
    top: 80px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 9999;
    background: linear-gradient(135deg, #1a3a1a, #2a5a2a);
    border: 2px solid #4caf50;
    color: #4caf50;
    padding: 15px 30px;
    border-radius: 10px;
    font-weight: bold;
    font-size: 1.1em;
    box-shadow: 0 5px 20px rgba(0,0,0,0.5);
    animation: fadeInOut 3s forwards;
  `;
  document.body.appendChild(banner);
  
  setTimeout(() => {
    if (banner.parentNode) {
      banner.remove();
    }
  }, 3000);
}

// Update connection status display
function updateConnectionStatus(connected) {
  const status = document.getElementById("connectionStatus");
  if (status) {
    status.innerHTML = connected 
      ? `üü¢ ${myPlayerName}`
      : 'üî¥ D√©connect√©';
    status.className = connected ? 'status-connected' : 'status-disconnected';
  }
}

// Update connected players list
function updateConnectedPlayers(players) {
  const list = document.getElementById("connectedPlayersList");
  if (!list) return;
  
  if (!players || !Array.isArray(players)) {
    list.innerHTML = '<span class="connected-player">Aucun joueur</span>';
    return;
  }
  
  list.innerHTML = players.map(p => {
    const isMe = p.visitorName === myPlayerName;
    const character = (p.characterIndex >= 0 && currentRP?.players?.[p.characterIndex]) 
      ? currentRP.players[p.characterIndex] 
      : null;
    const charName = character ? character.name : null;
    
    let display = p.visitorName || 'Anonyme';
    if (charName) {
      display += ` ‚Üí ${charName}`;
    }
    
    return `
      <span class="connected-player ${isMe ? 'me' : ''}" title="${charName ? 'Joue: ' + charName : 'Pas de personnage s√©lectionn√©'}">
        ${escapeHtml(display)}
      </span>
    `;
  }).join('');
}

// Request notification permission
function requestNotificationPermission() {
  if ("Notification" in window && Notification.permission === "default") {
    Notification.requestPermission().then(permission => {
      console.log('Notification permission:', permission);
    });
  }
}

// Call on load
requestNotificationPermission();

// ===== INITIALISATION =====

// Remplacer l'ancien initSocket par celui-ci
document.addEventListener('DOMContentLoaded', () => {
  initSocket();
});

// Ou si tu veux garder l'appel direct:
initSocket();

// Ajouter un message au chat
function addChatMessage(msg) {
  const win = document.getElementById("chatWindow");
  const div = document.createElement("div");
  div.className = "msg " + msg.type;
  
  if (msg.type === 'system') {
    div.style.cssText = "background:#2a2a00; border-left:3px solid #ffd700; text-align:center; color:#ffd700;";
    div.innerText = msg.text;
  } else if (msg.type === 'joueur') {
    div.innerHTML = `
      <span class="msg-author">üë§ ${msg.author}</span>
      <span class="msg-turn">Tour ${msg.turn}</span>
      <div class="msg-content">${msg.text}</div>
    `;
  } else {
    div.innerText = msg.text;
  }
  
  win.appendChild(div);
  win.scrollTop = win.scrollHeight;
}

// Mettre √† jour le statut de connexion
function updateConnectionStatus(connected) {
  const status = document.getElementById("connectionStatus");
  if (status) {
    status.innerHTML = connected 
      ? `üü¢ Connect√© en tant que <b>${myPlayerName}</b>`
      : 'üî¥ D√©connect√©';
    status.className = connected ? 'status-connected' : 'status-disconnected';
  }
}

// Afficher les joueurs connect√©s
function updateConnectedPlayers(players) {
  const list = document.getElementById("connectedPlayersList");
  if (list) {
    list.innerHTML = players.map(p => `
      <span class="connected-player ${p.name === myPlayerName ? 'me' : ''}">${p.name}</span>
    `).join('');
  }
}

// Notification
function showNotification(text) {
  if (Notification.permission === "granted") {
    new Notification("Bleach RP", { body: text });
  }
}

// Demander permission notifications
if ("Notification" in window && Notification.permission === "default") {
  Notification.requestPermission();
}

// Initialiser
initSocket();

let allData={}, currentRP;

async function loadData(){
  const res = await fetch("/data/rp.json");
  allData = await res.json();
  const sel = document.getElementById("rpSelect");
  sel.innerHTML = "";
  Object.keys(allData).forEach(id => {
    const opt = document.createElement("option");
    opt.value = id;
    opt.textContent = allData[id].title;
    sel.appendChild(opt);
  });
  sel.onchange = () => {
    showPlayers(allData[sel.value]);
    initTurnSystem(); // R√©initialiser les tours quand on change de RP
    initRPTime();
  };
  showPlayers(allData[Object.keys(allData)[0]]);
  initTurnSystem(); // Initialiser les tours au d√©marrage
  initRPTime();
}

function showPlayers(rp){
  currentRP = rp;
  const cont = document.getElementById("container");
  cont.innerHTML = "";
  
  rp.players.forEach((p, i) => {
    // Initialiser les valeurs manquantes
    if(p.hp === undefined) p.hp = 100;
    if(p.maxHp === undefined) p.maxHp = 100;
    if(p.reiatsu === undefined) p.reiatsu = 50;
    if(p.maxReiatsu === undefined) p.maxReiatsu = 50;
    if(p.stamina === undefined) p.stamina = 50;
    if(p.maxStamina === undefined) p.maxStamina = 50;
    if(!p.status) p.status = [];
    
    // Calculer les pourcentages
    const hpPercent = Math.max(0, Math.min(100, (p.hp / p.maxHp) * 100));
    const reiatsuPercent = Math.max(0, Math.min(100, (p.reiatsu / p.maxReiatsu) * 100));
    const staminaPercent = Math.max(0, Math.min(100, (p.stamina / p.maxStamina) * 100));
    
    // G√©n√©rer les statuts
    const statusHTML = p.status.length > 0 
      ? `<div class="status-tags">${p.status.map(s => `<span class="status-tag ${getStatusClass(s)}">${getStatusIcon(s)} ${s}</span>`).join('')}</div>`
      : '';
    
    const c = document.createElement("div");
    c.className = "card";
    if(p.hp <= 0) c.classList.add('card-ko');
    
    c.innerHTML = `
      <div class="card-header">
        <div class="name">${p.name}</div>
        <div class="level-badge">Niv. ${p.level || 1}</div>
      </div>
      <div class="species">${p.species}</div>
      
      <!-- BARRES DE RESSOURCES -->
      <div class="resource-bars">
        <!-- HP -->
        <div class="resource-bar-container">
          <div class="resource-label">
            <span>${p.hp <= 0 ? 'üíÄ' : '‚ù§Ô∏è'} HP</span>
            <span>${p.hp}/${p.maxHp}</span>
          </div>
          <div class="resource-bar hp-bar-bg">
            <div class="resource-fill hp-fill-color" style="width:${hpPercent}%"></div>
          </div>
        </div>
        
        <!-- Reiatsu (Mana spirituel) -->
        <div class="resource-bar-container">
          <div class="resource-label">
            <span>üîµ Reiatsu</span>
            <span>${p.reiatsu}/${p.maxReiatsu}</span>
          </div>
          <div class="resource-bar reiatsu-bar-bg">
            <div class="resource-fill reiatsu-fill-color" style="width:${reiatsuPercent}%"></div>
          </div>
        </div>
        
        <!-- Stamina (Endurance) -->
        <div class="resource-bar-container">
          <div class="resource-label">
            <span>üü° Stamina</span>
            <span>${p.stamina}/${p.maxStamina}</span>
          </div>
          <div class="resource-bar stamina-bar-bg">
            <div class="resource-fill stamina-fill-color" style="width:${staminaPercent}%"></div>
          </div>
        </div>
      </div>
      
      <!-- STATUTS -->
      ${statusHTML}
      
      <!-- EMPLACEMENT -->
      <div class="location-info">
        <span class="location-icon">üìç</span>
        <span class="location-name">${p.location || "Inconnu"}</span>
      </div>
      
      <!-- XP BAR -->
      <div class="xp-bar">
        <div class="xp-fill" style="width:${(p.xp || 0) % 100}%"></div>
        <span class="xp-text">XP: ${p.xp || 0}/100</span>
      </div>
      
      <!-- BOUTONS -->
      <div class="card-buttons">
        <button class='btn btn-details' onclick='openPlayerDetails(${i})'>üìã D√©tails</button>
        <button class='btn' onclick='openInventory(${i})'>üéí</button>
        <button class='btn' onclick='openTravel(${i})'>üö∂</button>
        <button class='btn' onclick='addXP(${i})'>‚≠ê</button>
        <button class='btn btn-danger-small' onclick='deleteCard(${i})'>üóëÔ∏è</button>
      </div>
    `;
    cont.appendChild(c);
  });
  
  if(typeof updateTurnDisplay === 'function') {
    updateTurnDisplay();
  }
}

// Couleur de la barre de vie
function getHpColor(percent) {
  if(percent > 70) return 'linear-gradient(90deg, #4caf50, #8bc34a)';
  if(percent > 40) return 'linear-gradient(90deg, #ff9800, #ffc107)';
  if(percent > 15) return 'linear-gradient(90deg, #f44336, #ff5722)';
  return 'linear-gradient(90deg, #9c27b0, #673ab7)'; // Critique
}

// Classe du statut
function getStatusClass(status) {
  const s = status.toLowerCase();
  if(['empoisonn√©', 'poison', 'br√ªl√©', 'saignement'].includes(s)) return 'status-bad';
  if(['soign√©', 'bouclier', 'buff', 'renforc√©'].includes(s)) return 'status-good';
  if(['ko', 'mort', 'inconscient'].includes(s)) return 'status-critical';
  return 'status-neutral';
}

// Ic√¥ne du statut
function getStatusIcon(status) {
  const icons = {
    'empoisonn√©': 'ü§¢',
    'poison': 'ü§¢',
    'br√ªl√©': 'üî•',
    'saignement': 'ü©∏',
    'soign√©': 'üíö',
    'bouclier': 'üõ°Ô∏è',
    'buff': '‚¨ÜÔ∏è',
    'renforc√©': 'üí™',
    'ko': 'üíÄ',
    'mort': '‚ò†Ô∏è',
    'inconscient': 'üòµ',
    'fatigu√©': 'üò¥',
    'paralys√©': '‚ö°',
    'gel√©': '‚ùÑÔ∏è',
    'confus': 'üòµ‚Äçüí´'
  };
  return icons[status.toLowerCase()] || '‚ùì';
}

// Modifier les HP
// Quand on modifie un joueur, synchroniser
function syncPlayerUpdate(playerIndex) {
  const player = currentRP.players[playerIndex];
  socket.emit("updatePlayer", {
    playerIndex: playerIndex,
    updates: player
  });
}

// Modifier changeHP pour synchroniser
function changeHP(index, amount) {
  const pj = currentRP.players[index];
  const oldHp = pj.hp;
  
  pj.hp = Math.max(0, Math.min(pj.maxHp, pj.hp + amount));
  
  // G√©rer KO
  if (pj.hp <= 0 && oldHp > 0) {
    if (!pj.status.includes('KO')) pj.status.push('KO');
  } else if (pj.hp > 0 && pj.status.includes('KO')) {
    pj.status = pj.status.filter(s => s !== 'KO');
  }
  
  showPlayers(currentRP);
  syncPlayerUpdate(index); // Synchroniser
}

// Modifier modifyResource pour synchroniser
function modifyResource(resource, amount) {
  if (currentDetailIndex < 0) return;
  const pj = currentRP.players[currentDetailIndex];
  
  const maxKey = 'max' + resource.charAt(0).toUpperCase() + resource.slice(1);
  const maxValue = pj[maxKey] || 100;
  
  if (amount === 999) {
    pj[resource] = maxValue;
  } else {
    pj[resource] = Math.max(0, Math.min(maxValue, (pj[resource] || 0) + amount));
  }
  
  // G√©rer KO pour HP
  if (resource === 'hp') {
    if (pj.hp <= 0 && !pj.status.includes('KO')) {
      pj.status.push('KO');
    } else if (pj.hp > 0) {
      pj.status = pj.status.filter(s => s !== 'KO');
    }
  }
  
  openPlayerDetails(currentDetailIndex);
  showPlayers(currentRP);
  syncPlayerUpdate(currentDetailIndex); // Synchroniser
}

// Couleur dynamique selon le pourcentage relatif
function getStatColor(percent){
  if(percent >= 90) return 'linear-gradient(90deg, #ffd700, #ffaa00)'; // Or - Max
  if(percent >= 70) return 'linear-gradient(90deg, #4caf50, #8bc34a)'; // Vert - Haut
  if(percent >= 50) return 'linear-gradient(90deg, #2196f3, #00bcd4)'; // Bleu - Moyen
  if(percent >= 30) return 'linear-gradient(90deg, #ff9800, #ffc107)'; // Orange - Bas
  return 'linear-gradient(90deg, #f44336, #ff5722)'; // Rouge - Tr√®s bas
}

function addXP(i){
  const pj = currentRP.players[i];
  pj.xp = (pj.xp || 0) + 10;
  
  // Level up tous les 100 XP
  if(pj.xp >= 100){
    pj.level = (pj.level || 1) + 1;
    pj.xp = pj.xp - 100;
    
    // Augmenter une stat al√©atoire de 1-3 points
    const statKeys = Object.keys(pj.stats);
    const randomKey = statKeys[Math.floor(Math.random() * statKeys.length)];
    const bonus = Math.floor(Math.random() * 3) + 1;
    pj.stats[randomKey] = Math.min(100, pj.stats[randomKey] + bonus);
    
    alert(`üéâ ${pj.name} passe niveau ${pj.level} !\n+${bonus} en ${randomKey}`);
  }
  
  showPlayers(currentRP);
}

// ----- CREATE FORM -----
function openNew(){
  const modal=document.getElementById("newModal");
  genAgeOptions(1); // valeurs par d√©faut humain‚Äëlike
  modal.style.display="flex";
  // adapter √¢ge selon esp√®ce
  document.getElementById("newSpecies").onchange=updateAgeChoices;
}
function closeNew(){document.getElementById("newModal").style.display="none";}

function genAgeOptions(max,step=1){
  const sel=document.getElementById("newAge");
  sel.innerHTML="";
  if(max>1000){ sel.innerHTML="<option>50</option><option>100</option><option>500</option><option>1000</option><option>5000</option><option>10000+</option>"; return;}
  for(let i=1;i<=max;i+=step){
    const o=document.createElement("option");
    o.text=i; o.value=i;
    sel.appendChild(o);
  }
}

function updateAgeChoices(){
  const vals=Array.from(document.getElementById("newSpecies").selectedOptions).map(o=>o.text);
  if(vals.some(v=>["Shinigami","Hollow","√Çme"].includes(v))) genAgeOptions(10000);
  else genAgeOptions(100);
}

function saveNew(){
  // R√©cup√©rer les esp√®ces s√©lectionn√©es
  const species = Array.from(document.getElementById("newSpecies").selectedOptions).map(o => o.text);
  
  // G√©n√©rer les stats selon la race
  const stats = generateStatsForRace(species);
  
  const n = {
    name: document.getElementById("newName").value.trim(),
    age: document.getElementById("newAge").value,
    past: document.getElementById("newPast").value.trim(),
    species: species.join(", "),
    skills: document.getElementById("newSkills").value.trim(),
    languages: Array.from(document.getElementById("newLang").selectedOptions).map(o => o.text).join(", "),
    traits: document.getElementById("newTraits").value.trim(),
    goals: document.getElementById("newGoals").value.trim(),
    inventory: [],
    level: 1,
    xp: 0,
    location: "Karakura Town",
    hp: stats.maxHp,
    maxHp: stats.maxHp,
    // Nouveau syst√®me de ressources
    reiatsu: stats.maxReiatsu,      // Mana spirituel (pour Kid≈ç, Cero, etc.)
    maxReiatsu: stats.maxReiatsu,
    stamina: stats.maxStamina,       // Endurance (pour attaques physiques)
    maxStamina: stats.maxStamina,
    status: [],
    stats: stats.attributes,
    raceBonuses: stats.bonuses       // Sauvegarder les bonus de race
  };
  
  if(!n.name) { alert("Nom obligatoire"); return; }
  currentRP.players.push(n);
  closeNew(); 
  showPlayers(currentRP);
  
  // Afficher les stats g√©n√©r√©es
  appendMsg('system', `‚ú® ${n.name} cr√©√©(e) ! Race: ${n.species}`);
  appendMsg('system', `üìä Stats: Reiatsu ${n.stats.Reiatsu}, Endurance ${n.stats.Endurance}, Hakuda ${n.stats.Hakuda}, D√©fense ${n.stats.Defense}, Hoh≈ç ${n.stats.Hoho}, Intellect ${n.stats.Intellect}`);
}

// ===== SYST√àME DE G√âN√âRATION DE STATS PAR RACE =====

function generateStatsForRace(speciesArray) {
  // Stats de base (D&D style : 1-10 au niveau 1)
  let baseStats = {
    Reiatsu: 0,    // Pression spirituelle (Mana) - Kid≈ç, Cero, Quincy arrows
    Endurance: 0,  // Stamina pour attaques physiques
    Hakuda: 0,     // Attaque physique (Combat √† mains nues / Zanjutsu)
    Defense: 0,    // D√©fense / R√©duction de d√©g√¢ts
    Hoho: 0,       // Vitesse / Esquive (Shunpo, Son√≠do, Hirenkyaku)
    Intellect: 0   // Critique / Strat√©gie / Perception
  };
  
  let bonuses = [];
  let hpBase = 50;
  let reiatsuBase = 30;
  let staminaBase = 30;
  
  // D√©finir les plages selon la race
  const raceConfigs = {
    'Humain': {
      ranges: { Reiatsu: [0, 5], Endurance: [2, 7], Hakuda: [1, 6], Defense: [1, 5], Hoho: [1, 5], Intellect: [2, 8] },
      hpBonus: 0,
      reiatsuBonus: 0,
      staminaBonus: 10,
      bonusDesc: 'üßë Humain: +10 Stamina, Intellect √©lev√©'
    },
    'Shinigami': {
      ranges: { Reiatsu: [3, 8], Endurance: [3, 7], Hakuda: [4, 9], Defense: [2, 7], Hoho: [3, 8], Intellect: [2, 7] },
      hpBonus: 20,
      reiatsuBonus: 20,
      staminaBonus: 10,
      bonusDesc: '‚öîÔ∏è Shinigami: +20 HP, +20 Reiatsu, Hakuda √©lev√©'
    },
    'Hollow': {
      ranges: { Reiatsu: [4, 9], Endurance: [4, 8], Hakuda: [3, 8], Defense: [4, 9], Hoho: [2, 6], Intellect: [1, 5] },
      hpBonus: 30,
      reiatsuBonus: 30,
      staminaBonus: 20,
      bonusDesc: 'üëπ Hollow: +30 HP, +30 Reiatsu, D√©fense √©lev√©e'
    },
    'Arrancar': {
      ranges: { Reiatsu: [5, 10], Endurance: [4, 9], Hakuda: [4, 9], Defense: [4, 8], Hoho: [4, 9], Intellect: [2, 7] },
      hpBonus: 40,
      reiatsuBonus: 40,
      staminaBonus: 20,
      bonusDesc: 'üòà Arrancar: +40 HP, +40 Reiatsu, Stats √©quilibr√©es √©lev√©es'
    },
    'Quincy': {
      ranges: { Reiatsu: [5, 10], Endurance: [2, 6], Hakuda: [1, 5], Defense: [1, 5], Hoho: [3, 8], Intellect: [4, 9] },
      hpBonus: 0,
      reiatsuBonus: 50,
      staminaBonus: 0,
      bonusDesc: '‚úùÔ∏è Quincy: +50 Reiatsu, Intellect √©lev√©, Faible en physique'
    },
    'Fullbringer': {
      ranges: { Reiatsu: [3, 8], Endurance: [3, 7], Hakuda: [2, 7], Defense: [2, 6], Hoho: [3, 7], Intellect: [3, 8] },
      hpBonus: 10,
      reiatsuBonus: 20,
      staminaBonus: 10,
      bonusDesc: '‚úä Fullbringer: Stats √©quilibr√©es, Polyvalent'
    },
    '√Çme': {
      ranges: { Reiatsu: [1, 6], Endurance: [1, 5], Hakuda: [0, 4], Defense: [0, 4], Hoho: [1, 5], Intellect: [2, 7] },
      hpBonus: -10,
      reiatsuBonus: 10,
      staminaBonus: 0,
      bonusDesc: 'üëª √Çme: Stats faibles, Potentiel de croissance'
    },
    'Vizard': {
      ranges: { Reiatsu: [5, 10], Endurance: [4, 8], Hakuda: [4, 9], Defense: [3, 7], Hoho: [4, 9], Intellect: [3, 7] },
      hpBonus: 30,
      reiatsuBonus: 40,
      staminaBonus: 15,
      bonusDesc: 'üé≠ Vizard: Shinigami + Hollow, Tr√®s puissant'
    },
    'Hybrid': {
      ranges: { Reiatsu: [3, 9], Endurance: [3, 8], Hakuda: [3, 8], Defense: [3, 7], Hoho: [3, 8], Intellect: [3, 8] },
      hpBonus: 20,
      reiatsuBonus: 25,
      staminaBonus: 15,
      bonusDesc: 'üîÄ Hybride: Stats vari√©es, Potentiel unique'
    }
  };
  
  // Appliquer les bonus de chaque race s√©lectionn√©e
  speciesArray.forEach(species => {
    const config = raceConfigs[species];
    if(config) {
      // G√©n√©rer les stats avec les plages de la race
      Object.keys(baseStats).forEach(stat => {
        const [min, max] = config.ranges[stat];
        const roll = randomRange(min, max);
        baseStats[stat] = Math.max(baseStats[stat], roll); // Garder le meilleur si hybride
      });
      
      hpBase += config.hpBonus;
      reiatsuBase += config.reiatsuBonus;
      staminaBase += config.staminaBonus;
      bonuses.push(config.bonusDesc);
    }
  });
  
  // Si aucune race reconnue, stats par d√©faut (humain faible)
  if(bonuses.length === 0) {
    Object.keys(baseStats).forEach(stat => {
      baseStats[stat] = randomRange(1, 5);
    });
    bonuses.push('‚ùì Race inconnue: Stats de base');
  }
  
  return {
    attributes: baseStats,
    maxHp: Math.max(30, hpBase + baseStats.Defense * 5), // HP = Base + Defense * 5
    maxReiatsu: Math.max(20, reiatsuBase + baseStats.Reiatsu * 3), // Reiatsu = Base + Pression * 3
    maxStamina: Math.max(20, staminaBase + baseStats.Endurance * 3), // Stamina = Base + Endurance * 3
    bonuses: bonuses
  };
}

// Fonction utilitaire pour random dans une plage
function randomRange(min, max) {
  return Math.floor(Math.random() * (max - min + 1)) + min;
}

// ----- Delete -----
function deleteCard(i){
  if(confirm("Supprimer cette fiche ?")){
    currentRP.players.splice(i,1);
    showPlayers(currentRP);
  }
}

// ----- INVENTAIRE -----
let currentInvIndex = -1;

function openInventory(i){
  currentInvIndex = i;
  const pj = currentRP.players[i];
  
  // Initialiser l'inventaire s'il n'existe pas
  if(!pj.inventory) pj.inventory = [];
  
  document.getElementById("invTitle").innerText = "üéí Inventaire de " + pj.name;
  renderInventory();
  document.getElementById("invModal").style.display = "flex";
}

function renderInventory(){
  const pj = currentRP.players[currentInvIndex];
  const inv = pj.inventory || [];
  const list = document.getElementById("invList");
  
  if(inv.length === 0){
    list.innerHTML = '<div class="inv-empty">üì¶ Inventaire vide</div>';
  } else {
    list.innerHTML = inv.map((item, idx) => {
      const itemData = parseItem(item);
      return `
        <div class="inv-item ${itemData.category}">
          <span class="inv-item-name">${itemData.icon} ${itemData.name}</span>
          <span class="inv-item-qty">x${itemData.qty}</span>
          <div class="inv-item-actions">
            <button onclick="changeQty(${idx}, -1)">‚ûñ</button>
            <button onclick="changeQty(${idx}, 1)">‚ûï</button>
            <button class="delete-btn" onclick="removeItem(${idx})">üóëÔ∏è</button>
          </div>
        </div>
      `;
    }).join("");
  }
  
  // Compteur
  const totalItems = inv.reduce((sum, item) => {
    const q = parseItem(item).qty;
    return sum + q;
  }, 0);
  document.getElementById("invCount").innerText = `${inv.length} type(s), ${totalItems} objet(s)`;
}

function parseItem(item){
  // Format: "nom" ou "nom|qty" ou "nom|qty|category"
  if(typeof item === 'object'){
    return {
      name: item.name || item,
      qty: item.qty || 1,
      category: item.category || 'misc',
      icon: getItemIcon(item.category || 'misc')
    };
  }
  
  const parts = item.split('|');
  const name = parts[0] || item;
  const qty = parseInt(parts[1]) || 1;
  const category = parts[2] || guessCategory(name);
  
  return {
    name: name,
    qty: qty,
    category: category,
    icon: getItemIcon(category)
  };
}

function guessCategory(name){
  const lower = name.toLowerCase();
  if(lower.includes('√©p√©e') || lower.includes('zanpakuto') || lower.includes('arme') || lower.includes('katana')) return 'weapon';
  if(lower.includes('armure') || lower.includes('protection') || lower.includes('bouclier')) return 'armor';
  if(lower.includes('potion') || lower.includes('pilule') || lower.includes('nourriture') || lower.includes('soin')) return 'consumable';
  if(lower.includes('cl√©') || lower.includes('badge') || lower.includes('pass')) return 'key';
  return 'misc';
}

function getItemIcon(category){
  switch(category){
    case 'weapon': return '‚öîÔ∏è';
    case 'armor': return 'üõ°Ô∏è';
    case 'consumable': return 'üß™';
    case 'key': return 'üîë';
    default: return 'üì¶';
  }
}

function addItem(){
  const nameInput = document.getElementById("newItem");
  const qtyInput = document.getElementById("newItemQty");
  
  const name = nameInput.value.trim();
  const qty = parseInt(qtyInput.value) || 1;
  
  if(!name){
    alert("Entrez un nom d'objet");
    return;
  }
  
  const pj = currentRP.players[currentInvIndex];
  
  // V√©rifier si l'objet existe d√©j√†
  const existingIndex = pj.inventory.findIndex(item => {
    const parsed = parseItem(item);
    return parsed.name.toLowerCase() === name.toLowerCase();
  });
  
  if(existingIndex >= 0){
    // Augmenter la quantit√©
    const existing = parseItem(pj.inventory[existingIndex]);
    const category = existing.category;
    pj.inventory[existingIndex] = `${existing.name}|${existing.qty + qty}|${category}`;
  } else {
    // Ajouter nouvel objet
    const category = guessCategory(name);
    pj.inventory.push(`${name}|${qty}|${category}`);
  }
  
  nameInput.value = "";
  qtyInput.value = "1";
  renderInventory();
}

function changeQty(idx, delta){
  const pj = currentRP.players[currentInvIndex];
  const item = parseItem(pj.inventory[idx]);
  
  const newQty = item.qty + delta;
  
  if(newQty <= 0){
    removeItem(idx);
  } else {
    pj.inventory[idx] = `${item.name}|${newQty}|${item.category}`;
    renderInventory();
  }
}

function removeItem(idx){
  const pj = currentRP.players[currentInvIndex];
  const item = parseItem(pj.inventory[idx]);
  
  if(confirm(`Supprimer "${item.name}" ?`)){
    pj.inventory.splice(idx, 1);
    renderInventory();
  }
}

function clearInventory(){
  if(confirm("Vider tout l'inventaire ?")){
    currentRP.players[currentInvIndex].inventory = [];
    renderInventory();
  }
}

function closeInv(){
  document.getElementById("invModal").style.display = "none";
  currentInvIndex = -1;
}

// ----- NPC -----
function openNPC(){
  const list=document.getElementById("npcList");
  list.innerHTML="";
  (currentRP.npcs||[]).forEach(n=>{
    const d=document.createElement("div");
    d.className="npcCard";
    d.innerHTML=`<b>${n.name}</b> ‚Äî vu par: ${n.knownBy.join(", ")}<br><i>${n.description||""}</i>`;
    list.appendChild(d);
  });
  document.getElementById("npcModal").style.display="flex";
}
function closeNPC(){document.getElementById("npcModal").style.display="none";}


// ---- BESTIAIRE ----
function openBestiaire(){
  const modal=document.getElementById("bestiaireModal");
  const list=document.getElementById("bestiaireList");
  list.innerHTML="";

  const factions = currentRP.bestiaire || {};
  if(Object.keys(factions).length===0){
    list.innerHTML="<i>Aucun personnage d√©fini pour ce RP.</i>";
    modal.style.display="flex";
    return;
  }

  Object.entries(factions).forEach(([faction, persos])=>{
    const bloc=document.createElement("div");
    bloc.innerHTML=`<h3 style="margin-top:20px;color:#ffcc66">${faction}</h3>`;
    persos.forEach((p,index)=>{
      const known = (p.knownBy && p.knownBy.length>0);
      const color = known ? "#58a6ff" : "#777";
      const who   = known ? `(vu par‚ÄØ: ${p.knownBy.join(", ")})` : "(inconnu)";
      const div=document.createElement("div");
      div.style.borderBottom="1px solid #333";
      div.style.padding="8px 2px";
      div.innerHTML=`
        <b style="color:${color}">${p.name}</b>
        <button class='btn' style='float:right' onclick='openDetail("${faction}",${index})'>üîç‚ÄØD√©tails</button>
        <br><span style="color:#aaa">${p.role||""}</span><br>
        <span style="color:#aaa;">Localisation‚ÄØ:</span>‚ÄØ${p.location||"?"}<br>
        <small>${who}</small>
      `;
      bloc.appendChild(div);
    });
    list.appendChild(bloc);
  });

  modal.style.display="flex";
}

function closeBestiaire(){
  document.getElementById("bestiaireModal").style.display="none";
}

/* --- Nouvelle fonction d√©tail --- */
function openDetail(factionName,index){
  const faction = currentRP.bestiaire[factionName];
  if(!faction) return;
  const p = faction[index];
  const detail = document.getElementById("detailContent");

  // Stats relatives pour le bestiaire aussi
  let statsHTML = "";
  if(p.stats){
    const values = Object.values(p.stats).filter(v => typeof v === 'number');
    const maxStat = Math.max(...values, 1);
    
    statsHTML = `<div class="stats-grid" style="margin-top:15px;">
      <div class="stats-header">
        <span>Stats</span>
        <span class="max-indicator">Max: ${maxStat}</span>
      </div>
      ${Object.entries(p.stats).map(([k,v])=>{
        if(typeof v !== 'number') return `<div class="stat-item"><span class="stat-name">${k}</span><span>${v}</span></div>`;
        const percent = (v / maxStat) * 100;
        const color = getStatColor(percent);
        return `
        <div class="stat-item">
          <span class="stat-name">${k}</span>
          <div class="stat-bar">
            <div class="stat-fill" style="width:${percent}%; background:${color}"></div>
          </div>
          <span class="stat-value">${v}</span>
        </div>
      `}).join("")}
    </div>`;
  }

  detail.innerHTML = `
    <h3 style="color:#58a6ff;margin-top:0;">${p.name}</h3>
    <p><b>Esp√®ce :</b> ${p.species || "?"} | <b>Faction :</b> ${factionName}</p>
    ${p.age ? `<p><b>√Çge :</b> ${p.age}</p>` : ""}
    <p><b>R√¥le :</b> ${p.role || "‚Äì"}</p>
    <p><b>Localisation actuelle :</b> ${p.location || "Inconnue"}</p>
    ${p.appearance ? `<p><b>Apparence :</b><br>${p.appearance}</p>` : ""}
    ${p.description ? `<p><b>Description :</b><br>${p.description}</p>` : ""}
    ${p.techniques ? `<p><b>Techniques connues :</b><br>${p.techniques.join(", ")}</p>` : ""}
    ${statsHTML}
    ${p.hidden ? `<details><summary>üîí Informations cach√©es</summary><p>${p.hidden}</p></details>` : ""}
  `;
  document.getElementById("detailModal").style.display="flex";
}

function closeDetail(){
  document.getElementById("detailModal").style.display="none";
}


// ----- SYST√àME DE D√âPLACEMENT -----
let currentTravelIndex = -1;
let currentRegion = 'monde_humain';

// D√©finition des lieux par r√©gion
const LOCATIONS = {
  monde_humain: [
    { id: 'karakura', name: 'Karakura Town', icon: 'üèôÔ∏è', desc: 'Ville principale' },
    { id: 'karakura_school', name: 'Lyc√©e Karakura', icon: 'üè´', desc: '√âcole d\'Ichigo' },
    { id: 'urahara_shop', name: 'Urahara Shop', icon: 'üè™', desc: 'Magasin myst√©rieux' },
    { id: 'karakura_hospital', name: 'H√¥pital', icon: 'üè•', desc: 'Clinique Kurosaki' },
    { id: 'karakura_park', name: 'Parc central', icon: 'üå≥', desc: 'Lieu de rencontre' },
    { id: 'karakura_river', name: 'Rivi√®re', icon: 'üåä', desc: 'Berges calmes' },
    { id: 'naruki_city', name: 'Naruki City', icon: 'üåÉ', desc: 'Ville voisine' }
  ],
  soul_society: [
    { id: 'seireitei', name: 'Seireitei', icon: '‚õ©Ô∏è', desc: 'Cit√© des Shinigami' },
    { id: 'gotei13_hq', name: 'QG du Gotei 13', icon: 'üèØ', desc: 'Quartier g√©n√©ral' },
    { id: 'division_1', name: '1√®re Division', icon: '1Ô∏è‚É£', desc: 'Commandement' },
    { id: 'division_4', name: '4√®me Division', icon: '4Ô∏è‚É£', desc: 'Soins m√©dicaux' },
    { id: 'division_11', name: '11√®me Division', icon: '‚öîÔ∏è', desc: 'Combat' },
    { id: 'division_12', name: '12√®me Division', icon: 'üî¨', desc: 'Recherche' },
    { id: 'rukongai', name: 'Rukongai', icon: 'üèöÔ∏è', desc: 'Districts ext√©rieurs' },
    { id: 'sokyoku_hill', name: 'Colline S≈çkyoku', icon: '‚õ∞Ô∏è', desc: 'Lieu d\'ex√©cution' },
    { id: 'central_46', name: 'Central 46', icon: '‚öñÔ∏è', desc: 'Tribunal supr√™me' }
  ],
  hueco_mundo: [
    { id: 'las_noches', name: 'Las Noches', icon: 'üè∞', desc: 'Palais d\'Aizen' },
    { id: 'menos_forest', name: 'For√™t des Menos', icon: 'üå≤', desc: 'Territoire Hollow' },
    { id: 'white_desert', name: 'D√©sert blanc', icon: 'üèúÔ∏è', desc: 'Sables infinis' },
    { id: 'espada_quarters', name: 'Quartiers Espada', icon: 'üëë', desc: 'R√©sidence des Espada' },
    { id: 'throne_room', name: 'Salle du tr√¥ne', icon: 'ü™ë', desc: 'Centre du pouvoir' }
  ],
  autres: [
    { id: 'dangai', name: 'Dangai', icon: 'üåÄ', desc: 'Passage entre mondes' },
    { id: 'valley_screams', name: 'Vall√©e des Cris', icon: 'üëª', desc: 'Dimension parall√®le' },
    { id: 'royal_palace', name: 'Palais du Roi', icon: 'üëë', desc: 'Dimension royale', locked: true },
    { id: 'wandenreich', name: 'Wandenreich', icon: '‚úùÔ∏è', desc: 'Empire Quincy', locked: true },
    { id: 'garganta', name: 'Garganta', icon: 'üï≥Ô∏è', desc: 'Voie des Hollows' }
  ]
};

function openTravel(i) {
  currentTravelIndex = i;
  const pj = currentRP.players[i];
  
  document.getElementById("travelTitle").innerText = "üö∂ D√©placement de " + pj.name;
  document.getElementById("currentLocationDisplay").innerText = pj.location || "Inconnu";
  
  // Reset tabs
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  document.querySelector('.tab-btn').classList.add('active');
  
  currentRegion = 'monde_humain';
  renderLocations();
  
  document.getElementById("travelModal").style.display = "flex";
}

function closeTravel() {
  document.getElementById("travelModal").style.display = "none";
  currentTravelIndex = -1;
}

function showRegion(region) {
  currentRegion = region;
  
  // Update active tab
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.classList.remove('active');
    if(btn.onclick.toString().includes(region)) {
      btn.classList.add('active');
    }
  });
  
  renderLocations();
}

function renderLocations() {
  const pj = currentRP.players[currentTravelIndex];
  const currentLoc = pj.location || "";
  const locations = LOCATIONS[currentRegion] || [];
  const list = document.getElementById("locationsList");
  
  list.innerHTML = locations.map(loc => {
    const isCurrent = currentLoc.toLowerCase() === loc.name.toLowerCase();
    const isLocked = loc.locked || false;
    
    let classes = "location-card";
    if(isCurrent) classes += " current";
    if(isLocked) classes += " locked";
    
    return `
      <div class="${classes}" onclick="${isLocked ? '' : `travelTo('${loc.name}')`}">
        <span class="loc-icon">${loc.icon}</span>
        <span class="loc-name">${isCurrent ? '‚úì ' : ''}${loc.name}</span>
        <span class="loc-desc">${isLocked ? 'üîí Verrouill√©' : loc.desc}</span>
      </div>
    `;
  }).join("");
}

function travelTo(locationName) {
  const pj = currentRP.players[currentTravelIndex];
  
  if(pj.location === locationName) {
    alert("Vous √™tes d√©j√† √† cet endroit !");
    return;
  }
  
  const oldLocation = pj.location || "Inconnu";
  pj.location = locationName;
  
  // Animation
  document.getElementById("locationsList").classList.add("traveling");
  setTimeout(() => {
    document.getElementById("locationsList").classList.remove("traveling");
  }, 500);
  
  // Update display
  document.getElementById("currentLocationDisplay").innerText = locationName;
  renderLocations();
  showPlayers(currentRP);
  
  // Notification
  appendMsg("narrateur", `üìç ${pj.name} se d√©place de "${oldLocation}" vers "${locationName}".`);
}

// Fonction pour ajouter un lieu personnalis√© (bonus)
function addCustomLocation() {
  const name = prompt("Nom du nouveau lieu :");
  if(!name) return;
  
  const region = currentRegion;
  const icon = prompt("Ic√¥ne (emoji) :", "üìç") || "üìç";
  const desc = prompt("Description courte :", "") || "";
  
  LOCATIONS[region].push({
    id: name.toLowerCase().replace(/\s/g, '_'),
    name: name,
    icon: icon,
    desc: desc
  });
  
  renderLocations();
}

// ----- SYST√àME DE TOUR PAR TOUR -----
let turnSystem = {
  enabled: true,
  currentTurn: 0,        // Index du joueur actuel
  roundNumber: 1,        // Num√©ro du tour complet
  playedThisRound: [],   // Joueurs ayant jou√© ce tour
  history: []            // Historique des actions
};

// Initialiser le syst√®me de tour
function initTurnSystem() {
  if (!currentRP || !currentRP.players || currentRP.players.length === 0) {
    document.querySelector('.turn-indicator').style.display = 'none';
    document.querySelector('.turn-order').style.display = 'none';
    return;
  }
  
  document.querySelector('.turn-indicator').style.display = 'flex';
  document.querySelector('.turn-order').style.display = 'flex';
  
  turnSystem.currentTurn = 0;
  turnSystem.roundNumber = 1;
  turnSystem.playedThisRound = [];
  
  updateTurnDisplay();
}

// Mettre √† jour l'affichage du tour
function updateTurnDisplay() {
  if (!currentRP || !currentRP.players || currentRP.players.length === 0) {
    document.querySelector('.turn-indicator').style.display = 'none';
    document.querySelector('.turn-order').style.display = 'none';
    return;
  }
  
  document.querySelector('.turn-indicator').style.display = 'flex';
  document.querySelector('.turn-order').style.display = 'flex';
  
  const players = currentRP.players;
  const currentPlayer = players[turnSystem.currentTurn];
  
  // Num√©ro de tour
  document.getElementById('turnNumber').innerText = turnSystem.roundNumber;
  
  // Joueur actuel
  document.getElementById('currentPlayerName').innerText = currentPlayer?.name || '‚Äî';
  
  // Texte du bouton toggle
  document.getElementById('turnToggleText').innerText = turnSystem.enabled ? 'D√©sactiver' : 'Activer';
  
  // Liste des joueurs
  const orderDiv = document.getElementById('turnOrder');
  orderDiv.innerHTML = players.map((p, i) => {
    let classes = 'turn-player';
    if (i === turnSystem.currentTurn && turnSystem.enabled) classes += ' active';
    if (turnSystem.playedThisRound.includes(i)) classes += ' played';
    if (p.name === myPlayerName) classes += ' me';
    
    return `
      <div class="${classes}">
        <span class="player-index">${i + 1}</span>
        ${p.name}
        ${p.name === myPlayerName ? ' (moi)' : ''}
      </div>
    `;
  }).join('');
  
  // Placeholder du chat
  const input = document.getElementById('chatMsg');
  if (turnSystem.enabled && currentPlayer) {
    if (currentPlayer.name === myPlayerName) {
      input.placeholder = "üéÆ C'est ton tour ! √âcris ton action...";
      input.disabled = false;
    } else {
      input.placeholder = `‚è≥ C'est au tour de ${currentPlayer.name}...`;
      input.disabled = false; // On peut quand m√™me √©crire en narration
    }
  } else {
    input.placeholder = "Tape un message...";
    input.disabled = false;
  }
}

// Mettre √† jour l'√©tat de l'input chat
function updateChatInput() {
  const controls = document.getElementById('chatControls');
  const input = document.getElementById('chatMsg');
  
  if (!turnSystem.enabled) {
    input.placeholder = "Tape un message ou colle un passage du RP‚Ä¶";
    input.disabled = false;
    return;
  }
  
  const currentPlayer = currentRP.players[turnSystem.currentTurn];
  if (currentPlayer) {
    input.placeholder = `üí¨ C'est au tour de ${currentPlayer.name}...`;
  }
  input.disabled = false;
}

// Passer au tour suivant
function nextTurn() {
  if (!currentRP || !currentRP.players || currentRP.players.length === 0) return;
  
  const players = currentRP.players;
  
  // Marquer le joueur actuel comme ayant jou√©
  if (!turnSystem.playedThisRound.includes(turnSystem.currentTurn)) {
    turnSystem.playedThisRound.push(turnSystem.currentTurn);
  }
  
  // Passer au joueur suivant
  turnSystem.currentTurn = (turnSystem.currentTurn + 1) % players.length;
  
  // Si on revient au premier joueur, nouveau round
  if (turnSystem.currentTurn === 0) {
    turnSystem.roundNumber++;
    turnSystem.playedThisRound = [];
    advanceTimeOnTurn(5);
    
    // Mettre √† jour le tour dans rpTime
    rpTime.tour = turnSystem.roundNumber;
    appendMsg('system', `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê üîÑ TOUR ${turnSystem.roundNumber} ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`);
    // V√©rifier les √©v√©nements sp√©ciaux
    checkSpecialEvents();
  }
  
  updateTurnDisplay();
  updateTimeDisplay();
}

function skipTurn() {
  socket.emit("skipTurn");
}

function resetTurns() {
  if (confirm("R√©initialiser les tours ?")) {
    socket.emit("resetTurns");
  }
}

function toggleTurnSystem() {
  socket.emit("toggleTurnSystem");
}

// Sauter directement √† un joueur (pour le MJ)
function jumpToPlayer(index) {
  if (!turnSystem.enabled) return;
  
  const player = currentRP.players[index];
  if (confirm(`Passer directement au tour de ${player.name} ?`)) {
    turnSystem.currentTurn = index;
    appendMsg('system', `üéØ C'est maintenant au tour de ${player.name}.`);
    updateTurnDisplay();
  }
}



// ----- SYST√àME DE MAP -----
let currentMapRegion = 'monde_humain';
let selectedLocation = null;

// Donn√©es des lieux avec d√©tails
const MAP_DATA = {
  monde_humain: [
    {
      id: 'karakura',
      name: 'Karakura Town',
      icon: 'üèôÔ∏è',
      desc: 'Ville principale o√π r√©side Ichigo',
      weather: { type: 'sunny', name: 'Ensoleill√©', temp: '22¬∞C', desc: 'Ciel d√©gag√©, l√©g√®re brise' },
      shops: [
        { name: 'Urahara Shop', icon: 'üè™', status: 'open', owner: 'Kisuke Urahara', items: ['Gigai', 'Soul Candy', 'Objets spirituels'] },
        { name: 'Konbini 24h', icon: 'üè¨', status: 'open', owner: 'Vendeur', items: ['Nourriture', 'Boissons', 'Magazines'] }
      ],
      npcs: [
        { name: 'Kisuke Urahara', role: 'Marchand / Ex-Capitaine', icon: 'üé©', attitude: 'friendly' },
        { name: 'Tessai Tsukabishi', role: 'Assistant', icon: 'üë®', attitude: 'friendly' },
        { name: 'Jinta Hanakari', role: 'Employ√©', icon: 'üë¶', attitude: 'neutral' }
      ],
      events: [
        { name: 'Hollow Alert', icon: 'üëª', desc: 'Des Hollows apparaissent parfois la nuit' }
      ]
    },
    {
      id: 'karakura_school',
      name: 'Lyc√©e Karakura',
      icon: 'üè´',
      desc: '√âcole o√π √©tudient Ichigo et ses amis',
      weather: { type: 'sunny', name: 'Ensoleill√©', temp: '22¬∞C', desc: 'Belle journ√©e pour √©tudier' },
      shops: [
        { name: 'Caf√©t√©ria', icon: 'üç±', status: 'open', owner: 'Personnel', items: ['Bento', 'Onigiri', 'Boissons'] }
      ],
      npcs: [
        { name: 'Orihime Inoue', role: '√âtudiante', icon: 'üë©', attitude: 'friendly' },
        { name: 'Chad (Yasutora Sado)', role: '√âtudiant', icon: 'üí™', attitude: 'friendly' },
        { name: 'Tatsuki Arisawa', role: '√âtudiante', icon: 'ü•ã', attitude: 'friendly' },
        { name: 'Keigo Asano', role: '√âtudiant', icon: 'üòÑ', attitude: 'friendly' }
      ],
      events: []
    },
    {
      id: 'urahara_shop',
      name: 'Urahara Shop',
      icon: 'üè™',
      desc: 'Magasin myst√©rieux tenu par un ex-capitaine',
      weather: { type: 'sunny', name: 'Ensoleill√©', temp: '22¬∞C', desc: 'Ambiance myst√©rieuse' },
      shops: [
        { name: 'Urahara Shop', icon: 'üè™', status: 'open', owner: 'Kisuke Urahara', items: ['Gigai', 'Soul Candy', 'Mod Souls', '√âquipement spirituel', 'Informations'] }
      ],
      npcs: [
        { name: 'Kisuke Urahara', role: 'Propri√©taire', icon: 'üé©', attitude: 'friendly' },
        { name: 'Tessai Tsukabishi', role: 'Assistant', icon: 'üë®', attitude: 'friendly' },
        { name: 'Yoruichi (chat)', role: 'Chat noir myst√©rieux', icon: 'üê±', attitude: 'friendly' },
        { name: 'Ururu Tsumugiya', role: 'Employ√©e', icon: 'üëß', attitude: 'neutral' }
      ],
      events: [
        { name: 'Entra√Ænement secret', icon: '‚öîÔ∏è', desc: 'Zone d\'entra√Ænement souterraine disponible' }
      ]
    },
    {
      id: 'karakura_hospital',
      name: 'Clinique Kurosaki',
      icon: 'üè•',
      desc: 'Clinique familiale des Kurosaki',
      weather: { type: 'sunny', name: 'Ensoleill√©', temp: '22¬∞C', desc: 'Atmosph√®re calme' },
      shops: [
        { name: 'Soins m√©dicaux', icon: 'üíä', status: 'open', owner: 'Isshin Kurosaki', items: ['Soins', 'Bandages', 'M√©dicaments'] }
      ],
      npcs: [
        { name: 'Isshin Kurosaki', role: 'M√©decin / Ex-Shinigami', icon: 'üë®‚Äç‚öïÔ∏è', attitude: 'friendly' },
        { name: 'Yuzu Kurosaki', role: 'Fille d\'Isshin', icon: 'üëß', attitude: 'friendly' },
        { name: 'Karin Kurosaki', role: 'Fille d\'Isshin', icon: 'üëß', attitude: 'neutral' }
      ],
      events: []
    },
    {
      id: 'karakura_park',
      name: 'Parc Central',
      icon: 'üå≥',
      desc: 'Lieu de rencontre paisible',
      weather: { type: 'cloudy', name: 'Nuageux', temp: '20¬∞C', desc: 'Quelques nuages passagers' },
      shops: [],
      npcs: [
        { name: 'Don Kanonji', role: 'C√©l√©brit√© TV', icon: 'üì∫', attitude: 'friendly' }
      ],
      events: [
        { name: '√Çmes errantes', icon: 'üëª', desc: 'Des Plus apparaissent parfois ici' }
      ]
    },
    {
      id: 'karakura_river',
      name: 'Rivi√®re',
      icon: 'üåä',
      desc: 'Berges calmes, lieu de m√©moire',
      weather: { type: 'sunny', name: 'Ensoleill√©', temp: '21¬∞C', desc: 'Reflets sur l\'eau' },
      shops: [],
      npcs: [],
      events: [
        { name: 'Lieu de m√©moire', icon: 'üïØÔ∏è', desc: 'Endroit o√π Masaki Kurosaki est d√©c√©d√©e' }
      ]
    }
  ],
  soul_society: [
    {
      id: 'seireitei',
      name: 'Seireitei',
      icon: '‚õ©Ô∏è',
      desc: 'Cit√© fortifi√©e des Shinigami',
      weather: { type: 'clear', name: 'Clair', temp: '18¬∞C', desc: 'Air pur et spirituel' },
      shops: [
        { name: 'Armurerie du Gotei', icon: '‚öîÔ∏è', status: 'open', owner: 'Intendance', items: ['Zanpakut≈ç standards', 'Uniformes', '√âquipement'] }
      ],
      npcs: [
        { name: 'Gardes Shinigami', role: 'Patrouille', icon: 'üíÇ', attitude: 'neutral' }
      ],
      events: [
        { name: 'Patrouilles actives', icon: 'üö®', desc: 'S√©curit√© renforc√©e' }
      ]
    },
    {
      id: 'gotei13_hq',
      name: 'QG du Gotei 13',
      icon: 'üèØ',
      desc: 'Quartier g√©n√©ral des 13 divisions',
      weather: { type: 'clear', name: 'Clair', temp: '18¬∞C', desc: 'Atmosph√®re solennelle' },
      shops: [],
      npcs: [
        { name: 'Genry≈´sai Yamamoto', role: 'Commandant', icon: 'üë¥', attitude: 'neutral' },
        { name: 'Ch≈çjir≈ç Sasakibe', role: 'Vice-capitaine 1√®re', icon: 'üë®', attitude: 'neutral' }
      ],
      events: [
        { name: 'R√©union des capitaines', icon: 'üë•', desc: 'R√©unions r√©guli√®res' }
      ]
    },
    {
      id: 'division_4',
      name: '4√®me Division',
      icon: 'üè•',
      desc: 'Division m√©dicale',
      weather: { type: 'clear', name: 'Clair', temp: '18¬∞C', desc: 'Calme et s√©r√©nit√©' },
      shops: [
        { name: 'Infirmerie centrale', icon: 'üíä', status: 'open', owner: '4√®me Division', items: ['Soins', 'Kaid≈ç', 'Repos'] }
      ],
      npcs: [
        { name: 'Retsu Unohana', role: 'Capitaine', icon: 'üë©‚Äç‚öïÔ∏è', attitude: 'friendly' },
        { name: 'Isane Kotetsu', role: 'Vice-capitaine', icon: 'üë©', attitude: 'friendly' },
        { name: 'Hanatar≈ç Yamada', role: '7√®me si√®ge', icon: 'üë¶', attitude: 'friendly' }
      ],
      events: []
    },
    {
      id: 'division_11',
      name: '11√®me Division',
      icon: '‚öîÔ∏è',
      desc: 'Division de combat',
      weather: { type: 'clear', name: 'Clair', temp: '19¬∞C', desc: 'Tension dans l\'air' },
      shops: [
        { name: 'Armurerie', icon: 'üó°Ô∏è', status: 'open', owner: '11√®me Division', items: ['Armes', '√âquipement de combat'] }
      ],
      npcs: [
        { name: 'Kenpachi Zaraki', role: 'Capitaine', icon: 'üòà', attitude: 'hostile' },
        { name: 'Yachiru Kusajishi', role: 'Vice-capitaine', icon: 'üëß', attitude: 'friendly' },
        { name: 'Ikkaku Madarame', role: '3√®me si√®ge', icon: 'üë®‚Äçü¶≤', attitude: 'neutral' },
        { name: 'Yumichika Ayasegawa', role: '5√®me si√®ge', icon: 'üíá', attitude: 'neutral' }
      ],
      events: [
        { name: 'D√©fis de combat', icon: '‚öîÔ∏è', desc: 'Les membres cherchent toujours √† se battre' }
      ]
    },
    {
      id: 'division_12',
      name: '12√®me Division',
      icon: 'üî¨',
      desc: 'Division de recherche et d√©veloppement',
      weather: { type: 'clear', name: 'Clair', temp: '17¬∞C', desc: 'Odeur de produits chimiques' },
      shops: [
        { name: 'Laboratoire', icon: 'üß™', status: 'open', owner: 'Mayuri Kurotsuchi', items: ['Gadgets', 'Drogues exp√©rimentales', 'Analyses'] }
      ],
      npcs: [
        { name: 'Mayuri Kurotsuchi', role: 'Capitaine', icon: 'üé≠', attitude: 'hostile' },
        { name: 'Nemu Kurotsuchi', role: 'Vice-capitaine', icon: 'ü§ñ', attitude: 'neutral' },
        { name: 'Akon', role: 'Chercheur', icon: 'üë®‚Äçüî¨', attitude: 'neutral' }
      ],
      events: [
        { name: 'Exp√©riences en cours', icon: '‚ö†Ô∏è', desc: 'Zone dangereuse' }
      ]
    },
    {
      id: 'rukongai',
      name: 'Rukongai',
      icon: 'üèöÔ∏è',
      desc: 'Districts ext√©rieurs o√π vivent les √¢mes',
      weather: { type: 'cloudy', name: 'Nuageux', temp: '16¬∞C', desc: 'Atmosph√®re morne' },
      shops: [
        { name: 'March√© noir', icon: 'üõí', status: 'open', owner: 'Marchands', items: ['Nourriture', 'V√™tements', 'Objets divers'] }
      ],
      npcs: [
        { name: '√Çmes diverses', role: 'Habitants', icon: 'üë•', attitude: 'neutral' },
        { name: 'Voyous', role: 'Criminels', icon: 'üò†', attitude: 'hostile' }
      ],
      events: [
        { name: 'Pauvret√©', icon: 'üíî', desc: 'Conditions de vie difficiles' }
      ]
    }
  ],
  hueco_mundo: [
    {
      id: 'las_noches',
      name: 'Las Noches',
      icon: 'üè∞',
      desc: 'Palais d\'Aizen au Hueco Mundo',
      weather: { type: 'night', name: 'Nuit √©ternelle', temp: '???', desc: 'Ciel toujours noir, lune constante' },
      shops: [],
      npcs: [
        { name: 'S≈çsuke Aizen', role: 'Seigneur', icon: 'üëë', attitude: 'hostile' },
        { name: 'Gin Ichimaru', role: 'Bras droit', icon: 'ü¶ä', attitude: 'hostile' },
        { name: 'Kaname T≈çsen', role: 'Commandant', icon: 'üï∂Ô∏è', attitude: 'hostile' }
      ],
      events: [
        { name: 'Surveillance constante', icon: 'üëÅÔ∏è', desc: 'Les Espada patrouillent' }
      ]
    },
    {
      id: 'espada_quarters',
      name: 'Quartiers Espada',
      icon: 'üëë',
      desc: 'R√©sidence des dix Espada',
      weather: { type: 'night', name: 'Nuit √©ternelle', temp: '???', desc: 'Silence oppressant' },
      shops: [],
      npcs: [
        { name: 'Ulquiorra Cifer', role: 'Espada n¬∞4', icon: 'üíö', attitude: 'hostile' },
        { name: 'Grimmjow Jaggerjack', role: 'Espada n¬∞6', icon: 'üíô', attitude: 'hostile' },
        { name: 'Nnoitra Gilga', role: 'Espada n¬∞5', icon: 'üî™', attitude: 'hostile' },
        { name: 'Szayelaporro Granz', role: 'Espada n¬∞8', icon: 'üî¨', attitude: 'hostile' }
      ],
      events: [
        { name: 'Tension entre Espada', icon: '‚ö°', desc: 'Rivalit√©s constantes' }
      ]
    },
    {
      id: 'white_desert',
      name: 'D√©sert blanc',
      icon: 'üèúÔ∏è',
      desc: 'Sables infinis du Hueco Mundo',
      weather: { type: 'night', name: 'Nuit √©ternelle', temp: '???', desc: 'Vent glacial, sable blanc' },
      shops: [],
      npcs: [
        { name: 'Hollows sauvages', role: 'Cr√©atures', icon: 'üëπ', attitude: 'hostile' }
      ],
      events: [
        { name: 'Hollows errants', icon: 'üëª', desc: 'Danger constant' }
      ]
    },
    {
      id: 'menos_forest',
      name: 'For√™t des Menos',
      icon: 'üå≤',
      desc: 'For√™t souterraine des Menos Grande',
      weather: { type: 'dark', name: 'Obscurit√© totale', temp: '???', desc: 'Aucune lumi√®re naturelle' },
      shops: [],
      npcs: [
        { name: 'Menos Grande', role: 'Hollows g√©ants', icon: 'üë∫', attitude: 'hostile' },
        { name: 'Adjuchas', role: 'Hollows √©volu√©s', icon: 'üòà', attitude: 'hostile' }
      ],
      events: [
        { name: 'Zone de chasse', icon: '‚ò†Ô∏è', desc: 'Extr√™mement dangereux' }
      ]
    }
  ],
  autres: [
    {
      id: 'dangai',
      name: 'Dangai',
      icon: 'üåÄ',
      desc: 'Passage entre les mondes',
      weather: { type: 'void', name: 'N√©ant', temp: '???', desc: 'Espace-temps instable' },
      shops: [],
      npcs: [
        { name: 'K≈çtotsu', role: 'Nettoyeur', icon: 'üöÇ', attitude: 'hostile' }
      ],
      events: [
        { name: 'Temps instable', icon: '‚è∞', desc: 'Le temps s\'√©coule diff√©remment' },
        { name: 'Nettoyeur', icon: 'üö®', desc: 'Appara√Æt p√©riodiquement' }
      ]
    },
    {
      id: 'garganta',
      name: 'Garganta',
      icon: 'üï≥Ô∏è',
      desc: 'Voie utilis√©e par les Hollows',
      weather: { type: 'void', name: 'Vide', temp: '???', desc: 'N√©ant absolu' },
      shops: [],
      npcs: [],
      events: [
        { name: 'Passage dangereux', icon: '‚ö†Ô∏è', desc: 'N√©cessite de cr√©er son propre chemin' }
      ]
    },
    {
      id: 'royal_palace',
      name: 'Palais du Roi',
      icon: 'üëë',
      desc: 'Dimension royale - Acc√®s restreint',
      weather: { type: 'divine', name: 'Lumi√®re divine', temp: '???', desc: 'Atmosph√®re c√©leste' },
      shops: [],
      npcs: [
        { name: 'Garde Royale', role: 'Protecteurs', icon: 'üõ°Ô∏è', attitude: 'unknown' }
      ],
      events: [],
      locked: true
    }
  ]
};

// Ouvrir la map
function openMap() {
  currentMapRegion = 'monde_humain';
  selectedLocation = null;
  
  // Reset les boutons de r√©gion
  document.querySelectorAll('.region-btn').forEach(btn => btn.classList.remove('active'));
  document.querySelector('.region-btn').classList.add('active');
  
  renderMapLocations();
  renderLocationDetails(null);
  
  document.getElementById("mapModal").style.display = "flex";
}

// Fermer la map
function closeMap() {
  document.getElementById("mapModal").style.display = "none";
}

// S√©lectionner une r√©gion
function selectMapRegion(region) {
  currentMapRegion = region;
  selectedLocation = null;
  
  // Update active button
  document.querySelectorAll('.region-btn').forEach(btn => {
    btn.classList.remove('active');
    if(btn.onclick.toString().includes(region)) {
      btn.classList.add('active');
    }
  });
  
  renderMapLocations();
  renderLocationDetails(null);
}

// Afficher les lieux de la r√©gion
// Afficher les lieux de la r√©gion
function renderMapLocations() {
  const locations = MAP_DATA[currentMapRegion] || [];
  const container = document.getElementById("mapLocations");
  
  container.innerHTML = locations.map(loc => {
    // Compter les joueurs pr√©sents
    const playersHere = currentRP?.players?.filter(p => 
      p.location?.toLowerCase() === loc.name.toLowerCase()
    ) || [];
    
    const isSelected = selectedLocation?.id === loc.id;
    const isLocked = loc.locked || false;
    
    let classes = "map-location";
    if(isSelected) classes += " selected";
    if(isLocked) classes += " locked";
    
    return `
      <div class="${classes}" onclick="${isLocked ? '' : `selectMapLocation('${loc.id}')`}">
        <span class="loc-icon">${loc.icon}</span>
        <span class="loc-name">${loc.name}</span>
        ${playersHere.length > 0 ? `<div class="loc-players">üë• ${playersHere.length} joueur(s)</div>` : ''}
        ${isLocked ? '<div class="loc-players">üîí Verrouill√©</div>' : ''}
      </div>
    `;
  }).join("");
}

// S√©lectionner un lieu
function selectMapLocation(locId) {
  const locations = MAP_DATA[currentMapRegion] || [];
  selectedLocation = locations.find(l => l.id === locId);
  
  renderMapLocations();
  renderLocationDetails(selectedLocation);
}

// Afficher les d√©tails d'un lieu
function renderLocationDetails(location) {
  const container = document.getElementById("locationDetails");
  
  if(!location) {
    container.innerHTML = `
      <div class="location-placeholder">
        <span>üëÜ</span>
        <p>S√©lectionnez un lieu pour voir les d√©tails</p>
      </div>
    `;
    return;
  }
  
  // Joueurs pr√©sents
  const playersHere = currentRP?.players?.filter(p => 
    p.location?.toLowerCase() === location.name.toLowerCase()
  ) || [];
  
  // NPCs du bestiaire pr√©sents ici
  const bestiaireNpcs = [];
  if(currentRP?.bestiaire) {
    Object.values(currentRP.bestiaire).forEach(faction => {
      faction.forEach(npc => {
        if(npc.location?.toLowerCase() === location.name.toLowerCase()) {
          bestiaireNpcs.push(npc);
        }
      });
    });
  }
  
  // G√©n√©rer le HTML
  container.innerHTML = `
    <!-- Header -->
    <div class="location-header">
      <span class="header-icon">${location.icon}</span>
      <div class="header-info">
        <h3>${location.name}</h3>
        <p>${location.desc}</p>
      </div>
    </div>
    
    <!-- M√©t√©o -->
    ${renderWeather(location.weather)}
    
    <!-- Joueurs pr√©sents -->
    <div class="detail-section">
      <h4>üë• Joueurs pr√©sents</h4>
      ${playersHere.length > 0 ? `
        <div class="players-list">
          ${playersHere.map(p => `
            <div class="player-tag">
              <span>${p.name}</span>
              <span class="player-level">Niv.${p.level || 1}</span>
            </div>
          `).join("")}
        </div>
      ` : '<div class="empty-section">Aucun joueur ici</div>'}
    </div>
    
    <!-- NPCs -->
    <div class="detail-section">
      <h4>üé≠ PNJ pr√©sents</h4>
      ${(location.npcs?.length > 0 || bestiaireNpcs.length > 0) ? `
        <div class="npc-list">
          ${location.npcs?.map(npc => renderNpcCard(npc)).join("") || ''}
          ${bestiaireNpcs.map(npc => renderBestiaireNpcCard(npc)).join("")}
        </div>
      ` : '<div class="empty-section">Aucun PNJ visible</div>'}
    </div>
    
    <!-- Boutiques -->
    <div class="detail-section">
      <h4>üè™ Boutiques & Services</h4>
      ${location.shops?.length > 0 ? `
        <div class="shop-list">
          ${location.shops.map(shop => renderShopCard(shop)).join("")}
        </div>
      ` : '<div class="empty-section">Aucune boutique</div>'}
    </div>
    
    <!-- √âv√©nements -->
    ${location.events?.length > 0 ? `
      <div class="detail-section">
        <h4>‚ö° √âv√©nements & Dangers</h4>
        <div class="events-list">
          ${location.events.map(event => `
            <div class="event-card">
              <span class="event-icon">${event.icon}</span>
              <div class="event-info">
                <div class="event-name">${event.name}</div>
                <div class="event-desc">${event.desc}</div>
              </div>
            </div>
          `).join("")}
        </div>
      </div>
    ` : ''}
    
    <!-- Bouton de voyage rapide -->
    <div style="margin-top: 20px; text-align: center;">
      <button class="confirm" onclick="quickTravelTo('${location.name}')" style="max-width: 300px;">
        üö∂ Voyager ici
      </button>
    </div>
  `;
}

// Render m√©t√©o
function renderWeather(weather) {
  if(!weather) return '';
  
  const weatherIcons = {
    sunny: '‚òÄÔ∏è',
    cloudy: '‚òÅÔ∏è',
    rainy: 'üåßÔ∏è',
    stormy: '‚õàÔ∏è',
    snowy: '‚ùÑÔ∏è',
    foggy: 'üå´Ô∏è',
    night: 'üåô',
    clear: '‚ú®',
    dark: 'üåë',
    void: 'üåÄ',
    divine: 'üí´'
  };
  
  const icon = weatherIcons[weather.type] || 'üå§Ô∏è';
  
  return `
    <div class="weather-box">
      <span class="weather-icon">${icon}</span>
      <div class="weather-info">
        <div class="weather-name">${weather.name}</div>
        <div class="weather-desc">${weather.desc}</div>
        <div class="weather-temp">üå°Ô∏è ${weather.temp}</div>
      </div>
    </div>
  `;
}

// Render carte NPC
function renderNpcCard(npc) {
  return `
    <div class="npc-card" onclick="showNpcInfo('${npc.name}')">
      <span class="npc-icon">${npc.icon || 'üë§'}</span>
      <div class="npc-info">
        <div class="npc-name">${npc.name}</div>
        <div class="npc-role">${npc.role || ''}</div>
      </div>
      <span class="npc-attitude ${npc.attitude || 'unknown'}">${getAttitudeLabel(npc.attitude)}</span>
    </div>
  `;
}

// Render carte NPC du bestiaire
function renderBestiaireNpcCard(npc) {
  // D√©terminer l'attitude bas√©e sur l'esp√®ce/faction
  let attitude = 'unknown';
  if(npc.species?.includes('Hollow') || npc.species?.includes('Arrancar')) attitude = 'hostile';
  else if(npc.species?.includes('Shinigami')) attitude = 'neutral';
  else if(npc.species?.includes('Humain')) attitude = 'friendly';
  
  return `
    <div class="npc-card" onclick="openBestiaireNpc('${npc.name}')">
      <span class="npc-icon">üìñ</span>
      <div class="npc-info">
        <div class="npc-name">${npc.name}</div>
        <div class="npc-role">${npc.role || npc.species || ''}</div>
      </div>
      <span class="npc-attitude ${attitude}">${getAttitudeLabel(attitude)}</span>
    </div>
  `;
}

// Render carte boutique
function renderShopCard(shop) {
  return `
    <div class="shop-card" onclick="openShop('${shop.name}')">
      <div class="shop-header">
        <span class="shop-icon">${shop.icon || 'üè™'}</span>
        <span class="shop-name">${shop.name}</span>
        <span class="shop-status ${shop.status}">${shop.status === 'open' ? '‚úÖ Ouvert' : '‚ùå Ferm√©'}</span>
      </div>
      ${shop.owner ? `<div style="font-size:0.8em;color:#888;margin-bottom:5px;">Propri√©taire: ${shop.owner}</div>` : ''}
      <div class="shop-items">
        ${shop.items?.slice(0, 5).map(item => `<span class="shop-item">${item}</span>`).join("") || ''}
        ${shop.items?.length > 5 ? `<span class="shop-item">+${shop.items.length - 5} autres</span>` : ''}
      </div>
    </div>
  `;
}

// Label d'attitude
function getAttitudeLabel(attitude) {
  switch(attitude) {
    case 'friendly': return 'üòä Amical';
    case 'neutral': return 'üòê Neutre';
    case 'hostile': return 'üò† Hostile';
    default: return '‚ùì Inconnu';
  }
}

// Afficher info NPC
function showNpcInfo(npcName) {
  alert(`üìã ${npcName}\n\nPour plus d'informations, consultez le Bestiaire.`);
}

// Ouvrir NPC du bestiaire
function openBestiaireNpc(npcName) {
  // Chercher le NPC dans le bestiaire
  if(currentRP?.bestiaire) {
    for(const [factionName, faction] of Object.entries(currentRP.bestiaire)) {
      const index = faction.findIndex(n => n.name === npcName);
      if(index >= 0) {
        closeMap();
        openDetail(factionName, index);
        return;
      }
    }
  }
  alert(`NPC "${npcName}" non trouv√© dans le bestiaire.`);
}

// Ouvrir boutique
function openShop(shopName) {
  alert(`üè™ ${shopName}\n\nüí° Fonctionnalit√© boutique √† venir!\n\nPour l'instant, utilisez l'inventaire pour ajouter des objets manuellement.`);
}

// Voyage rapide depuis la map
function quickTravelTo(locationName) {
  if(!currentRP || !currentRP.players || currentRP.players.length === 0) {
    alert("Aucun joueur disponible!");
    return;
  }
  
  // Demander quel joueur d√©placer
  const playerNames = currentRP.players.map((p, i) => `${i + 1}. ${p.name} (actuellement: ${p.location || 'Inconnu'})`).join('\n');
  const choice = prompt(`Quel joueur voulez-vous d√©placer vers "${locationName}"?\n\n${playerNames}\n\nEntrez le num√©ro:`);
  
  if(!choice) return;
  
  const index = parseInt(choice) - 1;
  if(isNaN(index) || index < 0 || index >= currentRP.players.length) {
    alert("Num√©ro invalide!");
    return;
  }
  
  const player = currentRP.players[index];
  const oldLocation = player.location || "Inconnu";
  
  if(oldLocation.toLowerCase() === locationName.toLowerCase()) {
    alert(`${player.name} est d√©j√† √† ${locationName}!`);
    return;
  }
  
  player.location = locationName;
  
  // Mettre √† jour l'affichage
  renderMapLocations();
  renderLocationDetails(selectedLocation);
  showPlayers(currentRP);
  
  // Notification dans le chat
  appendMsg("narrateur", `üìç ${player.name} se d√©place de "${oldLocation}" vers "${locationName}".`);
  
  alert(`‚úÖ ${player.name} est maintenant √† ${locationName}!`);
}

// Fonction pour changer la m√©t√©o d'un lieu (pour le MJ)
function changeWeather(locId, weatherType) {
  const locations = MAP_DATA[currentMapRegion] || [];
  const location = locations.find(l => l.id === locId);
  
  if(!location) return;
  
  const weatherTypes = {
    sunny: { type: 'sunny', name: 'Ensoleill√©', temp: '25¬∞C', desc: 'Ciel d√©gag√©, belle journ√©e' },
    cloudy: { type: 'cloudy', name: 'Nuageux', temp: '18¬∞C', desc: 'Ciel couvert' },
    rainy: { type: 'rainy', name: 'Pluvieux', temp: '15¬∞C', desc: 'Pluie continue' },
    stormy: { type: 'stormy', name: 'Orageux', temp: '14¬∞C', desc: '√âclairs et tonnerre!' },
    snowy: { type: 'snowy', name: 'Neigeux', temp: '-2¬∞C', desc: 'Neige abondante' },
    foggy: { type: 'foggy', name: 'Brumeux', temp: '12¬∞C', desc: 'Visibilit√© r√©duite' }
  };
  
  if(weatherTypes[weatherType]) {
    location.weather = weatherTypes[weatherType];
    renderLocationDetails(location);
    appendMsg("system", `üå§Ô∏è La m√©t√©o √† ${location.name} change: ${location.weather.name}`);
  }
}

// ----- SYST√àME DE TEMPS RP -----
const RP_START_DATE = new Date(2024, 3, 1, 12, 0); // 01 Avril 2024, 12:00
const RUKIA_EVENT_DATE = new Date(2024, 4, 12, 19, 13); // 12 Mai 2024, 19:13

let rpTime = {
  date: new Date(RP_START_DATE),
  tour: 1
};

// Jours de la semaine en fran√ßais
const JOURS = ['Dimanche', 'Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi'];
const MOIS = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];

// Initialiser le temps
function initRPTime() {
  // Charger depuis le RP actuel si disponible
  if(currentRP?.rpTime) {
    rpTime.date = new Date(currentRP.rpTime.date);
    rpTime.tour = currentRP.rpTime.tour || 1;
  } else {
    rpTime.date = new Date(RP_START_DATE);
    rpTime.tour = 1;
  }
  updateTimeDisplay();
}

// Mettre √† jour l'affichage
function updateTimeDisplay() {
  const date = rpTime.date;
  
  const jour = JOURS[date.getDay()];
  const jourNum = String(date.getDate()).padStart(2, '0');
  const mois = MOIS[date.getMonth()];
  const heures = String(date.getHours()).padStart(2, '0');
  const minutes = String(date.getMinutes()).padStart(2, '0');
  
  // Header
  document.getElementById('rpDate').innerHTML = `üìÖ ${jour} ${jourNum} ${mois}`;
  document.getElementById('rpTime').innerHTML = `üïê ${heures}:${minutes}`;
  
  // Classe jour/nuit
  const datetime = document.querySelector('.rp-datetime');
  if(datetime) {
    datetime.classList.remove('day', 'night');
    const hour = date.getHours();
    if(hour >= 6 && hour < 19) {
      datetime.classList.add('day');
    } else {
      datetime.classList.add('night');
    }
  }
  
  // Modal (si ouverte)
  const fullDisplay = document.getElementById('timeDisplayFull');
  if(fullDisplay) {
    fullDisplay.innerHTML = `${jour} ${jourNum} ${mois} - ${heures}:${minutes}`;
  }
  
  const tourDisplay = document.getElementById('timeDisplayTour');
  if(tourDisplay) {
    tourDisplay.innerHTML = `Tour ${rpTime.tour}`;
  }
  
  // Jours jusqu'√† l'√©v√©nement Rukia
  const daysUntil = document.getElementById('daysUntilEvent');
  if(daysUntil) {
    const diff = RUKIA_EVENT_DATE - rpTime.date;
    const daysLeft = Math.ceil(diff / (1000 * 60 * 60 * 24));
    
    if(daysLeft > 0) {
      daysUntil.innerHTML = `‚è≥ ${daysLeft} jour(s) avant la rencontre Rukia/Ichigo`;
    } else if(daysLeft === 0) {
      daysUntil.innerHTML = `üî¥ C'EST AUJOURD'HUI ! La rencontre approche...`;
    } else {
      daysUntil.innerHTML = `‚úÖ La rencontre Rukia/Ichigo a eu lieu il y a ${Math.abs(daysLeft)} jour(s)`;
    }
  }
  
  // Sauvegarder dans le RP
  if(currentRP) {
    currentRP.rpTime = {
      date: rpTime.date.toISOString(),
      tour: rpTime.tour
    };
  }
}

// Ouvrir le contr√¥le du temps
function openTimeControl() {
  updateTimeDisplay();
  
  // Pr√©-remplir les inputs
  const dateInput = document.getElementById('manualDate');
  const timeInput = document.getElementById('manualTime');
  
  if(dateInput) {
    const d = rpTime.date;
    dateInput.value = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  }
  if(timeInput) {
    const d = rpTime.date;
    timeInput.value = `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
  }
  
  document.getElementById('timeModal').style.display = 'flex';
}

// Fermer le contr√¥le du temps
function closeTimeControl() {
  document.getElementById('timeModal').style.display = 'none';
}

// Avancer le temps (heures, minutes)
function advanceTime(hours, minutes) {
  const totalMinutes = hours * 60 + minutes;
  rpTime.date = new Date(rpTime.date.getTime() + totalMinutes * 60 * 1000);
  
  updateTimeDisplay();
  
  // Notification
  let msg = '';
  if(hours > 0 && minutes > 0) {
    msg = `${hours}h${minutes}min`;
  } else if(hours > 0) {
    msg = `${hours} heure(s)`;
  } else {
    msg = `${minutes} minute(s)`;
  }
  
  appendMsg('system', `‚è© Le temps avance de ${msg}. Il est maintenant ${formatTime(rpTime.date)}.`);
  announceTimeOfDay();
}

// Avancer de X jours
function advanceDay(days) {
  rpTime.date = new Date(rpTime.date.getTime() + days * 24 * 60 * 60 * 1000);
  
  updateTimeDisplay();
  appendMsg('system', `‚è© ${days} jour(s) s'√©coule(nt). Nous sommes maintenant le ${formatDate(rpTime.date)}.`);
  announceTimeOfDay();
}

// D√©finir une heure pr√©cise (garde la m√™me date)
function setTimeOfDay(hours, minutes) {
  rpTime.date.setHours(hours, minutes, 0, 0);
  
  updateTimeDisplay();
  
  const periods = {
    6: 'üåÖ L\'aube se l√®ve...',
    12: '‚òÄÔ∏è Le soleil est au z√©nith.',
    18: 'üåÜ Le soir tombe sur la ville.',
    22: 'üåô La nuit enveloppe le monde.'
  };
  
  appendMsg('narrateur', periods[hours] || `Il est maintenant ${formatTime(rpTime.date)}.`);
}

// D√©finir une date/heure manuelle
function setManualDateTime() {
  const dateInput = document.getElementById('manualDate').value;
  const timeInput = document.getElementById('manualTime').value;
  
  if(!dateInput) {
    alert('Veuillez entrer une date.');
    return;
  }
  
  const [year, month, day] = dateInput.split('-').map(Number);
  const [hours, minutes] = timeInput ? timeInput.split(':').map(Number) : [12, 0];
  
  rpTime.date = new Date(year, month - 1, day, hours, minutes);
  
  updateTimeDisplay();
  appendMsg('system', `üìÖ Date modifi√©e: ${formatDate(rpTime.date)} √† ${formatTime(rpTime.date)}.`);
  closeTimeControl();
}

// R√©initialiser au d√©but
function resetRPTime() {
  if(confirm('Revenir au 01 Avril (d√©but du RP) ?')) {
    rpTime.date = new Date(RP_START_DATE);
    rpTime.tour = 1;
    
    updateTimeDisplay();
    appendMsg('system', 'üîÑ Temps r√©initialis√© au 01 Avril, 12:00 (Tour 1).');
    closeTimeControl();
  }
}

// Formater la date
function formatDate(date) {
  const jour = JOURS[date.getDay()];
  const jourNum = String(date.getDate()).padStart(2, '0');
  const mois = MOIS[date.getMonth()];
  return `${jour} ${jourNum} ${mois}`;
}

// Formater l'heure
function formatTime(date) {
  const heures = String(date.getHours()).padStart(2, '0');
  const minutes = String(date.getMinutes()).padStart(2, '0');
  return `${heures}:${minutes}`;
}

// Annoncer le moment de la journ√©e
function announceTimeOfDay() {
  const hour = rpTime.date.getHours();
  let period = '';
  
  if(hour >= 5 && hour < 8) period = 'üåÖ Le soleil se l√®ve √† l\'horizon.';
  else if(hour >= 8 && hour < 12) period = '‚òÄÔ∏è La matin√©e est bien entam√©e.';
  else if(hour >= 12 && hour < 14) period = 'üåû C\'est l\'heure du d√©jeuner.';
  else if(hour >= 14 && hour < 17) period = '‚òÄÔ∏è L\'apr√®s-midi suit son cours.';
  else if(hour >= 17 && hour < 20) period = 'üåÜ Le soir approche.';
  else if(hour >= 20 && hour < 23) period = 'üåô La nuit est tomb√©e.';
  else period = 'üåë C\'est le milieu de la nuit.';
  
  // V√©rifier si c'est le jour de l'√©v√©nement Rukia
  const isEventDay = rpTime.date.getDate() === 12 && rpTime.date.getMonth() === 4;
  if(isEventDay && hour >= 19) {
    period += '\n‚ö†Ô∏è L\'heure de la rencontre fatidique approche...';
  }
}

// Synchroniser le tour avec le temps
function syncTurnWithTime() {
  // √Ä chaque nouveau round dans le syst√®me de tour, on peut avancer le temps
  // Cette fonction est appel√©e optionnellement
}

// Avancer le temps automatiquement √† chaque tour (optionnel)
function advanceTimeOnTurn(minutes = 5) {
  rpTime.date = new Date(rpTime.date.getTime() + minutes * 60 * 1000);
  updateTimeDisplay();
}

// V√©rifier les √©v√©nements sp√©ciaux selon la date
function checkSpecialEvents() {
  const date = rpTime.date;
  const day = date.getDate();
  const month = date.getMonth(); // 0-indexed (Avril = 3, Mai = 4)
  const hour = date.getHours();
  
  // √âv√©nement Rukia/Ichigo : 12 Mai √† 19:13
  if(month === 4 && day === 12 && hour === 19 && date.getMinutes() >= 13) {
    appendMsg('narrateur', '‚ö° CE SOIR, LE DESTIN S\'ACCOMPLIT ! Rukia Kuchiki rencontre Ichigo Kurosaki pour la premi√®re fois...');
  }
  
  // Autres √©v√©nements possibles
  if(month === 3 && day === 1) {
    // D√©but du RP
  }
}

// Obtenir la p√©riode de la journ√©e
function getTimeOfDayPeriod() {
  const hour = rpTime.date.getHours();
  
  if(hour >= 5 && hour < 7) return { name: 'Aube', icon: 'üåÖ', class: 'dawn' };
  if(hour >= 7 && hour < 12) return { name: 'Matin', icon: '‚òÄÔ∏è', class: 'morning' };
  if(hour >= 12 && hour < 14) return { name: 'Midi', icon: 'üåû', class: 'noon' };
  if(hour >= 14 && hour < 17) return { name: 'Apr√®s-midi', icon: 'üå§Ô∏è', class: 'afternoon' };
  if(hour >= 17 && hour < 20) return { name: 'Soir', icon: 'üåÜ', class: 'evening' };
  if(hour >= 20 && hour < 23) return { name: 'Nuit', icon: 'üåô', class: 'night' };
  return { name: 'Nuit profonde', icon: 'üåë', class: 'midnight' };
}

// Obtenir l'emoji m√©t√©o selon l'heure pour la map
function getWeatherForTime(baseWeather) {
  const period = getTimeOfDayPeriod();
  
  // Modifier la m√©t√©o selon l'heure
  if(period.class === 'night' || period.class === 'midnight') {
    return {
      ...baseWeather,
      icon: baseWeather.type === 'sunny' ? 'üåô' : baseWeather.icon,
      desc: baseWeather.desc + ' (Nuit)'
    };
  }
  
  return baseWeather;
}

// ----- D√âTAILS JOUEUR -----
let currentDetailIndex = -1;

function openPlayerDetails(index) {
  currentDetailIndex = index;
  const pj = currentRP.players[index];
  
  // Initialiser les valeurs manquantes
  if(pj.hp === undefined) pj.hp = 100;
  if(pj.maxHp === undefined) pj.maxHp = 100;
  if(pj.reiatsu === undefined) pj.reiatsu = 50;
  if(pj.maxReiatsu === undefined) pj.maxReiatsu = 50;
  if(pj.stamina === undefined) pj.stamina = 50;
  if(pj.maxStamina === undefined) pj.maxStamina = 50;
  if(!pj.status) pj.status = [];
  if(!pj.stats) {
    pj.stats = { Reiatsu: 5, Endurance: 5, Hakuda: 5, Defense: 5, Hoho: 5, Intellect: 5 };
  }
  
  // Calculer les pourcentages
  const hpPercent = (pj.hp / pj.maxHp) * 100;
  const reiatsuPercent = (pj.reiatsu / pj.maxReiatsu) * 100;
  const staminaPercent = (pj.stamina / pj.maxStamina) * 100;
  
  // Descriptions des stats
  const statDescriptions = {
    Reiatsu: { icon: 'üîµ', name: 'Pression Spirituelle', desc: 'Puissance des sorts (Kid≈ç, Cero, Heilig Pfeil)' },
    Endurance: { icon: 'üü°', name: 'Endurance', desc: 'Capacit√© √† utiliser des attaques physiques' },
    Hakuda: { icon: 'üëä', name: 'Hakuda / Zanjutsu', desc: 'D√©g√¢ts physiques (mains nues / √©p√©e)' },
    Defense: { icon: 'üõ°Ô∏è', name: 'D√©fense', desc: 'R√©duction des d√©g√¢ts re√ßus' },
    Hoho: { icon: 'üí®', name: 'Hoh≈ç / Vitesse', desc: 'Esquive, Shunpo, Son√≠do, Hirenkyaku' },
    Intellect: { icon: 'üß†', name: 'Intellect', desc: 'Coups critiques, Strat√©gie, Perception' }
  };
  
  // G√©n√©rer les stats HTML
  const values = Object.values(pj.stats);
  const maxStat = Math.max(...values, 1);
  
  const statsHTML = Object.entries(pj.stats).map(([k, v]) => {
    const info = statDescriptions[k] || { icon: '‚ùì', name: k, desc: '' };
    const percent = (v / maxStat) * 100;
    const color = getStatColor(percent);
    
    return `
      <div class="stat-detail-item" title="${info.desc}">
        <div class="stat-detail-header">
          <span class="stat-detail-icon">${info.icon}</span>
          <span class="stat-detail-name">${info.name}</span>
          <span class="stat-detail-value">${v}</span>
        </div>
        <div class="stat-bar">
          <div class="stat-fill" style="width:${percent}%; background:${color}"></div>
        </div>
        <div class="stat-detail-desc">${info.desc}</div>
      </div>
    `;
  }).join('');
  
  // G√©n√©rer les statuts
  const statusHTML = pj.status.length > 0
    ? pj.status.map(s => `<span class="status-tag ${getStatusClass(s)}">${getStatusIcon(s)} ${s}</span>`).join('')
    : '<span style="color:#666">Aucun statut</span>';
  
  // Inventaire r√©sum√©
  const invCount = pj.inventory?.length || 0;
  const invTotal = pj.inventory?.reduce((sum, item) => sum + (parseItem(item).qty || 1), 0) || 0;
  
  // Calculer les stats de combat d√©riv√©es
  const combatStats = calculateCombatStats(pj);
  
  document.getElementById('playerDetailTitle').innerHTML = `üìã ${pj.name}`;
  
  document.getElementById('playerDetailContent').innerHTML = `
    <!-- Header -->
    <div class="player-detail-header">
      <div class="player-avatar">${getPlayerAvatar(pj)}</div>
      <div class="player-main-info">
        <h3>${pj.name}</h3>
        <p class="player-subtitle">${pj.species || 'Esp√®ce inconnue'} ‚Ä¢ ${pj.age || '?'} ans</p>
        <div class="player-level-xp">
          <span class="badge badge-level">‚≠ê Niveau ${pj.level || 1}</span>
          <span class="badge badge-xp">‚ú® ${pj.xp || 0}/100 XP</span>
        </div>
      </div>
    </div>
    
    <!-- Bonus de race -->
    ${pj.raceBonuses ? `
    <div class="race-bonuses">
      ${pj.raceBonuses.map(b => `<div class="race-bonus">${b}</div>`).join('')}
    </div>
    ` : ''}
    
    <!-- Ressources -->
    <div class="detail-section-player">
      <h4>üí™ Ressources</h4>
      
      <!-- HP -->
      <div class="resource-detail">
        <div class="resource-detail-header">
          <span>‚ù§Ô∏è Points de Vie (HP)</span>
          <span>${pj.hp} / ${pj.maxHp}</span>
        </div>
        <div class="resource-bar-large hp-bar-bg">
          <div class="resource-fill-large hp-fill-color" style="width:${hpPercent}%"></div>
        </div>
        <div class="resource-actions">
          <button onclick="modifyResource('hp', 10)">+10</button>
          <button onclick="modifyResource('hp', 25)">+25</button>
          <button onclick="modifyResource('hp', 999)">Full</button>
          <button onclick="modifyResource('hp', -10)" class="btn-dmg">-10</button>
          <button onclick="modifyResource('hp', -25)" class="btn-dmg">-25</button>
        </div>
      </div>
      
      <!-- Reiatsu -->
      <div class="resource-detail">
        <div class="resource-detail-header">
          <span>üîµ Reiatsu (Mana Spirituel)</span>
          <span>${pj.reiatsu} / ${pj.maxReiatsu}</span>
        </div>
        <div class="resource-bar-large reiatsu-bar-bg">
          <div class="resource-fill-large reiatsu-fill-color" style="width:${reiatsuPercent}%"></div>
        </div>
        <div class="resource-actions">
          <button onclick="modifyResource('reiatsu', 10)">+10</button>
          <button onclick="modifyResource('reiatsu', 25)">+25</button>
          <button onclick="modifyResource('reiatsu', 999)">Full</button>
          <button onclick="modifyResource('reiatsu', -10)" class="btn-dmg">-10</button>
          <button onclick="modifyResource('reiatsu', -25)" class="btn-dmg">-25</button>
        </div>
        <div class="resource-info">Utilis√© pour: Kid≈ç, Cero, Heilig Pfeil, techniques spirituelles</div>
      </div>
      
      <!-- Stamina -->
      <div class="resource-detail">
        <div class="resource-detail-header">
          <span>üü° Stamina (Endurance)</span>
          <span>${pj.stamina} / ${pj.maxStamina}</span>
        </div>
        <div class="resource-bar-large stamina-bar-bg">
          <div class="resource-fill-large stamina-fill-color" style="width:${staminaPercent}%"></div>
        </div>
        <div class="resource-actions">
          <button onclick="modifyResource('stamina', 10)">+10</button>
          <button onclick="modifyResource('stamina', 25)">+25</button>
          <button onclick="modifyResource('stamina', 999)">Full</button>
          <button onclick="modifyResource('stamina', -10)" class="btn-dmg">-10</button>
          <button onclick="modifyResource('stamina', -25)" class="btn-dmg">-25</button>
        </div>
        <div class="resource-info">Utilis√© pour: Attaques physiques, Shunpo, Son√≠do, d√©fense active</div>
      </div>
    </div>
    
    <!-- Stats de combat d√©riv√©es -->
    <div class="detail-section-player">
      <h4>‚öîÔ∏è Stats de Combat</h4>
      <div class="combat-stats-grid">
        <div class="combat-stat">
          <span class="combat-stat-icon">‚öîÔ∏è</span>
          <span class="combat-stat-name">Attaque Physique</span>
          <span class="combat-stat-value">${combatStats.physicalDamage}</span>
        </div>
        <div class="combat-stat">
          <span class="combat-stat-icon">‚ú®</span>
          <span class="combat-stat-name">Attaque Spirituelle</span>
          <span class="combat-stat-value">${combatStats.spiritualDamage}</span>
        </div>
        <div class="combat-stat">
          <span class="combat-stat-icon">üõ°Ô∏è</span>
          <span class="combat-stat-name">R√©duction D√©g√¢ts</span>
          <span class="combat-stat-value">${combatStats.damageReduction}%</span>
        </div>
        <div class="combat-stat">
          <span class="combat-stat-icon">üí®</span>
          <span class="combat-stat-name">Chance d'Esquive</span>
          <span class="combat-stat-value">${combatStats.dodgeChance}%</span>
        </div>
        <div class="combat-stat">
          <span class="combat-stat-icon">üéØ</span>
          <span class="combat-stat-name">Chance Critique</span>
          <span class="combat-stat-value">${combatStats.critChance}%</span>
        </div>
        <div class="combat-stat">
          <span class="combat-stat-icon">üí•</span>
          <span class="combat-stat-name">D√©g√¢ts Critiques</span>
          <span class="combat-stat-value">x${combatStats.critDamage}</span>
        </div>
      </div>
    </div>
    
    <!-- Statistiques de base -->
    <div class="detail-section-player">
      <h4>üìä Attributs</h4>
      <div class="stats-detail-grid">
        ${statsHTML}
      </div>
    </div>
    
    <!-- Statuts -->
    <div class="detail-section-player">
      <h4>üè∑Ô∏è Statuts actifs</h4>
      <div class="status-tags-detail">
        ${statusHTML}
      </div>
      <div class="status-actions">
        <button onclick="addStatus()">‚ûï Ajouter statut</button>
        <button onclick="clearAllStatus()">üóëÔ∏è Effacer tout</button>
      </div>
    </div>
    
    <!-- Localisation -->
    <div class="detail-section-player">
      <h4>üìç Localisation</h4>
      <div class="detail-row">
        <span class="detail-label">Position actuelle</span>
        <span class="detail-value">${pj.location || 'Inconnu'}</span>
      </div>
      <button onclick="openTravel(${index}); closePlayerDetails();" style="margin-top:10px; width:100%;">üö∂ Changer de lieu</button>
    </div>
    
    <!-- Infos g√©n√©rales -->
    <div class="detail-section-player">
      <h4>üìù Informations</h4>
      <div class="detail-row">
        <span class="detail-label">Langues</span>
        <span class="detail-value">${pj.languages || '-'}</span>
      </div>
      <div class="detail-row">
        <span class="detail-label">Comp√©tences</span>
        <span class="detail-value">${pj.skills || '-'}</span>
      </div>
      <div class="detail-row">
        <span class="detail-label">Personnalit√©</span>
        <span class="detail-value">${pj.traits || '-'}</span>
      </div>
      <div class="detail-row">
        <span class="detail-label">Objectif</span>
        <span class="detail-value">${pj.goals || '-'}</span>
      </div>
    </div>
    
    <!-- Background -->
    ${pj.past ? `
    <div class="detail-section-player">
      <h4>üìñ Background</h4>
      <p style="color:#ccc; line-height:1.5; margin:0;">${pj.past}</p>
    </div>
    ` : ''}
    
    <!-- Inventaire -->
    <div class="detail-section-player">
      <h4>üéí Inventaire</h4>
      <div class="detail-row">
        <span class="detail-label">Objets</span>
        <span class="detail-value">${invCount} type(s), ${invTotal} total</span>
      </div>
      <button onclick="openInventory(${index}); closePlayerDetails();" style="margin-top:10px; width:100%;">üéí Ouvrir l'inventaire</button>
    </div>
    
    <!-- Actions -->
    <div class="detail-actions">
      <button class="action-heal" onclick="fullRestore()">üíö Repos complet</button>
      <button class="action-damage" onclick="customDamage()">üíî Infliger d√©g√¢ts</button>
      <button class="action-status" onclick="addStatus()">üè∑Ô∏è Statut</button>
      <button class="action-edit" onclick="editPlayer()">‚úèÔ∏è Modifier</button>
    </div>
  `;
  
  document.getElementById('playerDetailModal').style.display = 'flex';
}

// Calculer les stats de combat d√©riv√©es
function calculateCombatStats(pj) {
  const stats = pj.stats || {};
  
  return {
    // D√©g√¢ts physiques = Hakuda * 2 + Endurance
    physicalDamage: (stats.Hakuda || 0) * 2 + Math.floor((stats.Endurance || 0) / 2),
    
    // D√©g√¢ts spirituels = Reiatsu * 2.5
    spiritualDamage: Math.floor((stats.Reiatsu || 0) * 2.5),
    
    // R√©duction d√©g√¢ts = Defense * 3%
    damageReduction: Math.min(50, (stats.Defense || 0) * 3),
    
    // Chance d'esquive = Hoho * 4%
    dodgeChance: Math.min(60, (stats.Hoho || 0) * 4),
    
    // Chance critique = Intellect * 3%
    critChance: Math.min(40, (stats.Intellect || 0) * 3),
    
    // Multiplicateur critique = 1.5 + (Intellect * 0.05)
    critDamage: (1.5 + (stats.Intellect || 0) * 0.05).toFixed(2)
  };
}

// Modifier une ressource
// Modifier une ressource (suite)
function modifyResource(resource, amount) {
  if(currentDetailIndex < 0) return;
  const pj = currentRP.players[currentDetailIndex];
  
  const maxKey = 'max' + resource.charAt(0).toUpperCase() + resource.slice(1);
  const maxValue = pj[maxKey] || 100;
  const oldValue = pj[resource] || 0;
  
  if(amount === 999) {
    pj[resource] = maxValue;
    appendMsg('system', `‚ú® ${pj.name}: ${resource} restaur√© au maximum (${maxValue})`);
  } else {
    pj[resource] = Math.max(0, Math.min(maxValue, oldValue + amount));
    
    if(amount > 0) {
      appendMsg('system', `üíö ${pj.name} r√©cup√®re ${amount} ${resource} (${oldValue} ‚Üí ${pj[resource]})`);
    } else {
      appendMsg('system', `üíî ${pj.name} perd ${Math.abs(amount)} ${resource} (${oldValue} ‚Üí ${pj[resource]})`);
    }
  }
  
  // G√©rer le KO pour HP
  if(resource === 'hp') {
    if(pj.hp <= 0 && oldValue > 0) {
      if(!pj.status.includes('KO')) {
        pj.status.push('KO');
      }
      appendMsg('narrateur', `üíÄ ${pj.name} est KO !`);
    } else if(pj.hp > 0 && pj.status.includes('KO')) {
      pj.status = pj.status.filter(s => s !== 'KO');
      appendMsg('narrateur', `‚ú® ${pj.name} reprend connaissance !`);
    }
  }
  
  openPlayerDetails(currentDetailIndex);
  showPlayers(currentRP);
}

// Repos complet - restaure tout
function fullRestore() {
  if(currentDetailIndex < 0) return;
  const pj = currentRP.players[currentDetailIndex];
  
  pj.hp = pj.maxHp;
  pj.reiatsu = pj.maxReiatsu;
  pj.stamina = pj.maxStamina;
  pj.status = pj.status.filter(s => !['KO', 'Fatigu√©', '√âpuis√©'].includes(s));
  
  appendMsg('narrateur', `üåô ${pj.name} se repose et r√©cup√®re toutes ses forces !`);
  appendMsg('system', `üíö HP: ${pj.hp}/${pj.maxHp} | üîµ Reiatsu: ${pj.reiatsu}/${pj.maxReiatsu} | üü° Stamina: ${pj.stamina}/${pj.maxStamina}`);
  
  openPlayerDetails(currentDetailIndex);
  showPlayers(currentRP);
}

// D√©g√¢ts personnalis√©s avec choix de type
function customDamage() {
  if(currentDetailIndex < 0) return;
  const pj = currentRP.players[currentDetailIndex];
  
  const damageType = prompt(
    `Quel type de d√©g√¢ts infliger √† ${pj.name}?\n\n` +
    `1. HP (Points de vie)\n` +
    `2. Reiatsu (√ânergie spirituelle)\n` +
    `3. Stamina (Endurance)\n\n` +
    `Entrez le num√©ro:`
  );
  
  if(!damageType) return;
  
  const types = { '1': 'hp', '2': 'reiatsu', '3': 'stamina' };
  const resource = types[damageType];
  
  if(!resource) {
    alert('Type invalide!');
    return;
  }
  
  const amount = prompt(`Combien de d√©g√¢ts ${resource.toUpperCase()}?`);
  if(!amount) return;
  
  const damage = parseInt(amount);
  if(isNaN(damage) || damage < 0) {
    alert('Valeur invalide!');
    return;
  }
  
  modifyResource(resource, -damage);
}

// Modifier le level up pour am√©liorer les nouvelles stats
function addXP(i) {
  const pj = currentRP.players[i];
  pj.xp = (pj.xp || 0) + 10;
  
  if(pj.xp >= 100) {
    pj.level = (pj.level || 1) + 1;
    pj.xp = pj.xp - 100;
    
    // Augmenter une stat al√©atoire de 1-2 points
    const statKeys = Object.keys(pj.stats);
    const randomKey = statKeys[Math.floor(Math.random() * statKeys.length)];
    const bonus = Math.floor(Math.random() * 2) + 1;
    pj.stats[randomKey] = Math.min(20, (pj.stats[randomKey] || 0) + bonus);
    
    // Augmenter les ressources max
    pj.maxHp = (pj.maxHp || 100) + 10 + pj.stats.Defense;
    pj.maxReiatsu = (pj.maxReiatsu || 50) + 5 + Math.floor(pj.stats.Reiatsu / 2);
    pj.maxStamina = (pj.maxStamina || 50) + 5 + Math.floor(pj.stats.Endurance / 2);
    
    // Restaurer les ressources au level up
    pj.hp = pj.maxHp;
    pj.reiatsu = pj.maxReiatsu;
    pj.stamina = pj.maxStamina;
    
    const statDescriptions = {
      Reiatsu: 'üîµ Pression Spirituelle',
      Endurance: 'üü° Endurance',
      Hakuda: 'üëä Hakuda',
      Defense: 'üõ°Ô∏è D√©fense',
      Hoho: 'üí® Hoh≈ç',
      Intellect: 'üß† Intellect'
    };
    
    appendMsg('system', `üéâ ${pj.name} passe niveau ${pj.level} !`);
    appendMsg('system', `üìä +${bonus} ${statDescriptions[randomKey] || randomKey}`);
    appendMsg('system', `üí™ Nouvelles ressources max: HP ${pj.maxHp} | Reiatsu ${pj.maxReiatsu} | Stamina ${pj.maxStamina}`);
    
    alert(`üéâ ${pj.name} passe niveau ${pj.level} !\n\n+${bonus} en ${statDescriptions[randomKey] || randomKey}\n\nRessources restaur√©es!`);
  }
  
  showPlayers(currentRP);
}

// Ajouter le statut avec effets
function addStatus() {
  if(currentDetailIndex < 0) return;
  const pj = currentRP.players[currentDetailIndex];
  
  const statusList = [
    { name: 'Empoisonn√©', effect: '-5 HP/tour', icon: 'ü§¢' },
    { name: 'Br√ªl√©', effect: '-3 HP/tour', icon: 'üî•' },
    { name: 'Saignement', effect: '-2 HP/tour', icon: 'ü©∏' },
    { name: 'Paralys√©', effect: 'Ne peut pas bouger', icon: '‚ö°' },
    { name: 'Gel√©', effect: 'Vitesse r√©duite', icon: '‚ùÑÔ∏è' },
    { name: 'Fatigu√©', effect: '-50% Stamina regen', icon: 'üò¥' },
    { name: '√âpuis√©', effect: 'Stamina bloqu√©e', icon: 'üí§' },
    { name: 'Confus', effect: '30% √©chec actions', icon: 'üòµ‚Äçüí´' },
    { name: 'Aveugl√©', effect: '-50% pr√©cision', icon: 'üôà' },
    { name: 'Drain√©', effect: '-5 Reiatsu/tour', icon: 'üí´' },
    { name: 'Bouclier', effect: '+20% D√©fense', icon: 'üõ°Ô∏è' },
    { name: 'Renforc√©', effect: '+20% Attaque', icon: 'üí™' },
    { name: 'H√¢te', effect: '+30% Vitesse', icon: '‚ö°' },
    { name: 'R√©g√©n√©ration', effect: '+5 HP/tour', icon: 'üíö' },
    { name: 'Concentration', effect: '+20% Critique', icon: 'üéØ' },
    { name: 'Invisible', effect: 'Ind√©tectable', icon: 'üëª' }
  ];
  
  const choice = prompt(
    `Ajouter un statut √† ${pj.name}:\n\n` +
    statusList.map((s, i) => `${i + 1}. ${s.icon} ${s.name} (${s.effect})`).join('\n') +
    `\n\n0. Personnalis√©...\n\nEntrez le num√©ro:`
  );
  
  if(choice === null) return;
  
  let status;
  const num = parseInt(choice);
  
  if(num === 0) {
    status = prompt('Entrez le nom du statut personnalis√©:');
    if(!status) return;
  } else if(num >= 1 && num <= statusList.length) {
    status = statusList[num - 1].name;
  } else {
    alert('Choix invalide!');
    return;
  }
  
  if(!pj.status.includes(status)) {
    pj.status.push(status);
    const statusInfo = statusList.find(s => s.name === status);
    appendMsg('system', `üè∑Ô∏è ${pj.name} obtient: ${getStatusIcon(status)} ${status}${statusInfo ? ` (${statusInfo.effect})` : ''}`);
  } else {
    alert(`${pj.name} a d√©j√† ce statut!`);
    return;
  }
  
  openPlayerDetails(currentDetailIndex);
  showPlayers(currentRP);
}

// Effacer tous les statuts
function clearAllStatus() {
  if(currentDetailIndex < 0) return;
  const pj = currentRP.players[currentDetailIndex];
  
  if(pj.status.length === 0) {
    alert(`${pj.name} n'a aucun statut.`);
    return;
  }
  
  if(confirm(`Effacer tous les statuts de ${pj.name}?\n\nStatuts actuels: ${pj.status.join(', ')}`)) {
    pj.status = [];
    appendMsg('system', `‚ú® Tous les statuts de ${pj.name} ont √©t√© effac√©s.`);
    openPlayerDetails(currentDetailIndex);
    showPlayers(currentRP);
  }
}

// Avatar du joueur selon l'esp√®ce
function getPlayerAvatar(pj) {
  const species = (pj.species || '').toLowerCase();
  if(species.includes('arrancar')) return 'üòà';
  if(species.includes('hollow')) return 'üëπ';
  if(species.includes('vizard')) return 'üé≠';
  if(species.includes('shinigami')) return '‚öîÔ∏è';
  if(species.includes('quincy')) return '‚úùÔ∏è';
  if(species.includes('fullbringer')) return '‚úä';
  if(species.includes('humain')) return 'üë§';
  if(species.includes('√¢me')) return 'üëª';
  if(species.includes('hybrid')) return 'üîÄ';
  return 'üé≠';
}

// √âditer le joueur
function editPlayer() {
  if(currentDetailIndex < 0) return;
  const pj = currentRP.players[currentDetailIndex];
  
  const choice = prompt(
    `Que voulez-vous modifier pour ${pj.name}?\n\n` +
    `1. Nom\n` +
    `2. √Çge\n` +
    `3. Comp√©tences\n` +
    `4. Personnalit√©\n` +
    `5. Objectif\n` +
    `6. HP Maximum\n` +
    `7. Reiatsu Maximum\n` +
    `8. Stamina Maximum\n` +
    `9. Modifier une stat\n` +
    `10. Background\n\n` +
    `Entrez le num√©ro:`
  );
  
  if(!choice) return;
  
  switch(choice) {
    case '1':
      const newName = prompt('Nouveau nom:', pj.name);
      if(newName && newName.trim()) {
        const oldName = pj.name;
        pj.name = newName.trim();
        appendMsg('system', `‚úèÔ∏è ${oldName} renomm√© en ${pj.name}`);
      }
      break;
      
    case '2':
      const newAge = prompt('Nouvel √¢ge:', pj.age);
      if(newAge) {
        pj.age = newAge;
        appendMsg('system', `‚úèÔ∏è √Çge de ${pj.name} modifi√©: ${pj.age}`);
      }
      break;
      
    case '3':
      const newSkills = prompt('Comp√©tences:', pj.skills);
      if(newSkills !== null) {
        pj.skills = newSkills;
        appendMsg('system', `‚úèÔ∏è Comp√©tences de ${pj.name} modifi√©es`);
      }
      break;
      
    case '4':
      const newTraits = prompt('Personnalit√©:', pj.traits);
      if(newTraits !== null) {
        pj.traits = newTraits;
        appendMsg('system', `‚úèÔ∏è Personnalit√© de ${pj.name} modifi√©e`);
      }
      break;
      
    case '5':
      const newGoals = prompt('Objectif:', pj.goals);
      if(newGoals !== null) {
        pj.goals = newGoals;
        appendMsg('system', `‚úèÔ∏è Objectif de ${pj.name} modifi√©`);
      }
      break;
      
    case '6':
      const newMaxHp = prompt('HP Maximum:', pj.maxHp);
      if(newMaxHp && !isNaN(parseInt(newMaxHp))) {
        pj.maxHp = parseInt(newMaxHp);
        pj.hp = Math.min(pj.hp, pj.maxHp);
        appendMsg('system', `‚úèÔ∏è HP Max de ${pj.name}: ${pj.maxHp}`);
      }
      break;
      
    case '7':
      const newMaxReiatsu = prompt('Reiatsu Maximum:', pj.maxReiatsu);
      if(newMaxReiatsu && !isNaN(parseInt(newMaxReiatsu))) {
        pj.maxReiatsu = parseInt(newMaxReiatsu);
        pj.reiatsu = Math.min(pj.reiatsu, pj.maxReiatsu);
        appendMsg('system', `‚úèÔ∏è Reiatsu Max de ${pj.name}: ${pj.maxReiatsu}`);
      }
      break;
      
    case '8':
      const newMaxStamina = prompt('Stamina Maximum:', pj.maxStamina);
      if(newMaxStamina && !isNaN(parseInt(newMaxStamina))) {
        pj.maxStamina = parseInt(newMaxStamina);
        pj.stamina = Math.min(pj.stamina, pj.maxStamina);
        appendMsg('system', `‚úèÔ∏è Stamina Max de ${pj.name}: ${pj.maxStamina}`);
      }
      break;
      
    case '9':
      editStat();
      break;
      
    case '10':
      const newPast = prompt('Background / Pass√©:', pj.past);
      if(newPast !== null) {
        pj.past = newPast;
        appendMsg('system', `‚úèÔ∏è Background de ${pj.name} modifi√©`);
      }
      break;
      
    default:
      alert('Choix invalide!');
      return;
  }
  
  openPlayerDetails(currentDetailIndex);
  showPlayers(currentRP);
}

// √âditer une stat sp√©cifique
function editStat() {
  if(currentDetailIndex < 0) return;
  const pj = currentRP.players[currentDetailIndex];
  
  const statDescriptions = {
    Reiatsu: 'üîµ Pression Spirituelle',
    Endurance: 'üü° Endurance',
    Hakuda: 'üëä Hakuda / Zanjutsu',
    Defense: 'üõ°Ô∏è D√©fense',
    Hoho: 'üí® Hoh≈ç / Vitesse',
    Intellect: 'üß† Intellect'
  };
  
  const statKeys = Object.keys(pj.stats);
  
  const choice = prompt(
    `Quelle stat modifier pour ${pj.name}?\n\n` +
    statKeys.map((k, i) => `${i + 1}. ${statDescriptions[k] || k}: ${pj.stats[k]}`).join('\n') +
    `\n\nEntrez le num√©ro:`
  );
  
  if(!choice) return;
  
  const index = parseInt(choice) - 1;
  if(isNaN(index) || index < 0 || index >= statKeys.length) {
    alert('Choix invalide!');
    return;
  }
  
  const statKey = statKeys[index];
  const newValue = prompt(`Nouvelle valeur pour ${statDescriptions[statKey] || statKey}:`, pj.stats[statKey]);
  
  if(newValue && !isNaN(parseInt(newValue))) {
    const oldValue = pj.stats[statKey];
    pj.stats[statKey] = Math.max(0, Math.min(20, parseInt(newValue))); // Cap entre 0 et 20
    appendMsg('system', `‚úèÔ∏è ${pj.name}: ${statDescriptions[statKey] || statKey} ${oldValue} ‚Üí ${pj.stats[statKey]}`);
  }
}

// Fermer les d√©tails du joueur
function closePlayerDetails() {
  document.getElementById('playerDetailModal').style.display = 'none';
  currentDetailIndex = -1;
}

// Avatar selon l'esp√®ce
function getPlayerAvatar(pj) {
  const species = (pj.species || '').toLowerCase();
  if(species.includes('hollow') || species.includes('arrancar')) return 'üëπ';
  if(species.includes('shinigami')) return '‚öîÔ∏è';
  if(species.includes('quincy')) return '‚úùÔ∏è';
  if(species.includes('fullbringer')) return '‚úä';
  if(species.includes('humain')) return 'üë§';
  if(species.includes('√¢me')) return 'üëª';
  return 'üé≠';
}

// Actions rapides HP
function quickHeal(amount) {
  if(currentDetailIndex < 0) return;
  const pj = currentRP.players[currentDetailIndex];
  
  if(amount === 999) {
    pj.hp = pj.maxHp;
    appendMsg('system', `üíö ${pj.name} est compl√®tement soign√© ! (${pj.hp}/${pj.maxHp} HP)`);
  } else {
    const oldHp = pj.hp;
    pj.hp = Math.min(pj.maxHp, pj.hp + amount);
    appendMsg('system', `üíö ${pj.name} r√©cup√®re ${pj.hp - oldHp} HP ! (${oldHp} ‚Üí ${pj.hp})`);
  }
  
  // Retirer le statut KO si n√©cessaire
  if(pj.hp > 0) {
    pj.status = pj.status.filter(s => s.toLowerCase() !== 'ko');
  }
  
  openPlayerDetails(currentDetailIndex);
  showPlayers(currentRP);
}

function quickDamage(amount) {
  if(currentDetailIndex < 0) return;
  const pj = currentRP.players[currentDetailIndex];
  
  const oldHp = pj.hp;
  pj.hp = Math.max(0, pj.hp - amount);
  
  appendMsg('system', `üíî ${pj.name} subit ${amount} d√©g√¢ts ! (${oldHp} ‚Üí ${pj.hp})`);
  
  // Ajouter KO si n√©cessaire
  if(pj.hp <= 0 && oldHp > 0) {
    if(!pj.status.includes('KO')) {
      pj.status.push('KO');
    }
    appendMsg('narrateur', `üíÄ ${pj.name} est KO !`);
  }
  
  openPlayerDetails(currentDetailIndex);
  showPlayers(currentRP);
}

function customHP() {
  if(currentDetailIndex < 0) return;
  const pj = currentRP.players[currentDetailIndex];
  
  const input = prompt(`HP actuel: ${pj.hp}/${pj.maxHp}\n\nEntrez la nouvelle valeur de HP:`);
  if(input === null) return;
  
  const newHp = parseInt(input);
  if(isNaN(newHp)) {
    alert('Valeur invalide!');
    return;
  }
  
  const oldHp = pj.hp;
  pj.hp = Math.max(0, Math.min(pj.maxHp, newHp));
  
  appendMsg('system', `‚ö° HP de ${pj.name} modifi√©: ${oldHp} ‚Üí ${pj.hp}`);
  
  // G√©rer le statut KO
  if(pj.hp <= 0 && !pj.status.includes('KO')) {
    pj.status.push('KO');
  } else if(pj.hp > 0) {
    pj.status = pj.status.filter(s => s.toLowerCase() !== 'ko');
  }
  
  openPlayerDetails(currentDetailIndex);
  showPlayers(currentRP);
}

function fullHeal() {
  quickHeal(999);
}

function customDamage() {
  if(currentDetailIndex < 0) return;
  const pj = currentRP.players[currentDetailIndex];
  
  const input = prompt(`Combien de d√©g√¢ts infliger √† ${pj.name}?`);
  if(input === null) return;
  
  const damage = parseInt(input);
  if(isNaN(damage) || damage < 0) {
    alert('Valeur invalide!');
    return;
  }
  
  quickDamage(damage);
}

// Gestion des statuts
function addStatus() {
  if(currentDetailIndex < 0) return;
  const pj = currentRP.players[currentDetailIndex];
  
  const statusList = [
    'Empoisonn√©', 'Br√ªl√©', 'Saignement', 'Paralys√©', 'Gel√©',
    'Fatigu√©', 'Confus', 'Aveugl√©', 'Soign√©', 'Bouclier',
    'Renforc√©', 'Buff Reiatsu', 'Invisible', 'Autre...'
  ];
  
  const choice = prompt(
    `Ajouter un statut √† ${pj.name}:\n\n` +
    statusList.map((s, i) => `${i + 1}. ${s}`).join('\n') +
    `\n\nEntrez le num√©ro ou tapez un statut personnalis√©:`
  );
  
  if(!choice) return;
  
  let status;
  const num = parseInt(choice);
  
  if(!isNaN(num) && num >= 1 && num <= statusList.length) {
    if(num === statusList.length) {
      status = prompt('Entrez le nom du statut personnalis√©:');
      if(!status) return;
    } else {
      status = statusList[num - 1];
    }
  } else {
    status = choice;
  }
  
  if(!pj.status.includes(status)) {
    pj.status.push(status);
    appendMsg('system', `üè∑Ô∏è ${pj.name} obtient le statut: ${getStatusIcon(status)} ${status}`);
  } else {
    alert(`${pj.name} a d√©j√† ce statut!`);
  }
  
  openPlayerDetails(currentDetailIndex);
  showPlayers(currentRP);
}

function clearAllStatus() {
  if(currentDetailIndex < 0) return;
  const pj = currentRP.players[currentDetailIndex];
  
  if(pj.status.length === 0) {
    alert(`${pj.name} n'a aucun statut.`);
    return;
  }
  
  if(confirm(`Effacer tous les statuts de ${pj.name}?\n\nStatuts actuels: ${pj.status.join(', ')}`)) {
    pj.status = [];
    appendMsg('system', `‚ú® Tous les statuts de ${pj.name} ont √©t√© effac√©s.`);
    openPlayerDetails(currentDetailIndex);
    showPlayers(currentRP);
  }
}

// √âditer le joueur (ouvre le formulaire de modification)
function editPlayer() {
  if(currentDetailIndex < 0) return;
  const pj = currentRP.players[currentDetailIndex];
  
  // Pour l'instant, √©dition basique via prompts
  const newName = prompt('Nom:', pj.name);
  if(newName === null) return;
  
  const newAge = prompt('√Çge:', pj.age);
  const newSkills = prompt('Comp√©tences:', pj.skills);
  const newTraits = prompt('Personnalit√©:', pj.traits);
  const newGoals = prompt('Objectif:', pj.goals);
  const newMaxHp = prompt('HP Maximum:', pj.maxHp);
  
  // Appliquer les modifications
  if(newName) pj.name = newName;
  if(newAge) pj.age = newAge;
  if(newSkills !== null) pj.skills = newSkills;
  if(newTraits !== null) pj.traits = newTraits;
  if(newGoals !== null) pj.goals = newGoals;
  if(newMaxHp && !isNaN(parseInt(newMaxHp))) {
    pj.maxHp = parseInt(newMaxHp);
    pj.hp = Math.min(pj.hp, pj.maxHp);
  }
  
  appendMsg('system', `‚úèÔ∏è Fiche de ${pj.name} modifi√©e.`);
  openPlayerDetails(currentDetailIndex);
  showPlayers(currentRP);
}
/* ----------- TCHAT AVEC SYST√àME DE TOUR ET IA ----------- */
async function sendChat(type) {
  const msgField = document.getElementById("chatMsg");
  const txt = msgField.value.trim();
  if (!txt) return;
  
  msgField.value = "";
  
  // Envoyer via Socket.io
  socket.emit("sendMessage", {
    type: type,
    text: txt,
    playerIndex: turnSystem.currentTurn
  });
  
  // Si c'est un message joueur et le tour est activ√©, passer au suivant
  if (type === 'joueur' && turnSystem.enabled) {
    socket.emit("nextTurn");
  }
}

// Nouvelle fonction pour afficher un message avec l'auteur
function appendMsgWithAuthor(authorName, text, turn) {
  const win = document.getElementById("chatWindow");
  const div = document.createElement("div");
  div.className = "msg joueur";
  div.innerHTML = `
    <span class="msg-author">üë§ ${authorName}</span>
    <span class="msg-turn">Tour ${turn}</span>
    <div class="msg-content">${text}</div>
  `;
  win.appendChild(div);
  win.scrollTop = win.scrollHeight;
  
  // Sauvegarder dans l'historique
  turnSystem.history.push({
    author: authorName,
    text: text,
    turn: turn,
    timestamp: new Date().toISOString()
  });
}

// Modifier appendMsg pour g√©rer les messages syst√®me
function appendMsg(role, text){
  const win = document.getElementById("chatWindow");
  const div = document.createElement("div");
  
  if(role === 'system') {
    div.className = "msg system";
    div.style.cssText = "background:#2a2a00; border-left:3px solid #ffd700; text-align:center; color:#ffd700; font-size:0.9em;";
  } else {
    div.className = "msg " + role;
  }
  
  div.innerText = text;
  win.appendChild(div);
  win.scrollTop = win.scrollHeight;
}


function clearChat() {
  if (confirm("Vider le salon RP ?")) {
    socket.emit("clearChat");
  }
}

// ----- SAVE TO SERVER -----
async function saveData() {
  try {
    const res = await fetch("/save", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(allData)
    });
    const r = await res.json();
    if (r.ok) {
      alert("‚úÖ Sauvegard√© !");
    } else {
      alert("‚ùå Erreur : " + r.error);
    }
  } catch (e) {
    alert("‚ùå Erreur : " + e.message);
  }
}

loadData();
</script>
</body>
</html>
